<!DOCTYPE html>
<html>
  



  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>Ruby から DirectX を扱う簡単高速ゲームライブラリ DXRuby の紹介</title>
  <meta name="description" content="">

  <script src="../../js/jquery.min.js"></script>
  <script src="../../js/bootstrap.min.js"></script>
  <link href="../../css/bootstrap.min.css" rel="stylesheet" type="text/css">
  <link href="../../css/theme.css" rel="stylesheet" type="text/css">
  <link href="../../css/syntax.css" rel="stylesheet" type="text/css">

  <link rel="canonical" href="../..http://magazine.rubyist.net/articles/0027/0027-DXRuby.html">
  <link rel="alternate" type="application/rss+xml" title="Rubyist Magazine" href="http://magazine.rubyist.net/feed.xml">
  <link rel="shortcut icon" href="../../images/favicon.ico">
</head>

  <body>
    <div class="container-fluid">
        <div class="row full">
            <div class="col-md-2 hidden-xs sidebar">
                <h4>

</h4>

<h4>バックナンバー</h4>
<ul>
    
        <li><a href="../../articles/0057/0057-index.html">0057号(2018-02)</a></li>
    
        <li><a href="../../articles/prerubykaigi2017/preRubyKaigi2017-index.html">RubyKaigi 2017 直前特集号</a></li>
    
        <li><a href="../../articles/0056/0056-index.html">0056号(2017-08)</a></li>
    
        <li><a href="../../articles/0055/0055-index.html">0055号(2017-03)</a></li>
    
        <li><a href="../../articles/0054/0054-index.html">0054号(2016-08)</a></li>
    
        <li><a href="../../articles/pretokyorubykaigi11/preTokyoRubyKaigi11-index.html">東京 Ruby 会議 11 直前特集号</a></li>
    
        <li><a href="../../articles/0053/0053-index.html">0053号(2016-04)</a></li>
    
        <li><a href="../../articles/0052/0052-index.html">0052号(2015-12)</a></li>
    
        <li><a href="../../articles/0051/0051-index.html">0051号(2015-09)</a></li>
    
        <li><a href="../../articles/0050/0050-index.html">0050号(2015-05)</a></li>
    
        <li><a href="../../articles/0049/0049-index.html">0049号(2014-12)</a></li>
    
        <li><a href="../../articles/0048/0048-index.html">0048号(2014-09)</a></li>
    
        <li><a href="../../articles/0047/0047-index.html">0047号(2014-06)</a></li>
    
        <li><a href="../../articles/0046/0046-index.html">0046号(2014-04)</a></li>
    
        <li><a href="../../articles/0045/0045-index.html">0045号(2013-12)</a></li>
    
        <li><a href="../../articles/0044/0044-index.html">0044号(2013-09)</a></li>
    
        <li><a href="../../articles/0043/0043-index.html">0043号(2013-07)</a></li>
    
        <li><a href="../../articles/0042/0042-index.html">0042号(2013-05)</a></li>
    
        <li><a href="../../articles/ruby200specialen/Ruby200SpecialEn-index.html">2.0.0 Special (EN)</a></li>
    
        <li><a href="../../articles/0041/0041-index.html">0041号(2013-02)</a></li>
    
        <li><a href="../../articles/0040/0040-index.html">0040号(2012-11)</a></li>
    
        <li><a href="../../articles/0039/0039-index.html">0039号(2012-09)</a></li>
    
        <li><a href="../../articles/rubykaja/kaja.html">RubyKaja のご紹介</a></li>
    
        <li><a href="../../articles/0038/0038-index.html">0038号(2012-05)</a></li>
    
        <li><a href="../../articles/0037/0037-index.html">0037号(2012-02)</a></li>
    
        <li><a href="../../articles/0036/0036-index.html">0036号(2011-11)</a></li>
    
        <li><a href="../../articles/0035/0035-index.html">0035号(2011-09)</a></li>
    
        <li><a href="../../articles/prerubykaigi2011/preRubyKaigi2011-index.html">RubyKaigi2011直前特集号</a></li>
    
        <li><a href="../../articles/0034/0034-index.html">0034号(2011-06)</a></li>
    
        <li><a href="../../articles/0033/0033-index.html">0033号(2011-04)</a></li>
    
        <li><a href="../../articles/0032/0032-index.html">0032号(2011-01)</a></li>
    
        <li><a href="../../articles/0031/0031-index.html">0031号(2010-10)</a></li>
    
        <li><a href="../../articles/prerubykaigi2010/preRubyKaigi2010-index.html">RubyKaigi2010直前特集号</a></li>
    
        <li><a href="../../articles/0030/0030-index.html">0030号(2010-06)</a></li>
    
        <li><a href="../../articles/0029/0029-index.html">0029号(2010-03)</a></li>
    
        <li><a href="../../articles/0028/0028-index.html">0028号(2009-12)</a></li>
    
        <li><a href="../../articles/0027/0027-index.html">0027号(2009-09)</a></li>
    
        <li><a href="../../articles/0026/0026-index.html">0026号(2009-06)</a></li>
    
        <li><a href="../../articles/0025/0025-index.html">0025号(2009-02)</a></li>
    
        <li><a href="../../articles/0024/0024-index.html">0024号(2008-10)</a></li>
    
        <li><a href="../../articles/0023/0023-index.html">0023号(2008-03)</a></li>
    
        <li><a href="../../articles/0022/0022-index.html">0022号(2007-12)</a></li>
    
        <li><a href="../../articles/0021/0021-index.html">0021号(2007-09)</a></li>
    
        <li><a href="../../articles/0020/0020-index.html">0020号(2007-08)</a></li>
    
        <li><a href="../../articles/0019/0019-index.html">0019号(2007-05)</a></li>
    
        <li><a href="../../articles/0018/0018-index.html">0018号(2007-02)</a></li>
    
        <li><a href="../../articles/0017/0017-index.html">0017号(2006-11)</a></li>
    
        <li><a href="../../articles/0016/0016-index.html">0016号(2006-09)</a></li>
    
        <li><a href="../../articles/0015/0015-index.html">0015号(2006-07)</a></li>
    
        <li><a href="../../articles/rubykaigi2006/RubyKaigi2006-index.html">日本 Ruby カンファレンス 2006 特別号</a></li>
    
        <li><a href="../../articles/0014/0014-index.html">0014号(2006-05)</a></li>
    
        <li><a href="../../articles/0013/0013-index.html">0013号(2006-02)</a></li>
    
        <li><a href="../../articles/0012/0012-index.html">0012号(2005-12)</a></li>
    
        <li><a href="../../articles/0011/0011-index.html">0011号(2005-11)</a></li>
    
        <li><a href="../../articles/0010/0010-index.html">0010号(2005-10)</a></li>
    
        <li><a href="../../articles/0009/0009-index.html">0009号(2005-09)</a></li>
    
        <li><a href="../../articles/0008/0008-index.html">0008号(2005-07)</a></li>
    
        <li><a href="../../articles/0007/0007-index.html">0007号(2005-06)</a></li>
    
        <li><a href="../../articles/0006/0006-index.html">0006号(2005-05)</a></li>
    
        <li><a href="../../articles/0005/0005-index.html">0005号(2005-02)</a></li>
    
        <li><a href="../../articles/0004/0004-index.html">0004号(2004-12)</a></li>
    
        <li><a href="../../articles/0003/0003-index.html">0003号(2004-11)</a></li>
    
        <li><a href="../../articles/0002/0002-index.html">0002号(2004-10)</a></li>
    
        <li><a href="../../articles/0001/0001-index.html">0001号(2004-09)</a></li>
    
</ul>
<p class="rss-subscribe"><a href="/feed.xml">RSS</a></p>

            </div>
            <div class="col-md-10 main">
                <div class="row">
                    <div class="col-md-12">
                        <img src="../../images/rubima_logo_l.png">
                        <h1>Ruby から DirectX を扱う簡単高速ゲームライブラリ DXRuby の紹介</h1>
                        <div class="social-buttons">
                            <a href="http://b.hatena.ne.jp/entry//articles/0027/0027-DXRuby.html" class="hatena-bookmark-button" data-hatena-bookmark-title="Ruby から DirectX を扱う簡単高速ゲームライブラリ DXRuby の紹介" data-hatena-bookmark-layout="simple-balloon" title="このエントリーをはてなブックマークに追加"><img src="https://b.st-hatena.com/images/entry-button/button-only@2x.png" alt="このエントリーをはてなブックマークに追加" width="20" height="20" style="border: none;" /></a><script type="text/javascript" src="https://b.st-hatena.com/js/bookmark_button.js" charset="utf-8" async="async"></script>
<span id="fb-root"></span>
<script>(function(d, s, id) {
  var js, fjs = d.getElementsByTagName(s)[0];
  if (d.getElementById(id)) return;
  js = d.createElement(s); js.id = id;
  js.src = "//connect.facebook.net/ja_JP/sdk.js#xfbml=1&version=v2.5";
  fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));</script>
<span class="fb-like" data-href="/articles/0027/0027-DXRuby.html" data-layout="button_count" data-action="like" data-show-faces="false" data-share="false"></span>
<a href="https://twitter.com/share" class="twitter-share-button" data-url="/articles/0027/0027-DXRuby.html" data-text="Ruby から DirectX を扱う簡単高速ゲームライブラリ DXRuby の紹介">ツイート</a>
<script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');</script>

                        </div>
                        
<p>著者：mirichi 編集：くげ</p>

<ul id="markdown-toc">
  <li><a href="#dxruby-とは" id="markdown-toc-dxruby-とは">DXRuby とは</a></li>
  <li><a href="#dxrubyが生まれた背景と狙い" id="markdown-toc-dxrubyが生まれた背景と狙い">DXRubyが生まれた背景と狙い</a></li>
  <li><a href="#環境の構築" id="markdown-toc-環境の構築">環境の構築</a></li>
  <li><a href="#簡単なサンプル" id="markdown-toc-簡単なサンプル">簡単なサンプル</a></li>
  <li><a href="#dxruby-の構成" id="markdown-toc-dxruby-の構成">DXRuby の構成</a></li>
  <li><a href="#サンプルゲームによる詳細解説" id="markdown-toc-サンプルゲームによる詳細解説">サンプルゲームによる詳細解説</a>    <ul>
      <li><a href="#全体の仕組みと流れ" id="markdown-toc-全体の仕組みと流れ">全体の仕組みと流れ</a></li>
      <li><a href="#初期化処理" id="markdown-toc-初期化処理">初期化処理</a></li>
      <li><a href="#メインループ" id="markdown-toc-メインループ">メインループ</a></li>
      <li><a href="#自機のクラスの説明" id="markdown-toc-自機のクラスの説明">自機のクラスの説明</a>        <ul>
          <li><a href="#初期化処理-1" id="markdown-toc-初期化処理-1">初期化処理</a></li>
          <li><a href="#音の生成" id="markdown-toc-音の生成">音の生成</a></li>
          <li><a href="#メソッド" id="markdown-toc-メソッド">メソッド</a></li>
        </ul>
      </li>
      <li><a href="#まとめ" id="markdown-toc-まとめ">まとめ</a></li>
    </ul>
  </li>
  <li><a href="#おわりに" id="markdown-toc-おわりに">おわりに</a></li>
  <li><a href="#著者について" id="markdown-toc-著者について">著者について</a></li>
</ul>

<h2 id="dxruby-とは">DXRuby とは</h2>
<p>: <img src="../../images/0027-DXRuby/logo.png" alt="logo.png" /></p>

<p><a href="http://dxruby.sourceforge.jp/">DXRuby</a> とは、Ruby で Windows 用の 2D ゲームを作るための拡張ライブラリです。</p>

<p>難しいことを一切排除した簡潔な構成になっていますので、ゲーム開発初心者の方でも悩むことなく簡単に扱うことができます。
また、ライブラリ自体は C 言語で直接 DirectX を制御するように書かれているため、動作は非常に高速です。
DXRuby を使うことによって、 Ruby で簡単・高速な本格的アクションゲームを作ることが可能となります。</p>

<p>本稿では、DXRuby とその具体的な使い方について紹介します。</p>

<dl>
  <dt>DXRuby 公式サイト</dt>
  <dd><a href="http://dxruby.sourceforge.jp/">DXRuby</a></dd>
  <dt>DXRuby ダウンロードページ</dt>
  <dd><a href="http://sourceforge.jp/projects/dxruby/releases/">http://sourceforge.jp/projects/dxruby/releases/</a></dd>
</dl>

<h2 id="dxrubyが生まれた背景と狙い">DXRubyが生まれた背景と狙い</h2>

<p>みなさんご存知かと思いますが、Ruby は EnjoyProgramming を掲げており、気軽なプログラミングを楽しもう、という考え方が大きな特徴です。
そんな Ruby でゲームプログラミングができたら楽しいだろうなあ……と思い、いまから約 4 年前に DXRuby の開発に着手しました。</p>

<p>いまなら <a href="http://www.kmc.gr.jp/~ohai/rubysdl.html">Ruby/SDL</a> を扱う <a href="http://dgames.jp/ja/projects/mygame/">MyGame</a> や <a href="http://www.twin.ne.jp/~cyross/Miyako/">Miyako</a>、それから、直接 SDL を扱う <a href="http://rubygame.org/">Rubygame</a>、<a href="http://www.libgosu.org/">gosu</a>、<a href="http://www.starruby.info/ja/">StarRuby</a> など、ほんとにたくさんのゲーム用ライブラリがありますが、当時は Ruby/SDL が出てきたかな？ぐらいでした。
当時の PC ではスクリプト言語である Ruby はゲーム用途にはイマイチ遅かったですし、「 Ruby から DirectX を扱う」という一点に特化した高速なゲームプログラミングのライブラリが欲しいなという思いから DXRuby の開発を始めました。</p>

<p>ところが、SourceForge.jp に DXRuby と一緒にアップしてあるサンプルシューティングゲームが動くところまで完成した後、諸々の事情で忙しくなったため、そのままほったらかしになってしまいました。最近ヒマになったので、昔作った DXRuby を引っ張り出していじってみたところ、「これはひょっとしたら今でも通用するんじゃないか？っていうか、むしろ PC が速くなった今だからこそ、Ruby ゲームプログラミングが現実的になってるのでは？」と思ったので、2009 年 4 月に思い切ってリリースしてみました。</p>

<p>DXRuby は EnjoyProgramming の Ruby から、気軽に DirectX を扱うことができるように作られた EnjoyGameProgramming のゲームライブラリです。
なるべく簡単に使うことができるよう、クラス/メソッドをシンプルな構成にしていますし、気軽に作ったゲームがそこそこ動くように動作速度には特に気を配っています。
基本的な位置づけはゲーム開発初心者向けのライブラリですので、Ruby と DXRuby で気軽にチャレンジしゲーム作りが楽しいものであると感じてもらえれば幸いです。</p>

<h2 id="環境の構築">環境の構築</h2>

<p>DXRuby を動作させるための環境について説明します。</p>

<p>arton 氏の <a href="http://www.artonx.org/data/asr/">ActiveScriptRuby</a> では、1.8.7-p173 以降のバージョンに DXRuby1.0.4 が同梱されていますので、こちらを利用してる方は DXRuby の個別インストールは不要です。
それ以外の i386-mswin32 版をご利用の方は、SourceForge.jp の DXRuby の<a href="http://sourceforge.jp/projects/dxruby/releases/">ダウンロードページ</a>からダウンロードして、インストールしてください。</p>

<p>また、DXRuby どころか Ruby もインストールしてない方や、Windows でも cygwin 環境でお使いの方は、i386-mswin32 版 Ruby インタプリタと DXRuby をまとめて exe 化した <a href="http://dxruby.sourceforge.jp/files/dxkit1_104_ruby18.zip">DXRuby スターターキット</a>も用意しております。
DXRuby スターターキットは <a href="http://dxruby.sourceforge.jp/">DXRuby プロジェクト Web</a> で配布してますので、サンプルコードを動かしたい方はダウンロードしてお試しください。</p>

<p>あと、重要な点ですが、前提として DirectX 9 以降がインストールされている必要があります。</p>

<p>なお、この記事で紹介しているサンプルコードは、Ruby1.8.7-p174 (i386-mswin32)、Ruby1.9.1-p129 (i386-mswin32) と、それぞれのバージョンに対応した DXRuby 1.0.4 で動作確認を行っています。</p>

<h2 id="簡単なサンプル">簡単なサンプル</h2>

<p>とりあえず、簡単なサンプルプログラムを挙げてみましょう。</p>

<p><a href="../../images/0027-DXRuby/sample1.rb">sample1.rb</a>, <a href="../../images/0027-DXRuby/data.png">data.png</a></p>

<div class="language-ruby highlighter-rouge"><pre class="highlight"><code><span class="nb">require</span> <span class="s1">'dxruby'</span>

<span class="n">x</span> <span class="o">=</span> <span class="mi">0</span>                               <span class="c1"># x座標の変数</span>
<span class="n">y</span> <span class="o">=</span> <span class="mi">0</span>                               <span class="c1"># y座標の変数</span>
<span class="n">image</span> <span class="o">=</span> <span class="no">Image</span><span class="p">.</span><span class="nf">load</span><span class="p">(</span><span class="s1">'data.png'</span><span class="p">)</span>      <span class="c1"># data.pngを読み込む (1)</span>

<span class="no">Window</span><span class="p">.</span><span class="nf">loop</span> <span class="k">do</span>                      <span class="c1"># メインループ (2)</span>
  <span class="n">x</span> <span class="o">=</span> <span class="n">x</span> <span class="o">+</span> <span class="no">Input</span><span class="p">.</span><span class="nf">x</span>                   <span class="c1"># 横方向の入力でx座標を変更 (3)</span>
  <span class="n">y</span> <span class="o">=</span> <span class="n">y</span> <span class="o">+</span> <span class="no">Input</span><span class="p">.</span><span class="nf">y</span>                   <span class="c1"># 縦方向の入力でy座標を変更</span>

  <span class="no">Window</span><span class="p">.</span><span class="nf">draw</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">image</span><span class="p">)</span>          <span class="c1"># data.pngを座標の位置に表示 (4)</span>

  <span class="k">break</span> <span class="k">if</span> <span class="no">Input</span><span class="p">.</span><span class="nf">keyPush?</span><span class="p">(</span><span class="no">K_ESCAPE</span><span class="p">)</span> <span class="c1"># Escキーで終了 (5)</span>
<span class="k">end</span>

</code></pre>
</div>

<p>このプログラムを実行すると、data.png を読み込んで表示し、カーソルキーで動かすことができます。また、Esc キーを押すかウィンドウを閉じることで終了します。</p>

<p>ではこのコードを簡単に説明しましょう。</p>

<dl>
  <dt>(1) 画像の読み込み</dt>
  <dd>(1) では画像を読み込んでいます。DXRuby では、画像をプログラムで生成することもできますが (同梱のサンプルではほぼ全て生成しています)、普通に画像ファイルから読み込むこともできます。画像データは Image クラスのオブジェクトとして表現されます。</dd>
  <dt>(2) メインループ</dt>
  <dd>(2) はゲームのメインループです。Window.loop を実行した時点でウィンドウが表示されて、ループを抜けると消えます。このループ内にゲームのメイン処理を全て書くことになります。</dd>
  <dt>(3) キー入力</dt>
  <dd>(3) ではキー入力の処理を行っています。Input モジュールにはキーやマウス、パッドの入力用メソッドが実装されおり、いろいろな入力を簡単に取得することができます。キーやボタン単体での入力も可能ですが、キャラの移動用に Input.x、Input.y という特別に簡単なメソッドが用意されています。それぞれ x 座標の増分、y 座標の増分で返します。左・上を押した場合は -1、右・下は 1、押していなければ 0 です。</dd>
  <dt>(4) 画像の描画</dt>
  <dd>(4) ではウィンドウへの画像描画を行っています。Window モジュールにはこのような描画系メソッドが色々と実装されていて、回転や拡大縮小、各種合成描画などが簡単にできます。DXRuby は、この描画系メソッドの実行が高速であることがウリの一つです。</dd>
  <dt>(5) ループの終了条件</dt>
  <dd>最後に、(5) がループの終了条件となります。ここでは Esc キーが終了条件となっていますが、Window.loop メソッドはウィンドウを閉じても自動的に終了します。</dd>
</dl>

<p>Ruby は高度な記述もできる本格的な言語ですが、DXRuby では簡単なものであればクラス定義をすることもなくゲームを作ることが可能です。
実際、DXRuby 同梱のサンプルプログラムは全て手続き的な記述になっています。
Ruby の簡単さを重視し、Ruby 初心者でもゲームプログラムにチャレンジしてもらえるように、との思いからこのような作りにしました。
もちろん、作れる人はクラスライブラリを構築して頂いて構いませんし、できれば公開なんかもしてもらえれば、もっと世界が広がるかと思います。</p>

<h2 id="dxruby-の構成">DXRuby の構成</h2>

<p>DXRuby がサポートするのは下記に挙げたようなハードウェア・OS 関連のクラス / モジュールだけで、ゲームのフレームワークやアルゴリズムは提供しません。ゲームを作る場合に最も厄介なのがハードウェア・OS 関連の処理であり、最も楽しいのがゲームのアルゴリズム作成だと考えているからです。</p>

<p>DXRuby のクラス / モジュールについて簡単に紹介します。</p>

<table>
  <thead>
    <tr>
      <th>クラス名</th>
      <th>説明</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>Window モジュール</td>
      <td>メインウィンドウとゲーム全体の制御、描画を行います。</td>
    </tr>
    <tr>
      <td>Input モジュール</td>
      <td>キーボード、マウス、ゲームパッドの入力を行います。</td>
    </tr>
    <tr>
      <td>Image クラス</td>
      <td>画像の読み込みや編集ができる画像データのクラスです。</td>
    </tr>
    <tr>
      <td>Sound クラス</td>
      <td>wav ファイルと midi ファイルの読み込み、再生ができる音のクラスです。</td>
    </tr>
    <tr>
      <td>Font クラス</td>
      <td>文字描画のフォントを表現するクラスです。</td>
    </tr>
    <tr>
      <td>SoundEffect クラス</td>
      <td>ファミコン的な音をプログラムで生成、再生できる音のクラスです。</td>
    </tr>
  </tbody>
</table>

<p>特別ややこしい仕組みを作りこんでるわけではありませんが、描画まわりだけは少しいじってあります。</p>

<p>Window.draw 系メソッドを呼び出すと、各種パラメータが登録されるだけでその場では描画されず、Window.loop のループ時にウェイト・ソート・描画処理がまとめて行われます。
この方法の利点は、ライブラリ側で描画順の高速ソートができることと、フレームスキップの効率化です。
逆に動作速度が多少落ちますが、手軽さなどの方を取りました。手軽にゲームが作れるというのが DXRuby の最大のポイントであり、開発の方針だからです。
また、Image クラスは画像を読み込むだけではなく、画像間のコピーや画像を直接編集するメソッドなどを用意してあります。</p>

<p>あとはだいたい DirectX のラッパのような感じです。
ただ SoundEffect だけは激しく例外で、これについてはこの後に紹介するサンプルゲームで実際に使用しているので、そこで具体的な説明をします。</p>

<h2 id="サンプルゲームによる詳細解説">サンプルゲームによる詳細解説</h2>
<p>: <img src="../../images/0027-DXRuby/screenshot.png" alt="screenshot.png" /></p>

<p>もう少しまともに動作するシューティングゲームのサンプルコードを参考にして、詳細な解説を行います。</p>

<p>きちんとした作品にはなっていませんが、それなりに細かいところまで作りこんでありますので、DXRuby の使い方や、ゲームを作る場合の大まかなアルゴリズムの参考になるかと思います。
ただし、このサンプルゲームがどのように動いているのかを要点に絞って解説するため、細かなアルゴリズムまでは説明しません。</p>

<p>また、このサンプルではタイトル画面や、自機のやられ処理、ゲームオーバー、スコア、敵出現のパターン化、ボスキャラなどは作っておりません。</p>

<p>そのあたりの処理は、以下の記事を参考にしてみてください。</p>

<ul>
  <li><a href="../../articles/0018/0018-GameProgramingForRubySDL.html">Ruby/SDLで始めるゲームプログラミング【前編】</a></li>
  <li><a href="../../articles/0019/0019-GameProgramingForRubySDL.html">Ruby/SDL で始めるゲームプログラミング【後編】</a></li>
  <li><a href="http://sourceforge.jp/projects/dxruby/wiki/FrontPage">DXRuby のプロジェクトWiki</a> (まだそれに関する記事はありませんが)</li>
</ul>

<p><a href="../../images/0027-DXRuby/rubima_sample.zip">サンプルファイル</a> <sup id="fnref:1"><a href="#fn:1" class="footnote">1</a></sup> をダウンロードして展開後、game.exe を実行するとサンプルゲームが起動します。
自機の移動は十字キー、弾を発射は Z キー、ゲームの終了は ESC キーです。</p>

<p>DXRuby スターターキットを使っていますので、mswin32 版 Ruby や、DXRuby がインストールされてなくても、Windows と DirectX 9 があれば動きます。</p>

<h3 id="全体の仕組みと流れ">全体の仕組みと流れ</h3>

<p>このサンプルは、なるべく簡単な記述で作れるように、かなりベタな作りになっています。
具体的にはメインループが一つと、各種キャラのクラスがキャラの種類の数だけ定義されています。
クラスの継承などはしていませんので、そのクラスの定義だけ見れば何をやっているのかは全てわかります。
このあたりはサンプルとして説明をわかりやすくするためにあえてそうしていますので、みなさんが自分で作るときはもっとラクに作れるように、基底クラスを定義して継承するなどしてみてくださいね。</p>

<p>ゲーム全体の仕組みとしては、ObjectGroup 配列に、画面上のキャラを全て突っ込んで、each で回して動かしているだけです。
それぞれのクラスには update と draw のメソッドが定義されていますので、それを呼び出して移動させ描画するという、とてもシンプルな構成です。</p>

<p><a href="../../images/0027-DXRuby/sample2_main.rb">sample2_main.rb</a></p>

<div class="language-ruby highlighter-rouge"><pre class="highlight"><code><span class="no">Window</span><span class="p">.</span><span class="nf">caption</span> <span class="o">=</span> <span class="s2">"るびま用 DXRuby サンプルゲーム"</span> <span class="c1"># ウィンドウのキャプション設定</span>
<span class="no">Window</span><span class="p">.</span><span class="nf">width</span> <span class="o">=</span> <span class="mi">360</span>        <span class="c1"># ウィンドウの横サイズ設定</span>
<span class="no">Window</span><span class="p">.</span><span class="nf">height</span> <span class="o">=</span> <span class="mi">480</span>       <span class="c1"># ウィンドウの縦サイズ設定</span>
<span class="no">Input</span><span class="p">.</span><span class="nf">setRepeat</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>     <span class="c1"># キーのオートリピート設定。5 フレームに 1 回 on</span>

<span class="no">ObjectGroup</span> <span class="o">=</span> <span class="p">[]</span>          <span class="c1"># オブジェクト配列</span>
<span class="no">Collision_MyShot</span> <span class="o">=</span> <span class="p">[]</span>     <span class="c1"># 弾の判定範囲配列</span>
<span class="no">Collision_Enemy</span> <span class="o">=</span> <span class="p">[]</span>      <span class="c1"># 敵の判定範囲配列</span>
<span class="no">Collision_EnemyShot</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># 敵の弾の判定範囲配列</span>

<span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>                 <span class="c1"># 敵出現処理用カウント</span>
<span class="n">font</span> <span class="o">=</span> <span class="no">Font</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="mi">32</span><span class="p">)</span>       <span class="c1"># フォント生成</span>

<span class="vg">$myship</span> <span class="o">=</span> <span class="no">MyShip</span><span class="p">.</span><span class="nf">new</span>      <span class="c1"># 自機生成</span>
<span class="no">ObjectGroup</span><span class="p">.</span><span class="nf">push</span><span class="p">(</span><span class="vg">$myship</span><span class="p">)</span> <span class="c1"># 自機をオブジェクト配列に追加</span>
<span class="no">ObjectGroup</span><span class="p">.</span><span class="nf">push</span><span class="p">(</span><span class="no">Map</span><span class="p">.</span><span class="nf">new</span><span class="p">)</span> <span class="c1"># 背景オブジェクト生成＆オブジェクト配列に追加</span>

<span class="c1"># メインループ</span>
<span class="no">Window</span><span class="p">.</span><span class="nf">loop</span> <span class="k">do</span>

  <span class="c1"># 敵出現処理</span>
  <span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>
  <span class="k">if</span> <span class="n">count</span> <span class="o">%</span> <span class="mi">20</span> <span class="o">==</span> <span class="mi">0</span>      <span class="c1">#  20 カウントに 1 回</span>
    <span class="k">if</span> <span class="n">count</span> <span class="o">%</span> <span class="mi">400</span> <span class="o">==</span> <span class="mi">0</span>   <span class="c1"># 400 カウントに 1 回</span>
      <span class="c1"># 敵 2 のオブジェクト生成＆オブジェクト配列に追加</span>
      <span class="no">ObjectGroup</span><span class="p">.</span><span class="nf">push</span><span class="p">(</span><span class="no">Enemy2</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="nb">rand</span><span class="p">(</span><span class="mi">240</span><span class="p">),</span> <span class="o">-</span><span class="mi">64</span><span class="p">))</span>
      <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">else</span>
      <span class="c1"># 敵 1 のオブジェクト生成＆オブジェクト配列に追加</span>
      <span class="no">ObjectGroup</span><span class="p">.</span><span class="nf">push</span><span class="p">(</span><span class="no">Enemy1</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="nb">rand</span><span class="p">(</span><span class="mi">320</span><span class="p">),</span> <span class="o">-</span><span class="mi">48</span><span class="p">))</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="c1"># オブジェクト情報更新</span>
  <span class="no">ObjectGroup</span><span class="p">.</span><span class="nf">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">obj</span><span class="o">|</span>
    <span class="n">obj</span><span class="p">.</span><span class="nf">update</span>
  <span class="k">end</span>

  <span class="c1"># 衝突判定</span>
  <span class="no">Collision</span><span class="p">.</span><span class="nf">check</span><span class="p">(</span><span class="no">Collision_MyShot</span><span class="p">,</span> <span class="no">Collision_Enemy</span><span class="p">)</span>      <span class="c1"># 自機ショットと敵</span>
  <span class="no">Collision</span><span class="p">.</span><span class="nf">check</span><span class="p">(</span><span class="no">Collision_EnemyShot</span><span class="p">,</span> <span class="vg">$myship</span><span class="p">.</span><span class="nf">collision</span><span class="p">)</span> <span class="c1"># 敵ショットと自機</span>

  <span class="c1"># 衝突判定配列初期化</span>
  <span class="no">Collision_MyShot</span><span class="p">.</span><span class="nf">clear</span>
  <span class="no">Collision_Enemy</span><span class="p">.</span><span class="nf">clear</span>
  <span class="no">Collision_EnemyShot</span><span class="p">.</span><span class="nf">clear</span>

  <span class="c1"># 移動や衝突判定で消えたキャラを配列から削除</span>
  <span class="no">ObjectGroup</span><span class="p">.</span><span class="nf">delete_if</span> <span class="k">do</span> <span class="o">|</span><span class="n">obj</span><span class="o">|</span>
    <span class="n">obj</span><span class="p">.</span><span class="nf">delete</span>
  <span class="k">end</span>

  <span class="c1"># オブジェクトを描画</span>
  <span class="no">ObjectGroup</span><span class="p">.</span><span class="nf">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">obj</span><span class="o">|</span>
    <span class="n">obj</span><span class="p">.</span><span class="nf">draw</span>
  <span class="k">end</span>

  <span class="c1"># Esc キーで終了</span>
  <span class="k">break</span> <span class="k">if</span> <span class="no">Input</span><span class="p">.</span><span class="nf">keyPush?</span><span class="p">(</span><span class="no">K_ESCAPE</span><span class="p">)</span>

  <span class="c1"># 各種情報出力</span>
  <span class="no">Window</span><span class="p">.</span><span class="nf">drawFont</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="no">Window</span><span class="p">.</span><span class="nf">getLoad</span><span class="p">.</span><span class="nf">to_i</span><span class="p">.</span><span class="nf">to_s</span> <span class="o">+</span> <span class="s2">" %"</span><span class="p">,</span> <span class="n">font</span><span class="p">,</span> <span class="ss">:z</span> <span class="o">=&gt;</span> <span class="mi">100</span><span class="p">)</span>
  <span class="no">Window</span><span class="p">.</span><span class="nf">drawFont</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="no">ObjectGroup</span><span class="p">.</span><span class="nf">size</span><span class="p">.</span><span class="nf">to_s</span> <span class="o">+</span> <span class="s2">" objects"</span><span class="p">,</span> <span class="n">font</span><span class="p">,</span> <span class="ss">:z</span> <span class="o">=&gt;</span> <span class="mi">100</span><span class="p">)</span>
<span class="k">end</span>
</code></pre>
</div>

<h3 id="初期化処理">初期化処理</h3>

<p>メインループに入るまでの部分で初期化処理をしています。
一番上のところで「ウィンドウのタイトル設定」「ウィンドウのサイズ設定」「ショット用のキーオートリピート設定」を行っています。</p>

<p>次の配列は、ObjectGroup には全キャラが入り、ここに入っているオブジェクトについて update と draw が呼ばれることになります。
その他の 3 つは衝突判定用で、自機の弾と、敵と、敵の弾の衝突判定オブジェクトを、update メソッドの中でここに追加していきます。あとでこの配列を使って衝突判定を行います。
font は DXRuby で文字を描画するときに使うフォントオブジェクトとなっています。Font クラスは new の第 2 引数でフォント名を指定することができ、省略すると MS ゴシックとなります。</p>

<p>メインループ直前では、ObjectGroup 配列に自機と背景のオブジェクトを追加しています。
自機がグローバル変数なのは、敵の狙い弾などで自機の座標を手軽に取得するためで、グローバル変数にしないとダメということではありません。</p>

<h3 id="メインループ">メインループ</h3>

<p>メインループでは、敵出現 (適当な間隔で敵オブジェクトを new して ObjectGroup 配列に push する) 、オブジェクトの情報更新 (each して update) 、衝突判定、配列から削除、描画 (each して draw) と、終了条件による break、負荷などの表示を行っています。</p>

<p>あまりにもシンプルで説明するところがありませんが、強いて言うなら衝突判定のあたりでしょうか。
このサンプルゲームでは、衝突判定オブジェクトの配列を 2 つ渡すとそのオブジェクト同士の判定を行い、当たったオブジェクトのメソッドを呼ぶような処理が Collision モジュールとして作ってあります。
メソッドを呼ばれたオブジェクトは、例えば敵なら HP を減らし、0 になった時点でやられパターンオブジェクトを生成、自分に delete フラグを立てます。
判定のあとの delete_if で、判定中や移動中に消えたキャラを ObjectGroup から削除して、残ったキャラを描画する、という流れです。<sup id="fnref:2"><a href="#fn:2" class="footnote">2</a></sup></p>

<p>ちなみにこの Collision モジュールと、まだ出てきていませんが判定配列に入れる CollisionBox クラスは今回は Ruby で実装していますが、これをCで実装した DXRubyExtension という追加ライブラリもプロジェクト Web で公開しています。</p>

<p>DXRubyExtension は矩形だけでなく、三角、丸、点の衝突判定もサポートしており、C で書かれているため Ruby で判定するよりかなり高速となっています。
オブジェクト数の多いゲームでは衝突判定はどうしても高負荷になってしまいますが、DXRubyExtension を使うことで負荷を大きく引き下げることができるでしょう。</p>

<h3 id="自機のクラスの説明">自機のクラスの説明</h3>

<p>メインのロジック以外は全て似たような感じのクラス定義となっています。
例えば自機用の MyShip クラスはこんな感じ。</p>

<p><a href="../../images/0027-DXRuby/sample2_my_ship.rb">sample2_my_ship.rb</a></p>

<div class="language-ruby highlighter-rouge"><pre class="highlight"><code><span class="k">class</span> <span class="nc">MyShip</span>
  <span class="kp">attr_accessor</span> <span class="ss">:x</span><span class="p">,</span> <span class="ss">:y</span><span class="p">,</span> <span class="ss">:collision</span><span class="p">,</span> <span class="ss">:delta_x</span><span class="p">,</span> <span class="ss">:delete</span>

  <span class="c1"># 画像読み込みと影画像生成</span>
  <span class="vc">@@image0</span> <span class="o">=</span> <span class="no">Image</span><span class="p">.</span><span class="nf">loadToArray</span><span class="p">(</span><span class="s2">"image/myship.png"</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
  <span class="vc">@@image1</span> <span class="o">=</span> <span class="no">Array</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span> <span class="p">{</span><span class="no">Image</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="mi">32</span><span class="p">,</span> <span class="mi">32</span><span class="p">)}</span>
  <span class="n">black</span> <span class="o">=</span> <span class="p">[</span><span class="mi">128</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
  <span class="k">for</span> <span class="n">i</span> <span class="k">in</span> <span class="mi">0</span><span class="p">.</span><span class="nf">.</span><span class="mi">3</span>
    <span class="k">for</span> <span class="n">y</span> <span class="k">in</span> <span class="mi">0</span><span class="p">.</span><span class="nf">.</span><span class="mi">31</span>
      <span class="k">for</span> <span class="n">x</span> <span class="k">in</span> <span class="mi">0</span><span class="p">.</span><span class="nf">.</span><span class="mi">31</span>
        <span class="c1"># 元画像で透明じゃない部分を黒にする</span>
        <span class="vc">@@image1</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">]</span> <span class="o">=</span> <span class="n">black</span> <span class="k">if</span> <span class="vc">@@image0</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span>
      <span class="k">end</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="c1"># ショット音生成</span>
  <span class="n">f</span> <span class="o">=</span> <span class="mi">4000</span>
  <span class="vc">@@sound</span> <span class="o">=</span> <span class="no">SoundEffect</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span> <span class="no">WAVE_TRI</span><span class="p">)</span> <span class="k">do</span>   <span class="c1"># 20ms の三角波を生成する</span>
    <span class="n">f</span> <span class="o">=</span> <span class="n">f</span> <span class="o">-</span> <span class="mi">120</span>      <span class="c1"># 周波数は 4000Hz から 1ms ごとに 120Hz 下げる</span>
    <span class="p">[</span><span class="n">f</span><span class="p">,</span> <span class="mi">15</span><span class="p">]</span>          <span class="c1"># [ 周波数, 音量 ] の配列を返す</span>
  <span class="k">end</span>

  <span class="c1"># 初期化処理</span>
  <span class="k">def</span> <span class="nf">initialize</span>
    <span class="vi">@x</span> <span class="o">=</span> <span class="mi">140</span>          <span class="c1"># x 座標</span>
    <span class="vi">@y</span> <span class="o">=</span> <span class="mi">400</span>          <span class="c1"># y 座標</span>
    <span class="vi">@oldx</span> <span class="o">=</span> <span class="mi">140</span>       <span class="c1"># 前フレームのx座標</span>
    <span class="vi">@delete</span> <span class="o">=</span> <span class="kp">false</span>   <span class="c1"># 自機が消えたときは true</span>
    <span class="vi">@animecount</span> <span class="o">=</span> <span class="mi">0</span>   <span class="c1"># アニメーション用カウント</span>
    <span class="vi">@collision</span> <span class="o">=</span> <span class="no">CollisionBox</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="kp">nil</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">27</span><span class="p">,</span> <span class="mi">27</span><span class="p">)</span>  <span class="c1"># 衝突判定オブジェクト</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">update</span>
    <span class="c1"># 移動</span>
    <span class="n">dx</span> <span class="o">=</span> <span class="no">Input</span><span class="p">.</span><span class="nf">x</span> <span class="o">*</span> <span class="mi">2</span><span class="o">.</span><span class="mi">4</span>
    <span class="n">dy</span> <span class="o">=</span> <span class="no">Input</span><span class="p">.</span><span class="nf">y</span> <span class="o">*</span> <span class="mi">3</span>
    <span class="k">if</span> <span class="no">Input</span><span class="p">.</span><span class="nf">x</span> <span class="o">!=</span> <span class="mi">0</span> <span class="n">and</span> <span class="no">Input</span><span class="p">.</span><span class="nf">y</span> <span class="o">!=</span> <span class="mi">0</span>   <span class="c1"># ナナメの時は 0.7 倍</span>
      <span class="n">dx</span> <span class="o">*=</span> <span class="mi">0</span><span class="o">.</span><span class="mi">7</span>
      <span class="n">dy</span> <span class="o">*=</span> <span class="mi">0</span><span class="o">.</span><span class="mi">7</span>
    <span class="k">end</span>
    <span class="vi">@x</span> <span class="o">+=</span> <span class="n">dx</span>
    <span class="vi">@y</span> <span class="o">+=</span> <span class="n">dy</span>

    <span class="c1"># 画面端の判定</span>
    <span class="vi">@x</span> <span class="o">=</span> <span class="mi">0</span> <span class="k">if</span> <span class="vi">@x</span> <span class="o">&lt;</span> <span class="mi">0</span>
    <span class="vi">@x</span> <span class="o">=</span> <span class="mi">360</span> <span class="o">-</span> <span class="mi">32</span> <span class="k">if</span> <span class="vi">@x</span> <span class="o">&gt;</span> <span class="mi">360</span> <span class="o">-</span> <span class="mi">32</span>
    <span class="vi">@y</span> <span class="o">=</span> <span class="mi">0</span> <span class="k">if</span> <span class="vi">@y</span> <span class="o">&lt;</span> <span class="mi">0</span>
    <span class="vi">@y</span> <span class="o">=</span> <span class="mi">480</span> <span class="o">-</span> <span class="mi">32</span> <span class="k">if</span> <span class="vi">@y</span> <span class="o">&gt;</span> <span class="mi">480</span> <span class="o">-</span> <span class="mi">32</span>

    <span class="c1"># 衝突判定範囲の移動</span>
    <span class="vi">@collision</span><span class="p">.</span><span class="nf">set</span><span class="p">(</span><span class="vi">@x</span><span class="p">,</span> <span class="vi">@y</span><span class="p">)</span>

    <span class="c1"># ショット</span>
    <span class="k">if</span> <span class="no">Input</span><span class="p">.</span><span class="nf">padPush?</span><span class="p">(</span><span class="no">P_BUTTON0</span><span class="p">)</span>
      <span class="no">ObjectGroup</span><span class="p">.</span><span class="nf">push</span><span class="p">(</span><span class="no">MyShot</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="vi">@x</span> <span class="o">-</span> <span class="mi">18</span><span class="p">,</span> <span class="vi">@y</span> <span class="o">-</span> <span class="mi">32</span><span class="p">,</span> <span class="mi">270</span><span class="p">))</span>
      <span class="no">ObjectGroup</span><span class="p">.</span><span class="nf">push</span><span class="p">(</span><span class="no">MyShot</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="vi">@x</span> <span class="o">+</span> <span class="mi">18</span><span class="p">,</span> <span class="vi">@y</span> <span class="o">-</span> <span class="mi">32</span><span class="p">,</span> <span class="mi">270</span><span class="p">))</span>
      <span class="no">ObjectGroup</span><span class="p">.</span><span class="nf">push</span><span class="p">(</span><span class="no">MyShot</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="vi">@x</span> <span class="o">+</span> <span class="mi">32</span><span class="p">,</span> <span class="vi">@y</span> <span class="o">-</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">300</span><span class="p">))</span>
      <span class="no">ObjectGroup</span><span class="p">.</span><span class="nf">push</span><span class="p">(</span><span class="no">MyShot</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="vi">@x</span> <span class="o">-</span> <span class="mi">32</span><span class="p">,</span> <span class="vi">@y</span> <span class="o">-</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">240</span><span class="p">))</span>
      <span class="vc">@@sound</span><span class="p">.</span><span class="nf">play</span>
    <span class="k">end</span>

    <span class="c1"># 背景や敵などの横補正値計算</span>
    <span class="vi">@delta_x</span> <span class="o">=</span> <span class="o">-</span><span class="p">((</span><span class="vi">@x</span> <span class="o">-</span> <span class="vi">@oldx</span><span class="p">)</span> <span class="o">/</span> <span class="mi">5</span><span class="p">)</span>
    <span class="vi">@oldx</span> <span class="o">=</span> <span class="vi">@x</span>

    <span class="c1"># アニメーション用カウント</span>
    <span class="vi">@animecount</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="vi">@animecount</span> <span class="o">-=</span> <span class="mi">80</span> <span class="k">if</span> <span class="vi">@animecount</span> <span class="o">&gt;=</span> <span class="mi">80</span>
  <span class="k">end</span>

  <span class="c1"># 描画</span>
  <span class="k">def</span> <span class="nf">draw</span>
    <span class="no">Window</span><span class="p">.</span><span class="nf">draw</span><span class="p">(</span><span class="vi">@x</span><span class="p">,</span> <span class="vi">@y</span><span class="p">,</span> <span class="vc">@@image0</span><span class="p">[</span><span class="vi">@animecount</span> <span class="o">/</span> <span class="mi">20</span><span class="p">],</span> <span class="mi">15</span><span class="p">)</span>           <span class="c1"># 自機</span>
    <span class="no">Window</span><span class="p">.</span><span class="nf">draw</span><span class="p">(</span><span class="vi">@x</span> <span class="o">-</span> <span class="mi">16</span><span class="p">,</span> <span class="vi">@y</span> <span class="o">-</span> <span class="mi">16</span><span class="p">,</span> <span class="vc">@@image1</span><span class="p">[</span><span class="vi">@animecount</span> <span class="o">/</span> <span class="mi">20</span><span class="p">],</span> <span class="mi">1</span><span class="p">)</span>  <span class="c1"># 影</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
</div>

<h4 id="初期化処理-1">初期化処理</h4>

<p>メソッド定義の前に、クラス変数を設定する処理が書いてあります。ここで行っているのは「自機の絵の読み込み」「同じ形の影画像生成」「ショット音生成」です。</p>

<p>画像の読み込みは、自機の絵を読み込んで横に 4 分割後、配列に入れるメソッドを呼んでいます。
そして、その画像を元に、自機と同じ形の影画像を生成します。
DXRuby の Image クラスには画像を 1 ピクセル単位で扱う機能がありますので、それを使って全ピクセルの判定を地道に行うというベタな手です。</p>

<h4 id="音の生成">音の生成</h4>

<p>音の生成は SoundEffect クラスでしていまして、これは DXRuby の中でも、というか、Ruby 用のライブラリの中でも極めて異質な機能であると思っています。
簡単に説明すると、音の長さを指定してバッファを生成し、1ms 単位 (変更可能) に「周波数とボリュームを返すブロック」を呼び出すことで、音のバッファを編集します。</p>

<p>このコードでは、20ms の短いショット音を作っています。
周波数ははじめ 4kHz で、1ms ごとに 120Hz 下げています。音量は 15、かなり小さい音にしています。</p>

<p>ショット音で生成される波形は三角波 (ファミコンのベースの音と同じ波形) です。
SoundEffect クラスでは三角波のほかに、矩形波、正弦波、ノコギリ波がサポートされており、ファミコンの音や、もう少し凝った FM 音源に近い音を、プログラムで作り出すことができます。</p>

<p>このサンプルでは使っていませんが、Sound クラスで wav やmidi ファイルを扱えます。また、プロジェクト Web で公開している bass.rb を使えば ogg や mp3 も扱うことができるようになります。</p>

<h4 id="メソッド">メソッド</h4>

<p>MyShip クラスのメソッドは initialize、update、draw の 3 つです。基本的にこのサンプルでは全てのクラスがこの3つのメソッドで成り立っています。</p>

<p>自機は無敵になっていますので、衝突判定モジュールから呼ばれるメソッドはありません。衝突判定の結果が必要なクラスには、hit、shot の名称でメソッドを定義しています。</p>

<p>initialize は Ruby のインスタンス生成時に呼ばれるメソッドですので、ここでインスタンス変数を初期化しています。
@collision に CollisionBox オブジェクトを入れていて、これが衝突判定範囲のオブジェクトとなります。</p>

<p>第 1 引数は nil となっていますが、ここに self を入れると衝突時に hit か shot のメソッドが呼ばれます。自機は呼ばれる必要がないからnilです。
第 2 引数からは、キャラの座標を原点とした左上の点と右下の点の相対位置を指定します。キャラは 32*32 なので、絵のサイズより少し小さい正方形となっているのがわかるでしょう。</p>

<p>update メソッドはメインルーチンから1フレームに1回呼ばれる、移動用のメソッドでしたね。
移動処理は DXRuby の Input モジュールを使い、x と y の増分を取得し、ナナメの場合は 0.7 倍 <sup id="fnref:3"><a href="#fn:3" class="footnote">3</a></sup> して補正し、@x と @y に足します。その後、画面端との判定処理をしています。
横のほうが移動量の倍率が低くなっているのは、背景を自分の移動に合わせて逆方向にずらしているため、そのぶんだけ移動量を減らす目的です。</p>

<p>CollisionBox オブジェクトの set メソッドは、相対範囲で設定されている衝突判定範囲に足すキャラの原点を設定します。こうした状態で Collision モジュールの check メソッドに渡せば判定してくれる、という仕組みです。
ショットを撃つ判定には Input モジュールの padPush? メソッドを使いますが、パッドのボタン 0 は初期状態ではキーボードの Z キーと関連付けられていますので、パッドが無くても遊べます。</p>

<p>padPush? メソッドは本来は単発の入力を判定するメソッドですが、キーのオートリピートの影響を受けるので、Input.setRepeat メソッドで設定すれば押しっぱなしを連打と判定することができます。</p>

<p>ショットの生成は ObjectGroup 配列に MyShot オブジェクトを追加するだけです。</p>

<p>あとは、背景の横移動に合わせて敵や弾を横に移動させるための変数設定と、アニメーションの処理となっています。</p>

<p>最後は draw メソッドとなっていますが、Window モジュールの draw メソッドを呼び出して画面に自機と影を描画しているだけです。</p>

<p>このようなシューティングの場合、敵の弾を一番手前に描画したいわけですが、DXRuby では描画順をソートする機能 (最後の引数が描画順) があるので、全てを ObjectGroup に入れてしまってまとめて描画させてもうまく描画できます。</p>

<p>処理順を気にする場合は自分で調整する必要があります。</p>

<h3 id="まとめ">まとめ</h3>

<p>このサンプルはごらんのように、仕組みそのものはとてもシンプルになっています。
細かいところを作りこんでみたため、色々な処理が入っていますが、それぞれのクラスは update と draw と shot/hit しかないので、読んでみれば意外に簡単に理解できると思います。
また、これらのコードを見ると、DXRuby のメソッドを呼び出している部分は少ないことに気付くと思います。</p>

<p>ゲームプログラミングはあくまでもそのゲームのアルゴリズム作成がメインであり、ハードウェアにアクセスする部分は枝葉でしかありません。
DXRuby はその枝葉をなるべく少なくすることで、ゲームを作る人がアルゴリズムを作ることに集中できるようにしました。
C で書くとメモリやオブジェクトの管理が大変なところも、Ruby では GC がありますし、オブジェクトは配列に入れてしまえば様々な問題が解決します。</p>

<p>Ruby と DXRuby の組み合わせだと、そういった煩雑で本質と関係ない枝葉の部分をバッサリと切り捨てて、ゲームプログラミングの最も楽しい部分だけを味わうことがができます。</p>

<h2 id="おわりに">おわりに</h2>

<p>本稿では、るびま向けに作成したサンプルとともに、DXRuby の紹介をさせていただきました。</p>

<p>開発が 4 年前なのでちょっと古くなってしまっていますが、当時より PC は速くなっていますし、Ruby もより良くなりました。
Rubyと DXRuby なら、ゲームプログラミング初心者でもゲーム作りにチャレンジできますし、ゲームを作り慣れた人ならほんとに手軽にそこそこのゲームが作れると思います。
当然、ほんとに凄いゲームは C などが最適になりますが、年々速くなる PC、Ruby1.9 での高速化などもあり、すぐに普通のゲームであれば Ruby で十分足りるようになるでしょう。
そのとき、ゲーム開発分野でも Ruby の生産性が大きな武器になるはずです。</p>

<p>たくさんライブラリが出ているにも関わらず、相変わらず Ruby のゲーム分野は盛り上がっていませんが、そこに一石と投じることができればいいな、と思っています。</p>

<h2 id="著者について">著者について</h2>

<dl>
  <dt>mirichi</dt>
  <dd><a href="http://www.i-think-sys.com/index.html">(有) アイシンク</a>所属。</dd>
  <dd>趣味はと聞かれるとゲームプログラミングと答えるが、実際にゲームを作ったことはほとんどない。</dd>
</dl>

<hr />

<div class="footnotes">
  <ol>
    <li id="fn:1">
      <p>次章の説明で表示しているソースコードは、このサンプルファイルの main.rb の一部を切り出したものです。&nbsp;<a href="#fnref:1" class="reversefootnote">&#8617;</a></p>
    </li>
    <li id="fn:2">
      <p>詳しい動きを知りたい方は、サンプルファイル (rubima_sample.zip) 内、main.rb の Collision モジュールを参照。&nbsp;<a href="#fnref:2" class="reversefootnote">&#8617;</a></p>
    </li>
    <li id="fn:3">
      <p>(ルート 2)/2 の近似値として 0.7 を使用しています。&nbsp;<a href="#fnref:3" class="reversefootnote">&#8617;</a></p>
    </li>
  </ol>
</div>

                    </div>
                </div>
            </div>
        </div>
    </div>
  </body>
</html>
