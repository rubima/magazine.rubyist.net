<!DOCTYPE html>
<html>
  



  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>Erubis の Preprocessing 機能を使って Ruby on Rails の View 層を高速化する</title>
  <meta name="description" content="">

  <script src="../../js/jquery.min.js"></script>
  <script src="../../js/bootstrap.min.js"></script>
  <link href="../../css/bootstrap.min.css" rel="stylesheet" type="text/css">
  <link href="../../css/theme.css" rel="stylesheet" type="text/css">
  <link href="../../css/syntax.css" rel="stylesheet" type="text/css">

  <link rel="canonical" href="../..http://magazine.rubyist.net/articles/0021/0021-Erubis.html">
  <link rel="alternate" type="application/rss+xml" title="Rubyist Magazine" href="http://magazine.rubyist.net/feed.xml">
  <link rel="shortcut icon" href="../../images/favicon.ico">
</head>

  <body>
    <div class="container-fluid">
        <div class="row full">
            <div class="col-md-2 hidden-xs sidebar">
                <h4>

</h4>

<h4>バックナンバー</h4>
<ul>
    
        <li><a href="../../articles/0057/0057-index.html">0057号(2018-02)</a></li>
    
        <li><a href="../../articles/prerubykaigi2017/preRubyKaigi2017-index.html">RubyKaigi 2017 直前特集号</a></li>
    
        <li><a href="../../articles/0056/0056-index.html">0056号(2017-08)</a></li>
    
        <li><a href="../../articles/0055/0055-index.html">0055号(2017-03)</a></li>
    
        <li><a href="../../articles/0054/0054-index.html">0054号(2016-08)</a></li>
    
        <li><a href="../../articles/pretokyorubykaigi11/preTokyoRubyKaigi11-index.html">東京 Ruby 会議 11 直前特集号</a></li>
    
        <li><a href="../../articles/0053/0053-index.html">0053号(2016-04)</a></li>
    
        <li><a href="../../articles/0052/0052-index.html">0052号(2015-12)</a></li>
    
        <li><a href="../../articles/0051/0051-index.html">0051号(2015-09)</a></li>
    
        <li><a href="../../articles/0050/0050-index.html">0050号(2015-05)</a></li>
    
        <li><a href="../../articles/0049/0049-index.html">0049号(2014-12)</a></li>
    
        <li><a href="../../articles/0048/0048-index.html">0048号(2014-09)</a></li>
    
        <li><a href="../../articles/0047/0047-index.html">0047号(2014-06)</a></li>
    
        <li><a href="../../articles/0046/0046-index.html">0046号(2014-04)</a></li>
    
        <li><a href="../../articles/0045/0045-index.html">0045号(2013-12)</a></li>
    
        <li><a href="../../articles/0044/0044-index.html">0044号(2013-09)</a></li>
    
        <li><a href="../../articles/0043/0043-index.html">0043号(2013-07)</a></li>
    
        <li><a href="../../articles/0042/0042-index.html">0042号(2013-05)</a></li>
    
        <li><a href="../../articles/ruby200specialen/Ruby200SpecialEn-index.html">2.0.0 Special (EN)</a></li>
    
        <li><a href="../../articles/0041/0041-index.html">0041号(2013-02)</a></li>
    
        <li><a href="../../articles/0040/0040-index.html">0040号(2012-11)</a></li>
    
        <li><a href="../../articles/0039/0039-index.html">0039号(2012-09)</a></li>
    
        <li><a href="../../articles/rubykaja/kaja.html">RubyKaja のご紹介</a></li>
    
        <li><a href="../../articles/0038/0038-index.html">0038号(2012-05)</a></li>
    
        <li><a href="../../articles/0037/0037-index.html">0037号(2012-02)</a></li>
    
        <li><a href="../../articles/0036/0036-index.html">0036号(2011-11)</a></li>
    
        <li><a href="../../articles/0035/0035-index.html">0035号(2011-09)</a></li>
    
        <li><a href="../../articles/prerubykaigi2011/preRubyKaigi2011-index.html">RubyKaigi2011直前特集号</a></li>
    
        <li><a href="../../articles/0034/0034-index.html">0034号(2011-06)</a></li>
    
        <li><a href="../../articles/0033/0033-index.html">0033号(2011-04)</a></li>
    
        <li><a href="../../articles/0032/0032-index.html">0032号(2011-01)</a></li>
    
        <li><a href="../../articles/0031/0031-index.html">0031号(2010-10)</a></li>
    
        <li><a href="../../articles/prerubykaigi2010/preRubyKaigi2010-index.html">RubyKaigi2010直前特集号</a></li>
    
        <li><a href="../../articles/0030/0030-index.html">0030号(2010-06)</a></li>
    
        <li><a href="../../articles/0029/0029-index.html">0029号(2010-03)</a></li>
    
        <li><a href="../../articles/0028/0028-index.html">0028号(2009-12)</a></li>
    
        <li><a href="../../articles/0027/0027-index.html">0027号(2009-09)</a></li>
    
        <li><a href="../../articles/0026/0026-index.html">0026号(2009-06)</a></li>
    
        <li><a href="../../articles/0025/0025-index.html">0025号(2009-02)</a></li>
    
        <li><a href="../../articles/0024/0024-index.html">0024号(2008-10)</a></li>
    
        <li><a href="../../articles/0023/0023-index.html">0023号(2008-03)</a></li>
    
        <li><a href="../../articles/0022/0022-index.html">0022号(2007-12)</a></li>
    
        <li><a href="../../articles/0021/0021-index.html">0021号(2007-09)</a></li>
    
        <li><a href="../../articles/0020/0020-index.html">0020号(2007-08)</a></li>
    
        <li><a href="../../articles/0019/0019-index.html">0019号(2007-05)</a></li>
    
        <li><a href="../../articles/0018/0018-index.html">0018号(2007-02)</a></li>
    
        <li><a href="../../articles/0017/0017-index.html">0017号(2006-11)</a></li>
    
        <li><a href="../../articles/0016/0016-index.html">0016号(2006-09)</a></li>
    
        <li><a href="../../articles/0015/0015-index.html">0015号(2006-07)</a></li>
    
        <li><a href="../../articles/rubykaigi2006/RubyKaigi2006-index.html">日本 Ruby カンファレンス 2006 特別号</a></li>
    
        <li><a href="../../articles/0014/0014-index.html">0014号(2006-05)</a></li>
    
        <li><a href="../../articles/0013/0013-index.html">0013号(2006-02)</a></li>
    
        <li><a href="../../articles/0012/0012-index.html">0012号(2005-12)</a></li>
    
        <li><a href="../../articles/0011/0011-index.html">0011号(2005-11)</a></li>
    
        <li><a href="../../articles/0010/0010-index.html">0010号(2005-10)</a></li>
    
        <li><a href="../../articles/0009/0009-index.html">0009号(2005-09)</a></li>
    
        <li><a href="../../articles/0008/0008-index.html">0008号(2005-07)</a></li>
    
        <li><a href="../../articles/0007/0007-index.html">0007号(2005-06)</a></li>
    
        <li><a href="../../articles/0006/0006-index.html">0006号(2005-05)</a></li>
    
        <li><a href="../../articles/0005/0005-index.html">0005号(2005-02)</a></li>
    
        <li><a href="../../articles/0004/0004-index.html">0004号(2004-12)</a></li>
    
        <li><a href="../../articles/0003/0003-index.html">0003号(2004-11)</a></li>
    
        <li><a href="../../articles/0002/0002-index.html">0002号(2004-10)</a></li>
    
        <li><a href="../../articles/0001/0001-index.html">0001号(2004-09)</a></li>
    
</ul>
<p class="rss-subscribe"><a href="/feed.xml">RSS</a></p>

            </div>
            <div class="col-md-10 main">
                <div class="row">
                    <div class="col-md-12">
                        <img src="../../images/rubima_logo_l.png">
                        <h1>Erubis の Preprocessing 機能を使って Ruby on Rails の View 層を高速化する</h1>
                        <div class="social-buttons">
                            <a href="http://b.hatena.ne.jp/entry//articles/0021/0021-Erubis.html" class="hatena-bookmark-button" data-hatena-bookmark-title="Erubis の Preprocessing 機能を使って Ruby on Rails の View 層を高速化する" data-hatena-bookmark-layout="simple-balloon" title="このエントリーをはてなブックマークに追加"><img src="https://b.st-hatena.com/images/entry-button/button-only@2x.png" alt="このエントリーをはてなブックマークに追加" width="20" height="20" style="border: none;" /></a><script type="text/javascript" src="https://b.st-hatena.com/js/bookmark_button.js" charset="utf-8" async="async"></script>
<span id="fb-root"></span>
<script>(function(d, s, id) {
  var js, fjs = d.getElementsByTagName(s)[0];
  if (d.getElementById(id)) return;
  js = d.createElement(s); js.id = id;
  js.src = "//connect.facebook.net/ja_JP/sdk.js#xfbml=1&version=v2.5";
  fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));</script>
<span class="fb-like" data-href="/articles/0021/0021-Erubis.html" data-layout="button_count" data-action="like" data-show-faces="false" data-share="false"></span>
<a href="https://twitter.com/share" class="twitter-share-button" data-url="/articles/0021/0021-Erubis.html" data-text="Erubis の Preprocessing 機能を使って Ruby on Rails の View 層を高速化する">ツイート</a>
<script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');</script>

                        </div>
                        
<p>書いた人：桑田 誠</p>

<ul id="markdown-toc">
  <li><a href="#はじめに" id="markdown-toc-はじめに">はじめに</a></li>
  <li><a href="#erubis-について" id="markdown-toc-erubis-について">Erubis について</a>    <ul>
      <li><a href="#erubis-のインストール" id="markdown-toc-erubis-のインストール">Erubis のインストール</a></li>
      <li><a href="#ruby-on-rails-で-erubis-を使う" id="markdown-toc-ruby-on-rails-で-erubis-を使う">Ruby on Rails で Erubis を使う</a></li>
    </ul>
  </li>
  <li><a href="#preprocessing-機能" id="markdown-toc-preprocessing-機能">Preprocessing 機能</a>    <ul>
      <li><a href="#preprocessing-機能の概要" id="markdown-toc-preprocessing-機能の概要">Preprocessing 機能の概要</a></li>
      <li><a href="#preprocessing-機能のサンプル" id="markdown-toc-preprocessing-機能のサンプル">Preprocessing 機能のサンプル</a></li>
      <li><a href="#引数に変数を含む場合" id="markdown-toc-引数に変数を含む場合">引数に変数を含む場合</a></li>
      <li><a href="#partial-テンプレートの展開" id="markdown-toc-partial-テンプレートの展開">Partial テンプレートの展開</a></li>
      <li><a href="#ループ展開" id="markdown-toc-ループ展開">ループ展開</a></li>
      <li><a href="#preprocessing-機能が使える場面と使えない場面" id="markdown-toc-preprocessing-機能が使える場面と使えない場面">Preprocessing 機能が使える場面と使えない場面</a></li>
    </ul>
  </li>
  <li><a href="#ベンチマーク" id="markdown-toc-ベンチマーク">ベンチマーク</a>    <ul>
      <li><a href="#ベンチマーク用アプリケーションの作成" id="markdown-toc-ベンチマーク用アプリケーションの作成">ベンチマーク用アプリケーションの作成</a></li>
      <li><a href="#ベンチマークとその結果" id="markdown-toc-ベンチマークとその結果">ベンチマークとその結果</a></li>
      <li><a href="#ベンチマーク結果の考察" id="markdown-toc-ベンチマーク結果の考察">ベンチマーク結果の考察</a></li>
    </ul>
  </li>
  <li><a href="#その他" id="markdown-toc-その他">その他</a>    <ul>
      <li><a href="#trimモード" id="markdown-toc-trimモード">Trimモード</a></li>
      <li><a href="#erbutilh-関数" id="markdown-toc-erbutilh-関数">ERB::Util::h() 関数</a></li>
    </ul>
  </li>
  <li><a href="#まとめ" id="markdown-toc-まとめ">まとめ</a></li>
  <li><a href="#参考" id="markdown-toc-参考">参考</a></li>
</ul>

<h2 id="はじめに">はじめに</h2>

<p><a href="http://www.kuwata-lab.com/erubis/">Erubis</a>とは、eRuby 処理系の一つであり、eruby や ERB の代替として使用できます。特長は、動作が高速なことと、拡張性が非常に高いことです。また Ruby on Rails を標準でサポートしています。</p>

<p>本稿では、Ruby on Rails において Erubis の Preprocessing 機能を使う方法を紹介します。Preprocessing 機能を使うと、Ruby on Rails におけるヘルパー関数の呼び出しが大幅に高速化されます。ベンチマークの結果では、最大で約2倍速くなりました。</p>

<p>なお本稿執筆時点での Erubis の最新版は 2.4.0 です。以降ではこのバージョンを使って説明します。</p>

<h2 id="erubis-について">Erubis について</h2>

<p><a href="http://www.kuwata-lab.com/erubis/">Erubis</a>とは、eruby や ERB と同じく eRuby 処理系の一つです。次のような特長があります。</p>

<ul>
  <li>pure Ruby でありながら極めて高速（ERB の約3倍、eruby の約1.1倍）</li>
  <li>Ruby 以外のプログラミング言語に対応(PHP, C, Java, JavaScript, Perl, Scheme)</li>
  <li>埋め込みの書式を変更可能（デフォルトは「&lt;% %&gt;」）</li>
  <li>「&lt;% %&gt;」の前後の空白と改行を自動的に削除</li>
  <li>「&lt;%= %&gt;」がデフォルトでHTMLエスケープするように設定可能</li>
  <li>Binding オブジェクトの代わりに Hash オブジェクトを使用可能</li>
  <li>YAML ファイルの読み込みをサポート</li>
  <li>Enhancer と呼ばれるモジュール群を使って様々な拡張が可能
    <ul>
      <li>行頭における「%」のサポート</li>
      <li>print文のサポート</li>
      <li>など</li>
    </ul>
  </li>
  <li>Ruby on Rails を標準でサポート</li>
</ul>

<p>本稿ではこれらの詳細については説明せず、Erubis を Ruby on Rails で使う方法についてのみ説明します。</p>

<h3 id="erubis-のインストール">Erubis のインストール</h3>

<p>Erubis をインストールするには、RubyGems を使う方法と、setup.rb を使う方法の2つがあります。</p>

<p>RubyGems を使う場合は、管理者権限で「gem install erubis」を実行してください。</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text">### UNIX、MacOS Xの場合
$ sudo gem install erubis</code></pre></figure>

<p>RubyGems が使えない場合は、Erubis をダウンロードして管理者権限で setup.rb を実行してください。</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text">### UNIX、MacOS Xの場合
$ tar xzf erubis_2.4.0.tar.gz
$ cd erubis_2.4.0/
$ sudo ruby setup.rb install</code></pre></figure>

<p>インストールが成功したかどうかを確かめるために、簡単なスクリプトを実行してみましょう。
次のように表示されれば成功です。</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text">### UNIX、MacOS Xの場合
$ cat test.rhtml
&lt;% for i in 1..3 %&gt;
Hello &lt;%= @name %&gt;
&lt;% end %&gt;
$ erubis -c '@name="world"' test.rhtml
Hello world
Hello world
Hello world</code></pre></figure>

<h3 id="ruby-on-rails-で-erubis-を使う">Ruby on Rails で Erubis を使う</h3>

<p>Ruby on Rails で Erubis を使うには、erubis/helpers/rails-helper.rb を使います。
config/environment.rb の最後に以下を追加してください。</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text">require 'erubis/helpers/rails_helper'
#Erubis::Helpers::RailsHelper.engine_class = Erubis::Eruby # または Erubis::FastEruby
#Erubis::Helpers::RailsHelper.init_properties = {}  # Erubis::Eruby.new() に渡すオプション
#Erubis::Helpers::RailsHelper.show_src = true       # ログにコンパイル結果を出力する
Erubis::Helpers::RailsHelper.preprocessing = true   # Preprocessing 機能を有効にする</code></pre></figure>

<p>この設定により、Ruby on Rails における eRuby エンジンとして、ERB のかわりに Erubis が使われるようになります。
Webサーバを再起動し、ログに「Erubis 2.4.0」と出力されていることを確認してください。</p>

<p>以下は設定オプションの説明です。</p>

<dl>
  <dt>Erubis::Helpers::RailsHelper.engine_class</dt>
  <dd></dd>
  <dd>eRubyファイルをRubyスクリプトに変換するクラスを指定します。デフォルトは Erubis::Eruby ですが、Erubis::FastEruby にすると若干速くなります。</dd>
  <dt>Erubis::Helpers::RailsHelper.init_properties</dt>
  <dd></dd>
  <dd>Erubis::Eruby.new() に渡すオプションです。通常は指定する必要はありません。</dd>
  <dt>Erubis::Helpers::RailsHelper.show_src</dt>
  <dd></dd>
  <dd>コンパイル結果をログファイルに出力するかどうかを指定します。true なら出力し、false なら出力しません。また nil であれば、development モードのときだけ出力します。デフォルトでは nil です。</dd>
  <dt>Erubis::Helpers::RailsHelper.preprocessing</dt>
  <dd></dd>
  <dd>Preprocessing 機能を有効にします（Preprocessing 機能については後述）。デフォルトは false なので、ここでは true に設定してください。</dd>
</dl>

<h2 id="preprocessing-機能">Preprocessing 機能</h2>

<p>Erubis では、Ruby on Rails のために Preprocessing 機能が用意されています。これを使うと、Ruby on Rails の View 層を大幅に高速化できます。</p>

<p>このセクションでは、Preprocessing 機能について解説します。</p>

<h3 id="preprocessing-機能の概要">Preprocessing 機能の概要</h3>

<p>Erubis の Preprocessing 機能とは、eRuby 文字列を Ruby スクリプトに変換する際に、埋め込まれたロジックの一部を実行する機能です。これにより、変換された Ruby スクリプト の実行が高速になります。</p>

<p>詳しく説明しましょう。ERB や Erubis のような eRuby 処理系の動作は、次のように2つのステージに分けられます。</p>

<ol>
  <li>eRuby 文字列を、Ruby スクリプトに変換する（変換ステージ）。</li>
  <li>変換後の Ruby スクリプトを eval などで実行する（実行ステージ）。</li>
</ol>

<p>ここでは前者を変換ステージ、後者を実行ステージと呼ぶことにします。</p>

<p>ここで大事なことは、同じ eRuby 文字列を何度も実行するときに、__実行ステージはその都度実行する必要があるが変換ステージは1回だけでよい__ということです。
例えばファイル list.rhtml を100回実行するとき、これを Ruby スクリプトに変換するのは最初の1回だけでよく、毎回変換する必要はないということです。
実際、Ruby on Rails では最初に list.rhtml を Ruby のメソッドに変換し、あとはこのメソッドを実行しています。</p>

<p>さて、通常の eRuby 処理系では、eRuby 文字列に埋め込まれた Ruby コード（文および式）は、実行ステージで実行されます。このうち、一部のコードを変換ステージで実行するのが Preprocessing 機能です。
つまり、__事前に実行できるコードはあらかじめ実行しておく__ことで、実行ステージでの負荷を減らし、View 層を高速化しようというわけです。</p>

<h3 id="preprocessing-機能のサンプル">Preprocessing 機能のサンプル</h3>

<p>Erubis では、Preprocessing 用の埋め込み書式を用意しています。</p>

<ul>
  <li>「[% 文 %]」は、Preprocessing 用の埋め込み文を表します。</li>
  <li>「[%= 式 %]」は、Preprocessing 用の埋め込み式を表します。</li>
</ul>

<p>サンプルを見てみましょう。
Ruby on Rails のアプリケーションを作成し、Erubis をインストールします。任意の View ファイルに次のような記述を追加します。</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text">&lt;%= link_to 'List', :action=&gt;'list' %&gt;
{{*[%= link_to 'Create', :action=&gt;'create' %]*}}</code></pre></figure>

<p>Preprocessing 機能により、「[%= … %]」の部分は変換時に実行され、次のようになります。</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text">&lt;%= link_to 'List', :action=&gt;'list' %&gt;
{{*&lt;a href="/myapp/create"&gt;Create&lt;/a&gt;*}}</code></pre></figure>

<p>そして、最終的に次のような Ruby スクリプトに変換されます。変換結果がログファイルに出力されるので確かめてください。</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text">_erbout = _buf = "";
_buf &lt;&lt; ( link_to 'List', :action=&gt;'list' ).to_s; _buf &lt;&lt; '
&lt;a href="/myapp/create"&gt;Create&lt;/a&gt;
';
_buf.to_s</code></pre></figure>

<p>これを見ると、「&lt;%= 式 %&gt;」は変換後もそのまま残っているのに対し、「[%= 式 %]」は変換時ですでに実行済みであることが分かります。
つまり Preprocessing 機能を使えば、実行ステージでは Ruby 式を実行しなくて済むため、View 層の動作が高速になります。</p>

<p>Ruby on Rails のヘルパー関数である link_to() は、意外と動作コストがかかるうえ、頻繁に実行されます。Ruby on Rails の View 層が遅いのは、実はこういったヘルパー関数の呼び出しと実行が原因です。このコストをなくすことで、View 層はかなり高速化できます。</p>

<h3 id="引数に変数を含む場合">引数に変数を含む場合</h3>

<p>ヘルパー関数の引数に変数を含む場合は、それらを「<em>?(‘…’)」で囲みます。「</em>?()」は引数として文字列をとり、それを「&lt;%=」と「%&gt;」で囲んだ文字列を返すユーティリティ関数です。また erubis/helpers/rails-helper.rb で定義されています。</p>

<p>サンプルを見てみましょう。任意の View ファイルに次のような記述を追加します。</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text">&lt;%= link_to 'Edit', :action=&gt;'edit', :id=&gt;@item.id %&gt;
[%= link_to 'Edit', :action=&gt;'edit', :id=&gt;{{*_?('@item.id')*}} %]</code></pre></figure>

<p>Preprocessing 機能により、これは次のように展開されます。</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text">&lt;%= link_to 'Edit', :action=&gt;'edit', :id=&gt;@item.id %&gt;
&lt;a href="/myapp/edit/{{*&lt;%=@item.id%&gt;*}}"&gt;Edit&lt;/a&gt;</code></pre></figure>

<p>そして最終的には次のような Ruby スクリプトに変換されます。</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text">_erbout = _buf = "";
_buf &lt;&lt; ( link_to 'Edit', :action=&gt;'edit', :id=&gt;@item.id ).to_s; _buf &lt;&lt; '
&lt;a href="/myapp/edit/"; _buf &lt;&lt; (@item.id).to_s; _buf &lt;&lt; '&gt;Edit&lt;/a&gt;
';
_buf.to_s</code></pre></figure>

<p>これを見ると、「_?(‘…’)」で囲まれた部分は変換時には評価されず、実行時に評価されることがわかります。</p>

<p>link_to() の呼び出しは実行コストが高いですが、「@item.id」の評価だけなら実行コストはとても低いです。つまり「_?()」を使うことで、引数に変数を含むような関数呼び出しも高速化できます。</p>

<h3 id="partial-テンプレートの展開">Partial テンプレートの展開</h3>

<p>Rubyist Magazine 19号の記事『<a href="http://jp.rubyist.net/magazine/?0019-RubyOnRails">RubyOnRails を使ってみる 【第 10 回】 パフォーマンスチューニング</a>』に、def_erb_method() を使って partial テンプレートの呼び出しを高速化する方法が紹介されています。</p>

<p>Preprocessing 機能を使うと、もっと簡単に partial テンプレートの呼び出しを高速化できます。</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text">&lt;% hidden = false; @people.each do |person| %&gt;
{{*[% filename = "#{RAILS_ROOT}/app/views/addressbook/_person.rhtml" %]*}}
{{*[%= File.read(filename) %]*}}
&lt;% end %&gt;</code></pre></figure>

<p>やってることは、partial テンプレートを読み込んでその場に展開しているだけです。簡単ですね。</p>

<p>Partial テンプレートの中でも Preprocessing 機能を使う場合は、次のようにします。</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text">&lt;% hidden = false; @people.each do |person| %&gt;
{{*[% filename = "#{RAILS_ROOT}/app/views/addressbook/_person.rhtml" %]*}}
{{*[% content = File.read(filename) %]*}}
{{*[% eruby = Erubis::Helpers::RailsHelper::PreprocessingEruby.new(content) %]*}}
{{*[%= eruby.evaluate(self) %]*}}
&lt;% end %&gt;</code></pre></figure>

<p>この場合は、Partial テンプレートを読み込むためのヘルパー関数を定義するとよいでしょう。</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text">def template_filepath(basename)
  return "#{RAILS_ROOT}/app/views/#{controller.controller_name}/#{basename}.rhtml"
end

def template_content(basename)
  return File.read(template_filepath(basename))
end

def template_content_with_preprocessing(basename)
  klass = Erubis::Helpers::RailsHelper::PreprocessingEruby
  eruby = klass.new(template_content(basename))
  return eruby.evaluate(self)
end</code></pre></figure>

<p>これを使うと、先ほどのテンプレートは次のように簡単になります。</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text">&lt;% hidden = false; @people.each do |person| %&gt;
&lt;%#= render :partial=&gt;'person' %&gt;
{{*[%= template_content_with_preprocessing('_person') %]*}}
&lt;% end %&gt;</code></pre></figure>

<p>ただし Preprocessing 機能を使うと、partial テンプレートのデバッグは困難になります (エラー時の行番号が変わるため)。Preprocessing 機能を使わない状態で充分テストしてから、Preprocessing 機能を使うようにしてください。</p>

<h3 id="ループ展開">ループ展開</h3>

<p>Preprocessing 機能を使って、ループをあらかじめ展開しておくこともできます。</p>

<p>例えば、次のような都道府県名のリストがあるとします。</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text">JP_STATES = [
  ['北海道', 1],
  ['青森',   2],
  ['岩手',   3],
  ...(省略)...
  ['沖縄',  47],
]
JP_STATES.freeze()

def jp_states()
  return JP_STATES
end</code></pre></figure>

<p>これを使って&lt;select&gt;タグと&lt;option&gt;タグを生成する場合、通常はヘルパー関数を使って次のようにします。</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text">&lt;%= select('address', 'state', jp_states(), {:include_blank=&gt;true}) %&gt;</code></pre></figure>

<p>これは次のような eRuby コードとだいたい同じです。</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text">&lt;% hash = { @address.state =&gt; 'selected="selected" } %&gt;
&lt;select id="address_state" name="address[state]"&gt;
&lt;% for name, code in jp_states() %&gt;
  &lt;option value="&lt;%=h code%&gt;" &lt;%=hash[code]%&gt;&gt;&lt;%=h name %&gt;&lt;/option&gt;
&lt;% end %&gt;
&lt;/select&gt;</code></pre></figure>

<p>これを見れば分かるように、select()メソッド内では&lt;option&gt;タグを生成するために毎回ループが実行されています。</p>

<p>しかし日本の都道府県は数も名前も決まっており、アプリケーション実行中に変化することはありません。そのため、本来ならば毎回ループを実行する必要はなく、あらかじめ47個の&lt;option&gt;タグに展開しておくことが可能です。</p>

<p>そこで、Preprocessing 機能を使って、ループを事前に実行してしまいましょう。</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text">&lt;% hash = { @address.state =&gt; 'selected="selected"' } %&gt;
&lt;select id="address_state" name="address[state]"&gt;
  &lt;option&gt;&lt;/option&gt;
{{*[% for name, code in jp_states() %]*}}
  &lt;option value="{{*[%=h code%]*}}" &lt;%=hash[{{*[%=code.inspect%]*}}]%&gt;&gt;{{*[%=h name%]*}}&lt;/option&gt;
{{*[% end %]*}}
&lt;/select&gt;</code></pre></figure>

<p>このコードは Preprocessing 機能により、次のような eRuby スクリプトに変換されます。</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text">&lt;% hash = { @address.state =&gt; 'selected="selected"' } %&gt;
&lt;select id="address_state" name="address[state]"&gt;
  &lt;option&gt;&lt;/option&gt;
  &lt;option value="1" &lt;%=hash[1]%&gt;北海道&lt;/option&gt;
  &lt;option value="2" &lt;%=hash[2]%&gt;青森&lt;/option&gt;
  &lt;option value="3" &lt;%=hash[3]%&gt;岩手&lt;/option&gt;
  ...(省略)...
  &lt;option value="47" &lt;%=hash[47]%&gt;沖縄&lt;/option&gt;
&lt;/select&gt;</code></pre></figure>

<p>これを見ると、ループが事前に実行されていることがわかります。
つまりあらかじめループが展開されるため、実行速度が速くなります。</p>

<p>しかし、このままだと入力エラーがあった場合に、&lt;select&gt; タグの周りに赤い border ラインが引かれません。入力エラーのことも考慮すると、次のように書く必要があります。</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text">&lt;% hash = { @address.state =&gt; 'selected="selected"' } %&gt;
{{*&lt;% error_msg = @address.errors.on('state') %&gt;*}}
{{*&lt;% stag = etag = '' %&gt;*}}
{{*&lt;% stag, etag = '&lt;div class="fieldWithErrors"&gt;', '&lt;/div&gt;' if error_msg %&gt;*}}
{{*&lt;%= stag %&gt;*}}&lt;select id="address_state" name="address[state]"&gt;
  &lt;option&gt;&lt;/option&gt;
[% for name, code in jp_states() %]
  &lt;option value="[%=h code%]" &lt;%=hash[[%=code.inspect%]]%&gt;&gt;[%=h name%]&lt;/option&gt;
[% end %]
&lt;/select&gt;{{*&lt;%= etag %&gt;*}}</code></pre></figure>

<p>最終的に、かなり複雑なコードになりました。もとは「&lt;%= select(‘address’, ‘state’, jp_states()) %&gt;」という1行だけだったのが、Preprocessing 機能を使おうとすると10行になってしまいました。複雑さと速度を天秤に掛け、本当に速度が必要な場面でのみ使うとよいでしょう。</p>

<h3 id="preprocessing-機能が使える場面と使えない場面">Preprocessing 機能が使える場面と使えない場面</h3>

<p>Ruby on Rails のヘルパー関数は、2種類に分けることができます。</p>

<ul>
  <li>同じ引数を与えれば同じ戻り値を返す関数は、Preprocessing 機能を使うことができます(<sup id="fnref:1"><a href="#fn:1" class="footnote">1</a></sup>)。例えば link_to() は同じ引数を与えれば同じ &lt;a&gt; タグが返されるので、Preprocessing 機能を使うことができます。</li>
  <li>同じ引数を与えても異なる結果を返すような関数は、Preprocessing 機能を使うことができません。例えば text_field() 関数は同じ引数を与えても、入力値のある・なし、エラーのある・なしで、異なる結果が返されるため、Preprocessing 機能は使えません。</li>
</ul>

<p>これは、他のロジックについても同じことがいえます。「都道府県の一覧を出力する」のように、毎回同じ結果になるロジックは Preprocessing 機能を使うことができます。そうでない場合は、Preprocessing 機能を使うことができません。</p>

<p>現在、多くの Web アプリケーション用フレームワークにおいて、View 層は「テンプレートエンジン」＋「ヘルパー関数」という組み合わせになっています。そのため、View 層を高速化しようとすると、テンプレートエンジンだけでなく、ヘルパー関数についても高速化をする必要があります。</p>

<p>今までは、ヘルパー関数を高速化するには、文字通り関数そのものを高速化するしかありませんでした。しかし Preprocessing 機能を前提とすると、関数の実行速度よりも、関数が Preprocessing 可能かどうかが重要になります。例えば text_field() を Preprocessing 可能な仕様に変更できれば、たとえ関数自体の実行速度が遅くても、View 層全体としては大幅に高速化できるでしょう。</p>

<p>つまり Preprocessing 機能は、View 層におけるヘルパー関数のあり方を大きく変える可能性があるといえます。</p>

<h2 id="ベンチマーク">ベンチマーク</h2>

<p>Preprocessing 機能でどのくらい速くなるのかを知るために、また ERB と Erubis とでどのくらい差が出るかを知るために、ベンチマークを実行してみました。以下、その解説です。</p>

<h3 id="ベンチマーク用アプリケーションの作成">ベンチマーク用アプリケーションの作成</h3>

<p>以下の手順で、ベンチマーク用のアプリケーションを作成しました。テーブルにデータを挿入する <a href="../../images/0021-Erubis/insert_stocks.sql">insert_stocks.sql</a> をダウンロードしておいてください。</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text">### データベースを作成する (ここでは MySQL を使用)
$ mysql -u root -p
Enter password: ********
mysql&gt; show databases;
mysql&gt; create database example1_development default character set utf8;
mysql&gt; create database example1_test default character set utf8;
mysql&gt; create database example1_production default character set utf8;
mysql&gt; grant all on example1_development.* to foo@localhost;
mysql&gt; grant all on example1_test.* to foo@localhost;
mysql&gt; grant all on example1_production.* to user1@localhost identified by 'passwd1';
mysql&gt; quit
### Rails アプリケーションを作成する
$ rails example1
$ cd example1/
$ vi config/database.yaml
### 'stocks' というテーブルを作成し、データを insert する
$ ruby script/generate migration create_stocks
$ vi db/migrate/001_create_stocks.rb
$ cat db/migrate/001_create_stocks.rb
class CreateStocks &lt; ActiveRecord::Migration
  def self.up
    create_table "stocks", :force=&gt;true do |t|
      t.column "name",   :string, :limit=&gt;100, :null=&gt;false
      t.column "url",    :string, :limit=&gt;150, :null=&gt;false
      t.column "symbol", :string, :limit=&gt;4,   :null=&gt;false
      t.column "price",  :float,               :null=&gt;false
      t.column "change", :float,               :null=&gt;false
      t.column "ratio",  :float,               :null=&gt;false
    end
  end
  def self.down
    drop_table "stocks"
  end
end
$ RAILS_ENV=production rake db:migrate
$ mysql -p -u user1 example1_production &lt; /tmp/insert_stocks.sql
Enter password: *****
### scaffold を実行する
$ RAILS_ENV=production ruby script/generate scaffold stock
### サーバを起動する
$ RAILS_ENV=production ruby script/server</code></pre></figure>

<p>ここまで来たら、ブラウザで <a href="http://localhost:3000/stocks/">http://localhost:3000/stocks/</a> にアクセスし、データが表示されることを確認します。</p>

<p>続いて app/controllers/stocks_controller.rb を編集し、StocksController#list() を次のように変更します。</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text">  ...
  def list
    @stock_pages, @stocks = paginate :stocks, :per_page =&gt; {{*20*}}
  end
  {{*alias list1 list*}}
  {{*alias list2 list*}}
  ...</code></pre></figure>

<p>また <a href="../../images/0021-Erubis/list1.rhtml">list1.rhtml</a> と <a href="../../images/0021-Erubis/list2.rhtml">list2.rhtml</a> をダウンロードし、app/views/stocks/ にコピーします。
list1.rhtml は Preprocessing 機能なし、list2.rhtml は Preprocessing 機能ありのテンプレートです。</p>

<p>もちろん Erubis の設定も必要です。セクション『<a href="../../articles/0021/0021-Erubis.html">Ruby on Rails で Erubis を使う</a>』の手順に従って、Erubis を設定します。</p>

<p>ここまで来たらサーバを再起動し、ブラウザで <a href="http://localhost:3000/stocks/list1">http://localhost:3000/stocks/list1</a> と <a href="http://localhost:3000/stocks/list2">http://localhost:3000/stocks/list2</a> にアクセスし、動作を確認します。</p>

<h3 id="ベンチマークとその結果">ベンチマークとその結果</h3>

<p>ベンチマークは、Apache Bench (ab) を使い、1000 リクエストを発行して行いました。
なお環境は MacOS X 10.4 Tiger, Intel CoreDuo 1.83MHz, Memory 2GB, Ruby 1.8.6, Ruby on Rails 1.2.3 です。</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text">### ERB を使う設定で
$ ab -n 1000 http://localhost:3000/stocks/list1
### Erubis を使う設定で
$ ab -n 1000 http://localhost:3000/stocks/list1  # Preprocessing なし
$ ab -n 1000 http://localhost:3000/stocks/list2  # Preprcoessing あり</code></pre></figure>

<p>実行結果は次の通りです。</p>

<table>
  <thead>
    <tr>
      <th>name</th>
      <th>sec</th>
      <th>rec/sec</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>ERB</td>
      <td>60.060</td>
      <td>16.65</td>
    </tr>
    <tr>
      <td>Erubis (Preprocessing なし)</td>
      <td>59.277</td>
      <td>16.87</td>
    </tr>
    <tr>
      <td>Erubis (Preprocessing あり)</td>
      <td>32.342</td>
      <td>30.92</td>
    </tr>
  </tbody>
</table>

<p>これを見ると、次のことが分かります。</p>

<ul>
  <li>ERB を Erubis に替えただけでは速くならない。</li>
  <li>Preprocessing 機能を使うと、最大で約2倍速くなる。</li>
</ul>

<h3 id="ベンチマーク結果の考察">ベンチマーク結果の考察</h3>

<p>ベンチマーク結果では、ERB と Erubis との差はほとんどありませんでした。
Erubis は確かに ERB より速いのですが、それがアプリケーション全体には影響を与えていません。</p>

<p>このことから Ruby on Rails では、eRuby によって費やされている時間はアプリケーション全体の実行時間からするとほんのわずかであることがわかります。つまりアプリケーション自体が遅すぎるため、ERB と比べたときの Erubis の速さなぞ誤差の範囲でしかないのです。</p>

<p>そもそも、ERB にしろ Erubis にしろ、単体で計測すると 1 秒あたり 1000〜2000 ページぐらい楽に生成することができます。それに比べると、1 秒あたり 16 リクエストしか処理できない Ruby on Rails のなんと遅いことでしょうか。これだけ Ruby on Rails が遅いと、単に ERB から Erubis に切り替えたところで何の効果もありません。</p>

<p>また Preprocessing 機能なしと比べると、Preprocessing 機能ありの場合は約2倍速くなっていることがわかります。今回のテンプレートでは、Preprocessing 機能を用いてヘルパー関数 link_to() の呼びだしを大幅に削減しています。このことから、View 層における実行時間の大部分が、ヘルパー関数によるものであることがわかります。</p>

<p>前に『View 層を速くするにはテンプレートエンジンだけでなくヘルパー関数も速くする必要がある』と書きました。Ruby on Rails ではたしかに View 層に時間がかかりますが、__View 層が遅い原因は ERB ではなくヘルパー関数__だったわけです。</p>

<p>今回のテンプレートでは、Preprocessing 機能を使って link_to() の呼び出しを削減しているわけですから、link_to() が比較的重いことがわかります。link_to() の何が重いのかは詳しく調べてみないとわかりませんが、恐らく URL を生成する部分 (つまり url_for() の呼び出し) が遅いのでしょう。やはりというか routes まわりは鬼門ですね。</p>

<h2 id="その他">その他</h2>

<p>Erubis に関するその他の話題について紹介します。</p>

<h3 id="trimモード">Trimモード</h3>

<p>ERB には、trim モードという設定があります。trim モードとは、「&lt;% %&gt;」の前後の空白および改行を出力する・しないを設定するためのオプションです。
Ruby on Rails では、trim モードはデフォルトで以下のように設定されています。</p>

<ul>
  <li>「&lt;% 文 %&gt;」または「&lt;%= 式 %&gt;」を使うと、前後の空白および改行は削除されない。</li>
  <li>「&lt;%- 文 -%&gt;」を使うと、前後の空白および改行を削除する。</li>
  <li>「&lt;%= 式 -%&gt;」を使うと、後ろの改行を削除する。</li>
</ul>

<p>Erubis にはこのような trim モードは存在せず、次のように動作します。</p>

<ul>
  <li>「&lt;% 文 %&gt;」の場合は、前後の空白および改行を削除する<sup id="fnref:2"><a href="#fn:2" class="footnote">2</a></sup>。</li>
  <li>「&lt;%= 式 %&gt;」の場合は、前後の空白および改行は削除されない。</li>
  <li>「&lt;%- 文 -%&gt;」は「&lt;% 文 %&gt;」と同じとみなされ、「&lt;%-= 式 -%&gt;」は「&lt;%= 式 %&gt;」と同じとみなされる。</li>
</ul>

<p>この違いを見てみましょう。例えば次のような eRuby コードがあったとします。</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text">&lt;!-- --&gt;
  &lt;% for i in 1..3 %&gt;
    &lt;%= i %&gt;
  &lt;% end %&gt;
&lt;!-- --&gt;</code></pre></figure>

<p>これを ERB で実行すると、次のように改行が出力されてしまいます。</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text">&lt;!-- --&gt;

    1

    2

    3

&lt;!-- --&gt;</code></pre></figure>

<p>Erubis で実行すると、余計な改行が出力されません。</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text">&lt;!-- --&gt;
    1
    2
    3
&lt;!-- --&gt;</code></pre></figure>

<p>また、「&lt;% %&gt;」の代わりに「&lt;%- -%&gt;」を使ってみます。</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text">&lt;!-- --&gt;
  &lt;%- for i in 1..3 -%&gt;
    &lt;%= i -%&gt;
  &lt;%- end -%&gt;
&lt;!-- --&gt;</code></pre></figure>

<p>これを ERB で実行すると、改行がまったく出力されません。</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text">&lt;!-- --&gt;
    1    2    3&lt;!-- --&gt;</code></pre></figure>

<p>Erubis だと、先ほどのと同じ結果になります。</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text">&lt;!-- --&gt;
    1
    2
    3
&lt;!-- --&gt;</code></pre></figure>

<p>ERB と Erubis にはこのような違いがあるので注意してください。</p>

<h3 id="erbutilh-関数">ERB::Util::h() 関数</h3>

<p>ERB::Util::h() は、「&lt; &gt; &amp; “」を「&amp;lt; &amp;gt; &amp;amp; &amp;quot;」に変換する関数です。</p>

<p>ERB::Util::h() の定義は次のようになっています。</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text">def html_escape(s)
  s.to_s.gsub(/&amp;/, "&amp;amp;").gsub(/\"/, "&amp;quot;").gsub(/&gt;/, "&amp;gt;").gsub(/&lt;/, "&amp;lt;")
end
alias h html_escape</code></pre></figure>

<p>しかし、これは文字列置換を4回も行っており、大変効率が悪いです。</p>

<p>そこで Erubis では、erubis/helpers/rails-helper.rb において、次のように ERB::Util::h() を再定義してきます。</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text">module ERB::Util
  ESCAPE_TABLE = { '&amp;'=&gt;'&amp;amp;', '&lt;'=&gt;'&amp;lt;', '&gt;'=&gt;'&amp;gt;', '"'=&gt;'&amp;quot;' }
  def h(value)
    value.to_s.gsub(/[&amp;&lt;&gt;"]/) { |s| ESCAPE_TABLE[s] }
  end
  module_function :h
end</code></pre></figure>

<p>新しい定義では、文字列置換を1回だけで済ませているため、特にエスケープする文字(「&lt; &gt; &amp; “」)が少ない場合に大幅に高速化されます。</p>

<p>ただしエスケープする文字が多い場合は、新しい定義ではブロック呼び出しのコストが大きくなるため、もとの定義より遅くなる場合があります。そのようなときは、ERB::Util::html_escape() を使ってあげるといいでしょう（ERB::Util::html_escape() は再定義されないため）。</p>

<h2 id="まとめ">まとめ</h2>

<p>本稿では、Erubis の Preprocessing 機能を使うことで、Ruby on Rails の View 層を大幅に高速化する方法を紹介しました。ERB の代わりに Erubis を使うだけではほとんど効果はありませんが、Preprocessing 機能を使うとヘルパー関数の呼び出しを大幅に削減できるため、かなりの高速化が実現できます。</p>

<p>また Preprocessing 機能は、フレームワークにおけるヘルパー関数のあり方を大きく変える可能性があります。なぜなら、関数の実行速度よりも、関数が Preprocessing 可能かどうかのほうが速度に大きく影響するためです。さらに Preprocessing 機能の考え方は、View 層だけにとどまらず、他の部分でも利用できるかもしれません。</p>

<p>本稿が Ruby on Rails の発展に役立てば幸いです。</p>

<h2 id="参考">参考</h2>

<dl>
  <dt><a href="http://www.kuwata-lab.com/erubis/">Erubis</a></dt>
  <dd></dd>
  <dd>本稿で紹介した eRuby 処理系である Erubis のサイトです。</dd>
  <dt><a href="http://railsexpress.de/blog/articles/2006/08/15/rails-template-optimizer-beta-test">RailsExpress.blog - Rails Template Optimizer Beta Test</a></dt>
  <dd></dd>
  <dd>ヘルパー関数を事前に Ruby コードに展開することで、View 層を高速化するプラグイン『template optimizer』の紹介です。Preprocessing 機能とは違って Ruby on Rails に特化しており、なんとヘルパー関数を自前で構文解析しているようです。Erubis の Preprocessing 機能と比べ、実装はかなり大変ですが、eRuby テンプレートを一切変更する必要がないという大きな長所があります。</dd>
</dl>

<hr />

<div class="footnotes">
  <ol>
    <li id="fn:1">
      <p>厳密にいうと、これは必要条件であって十分条件ではないのですが、Ruby on Rails のヘルパー関数でいえばこの条件でだいたい判断できます。&nbsp;<a href="#fnref:1" class="reversefootnote">&#8617;</a></p>
    </li>
    <li id="fn:2">
      <p>実際には、/^[ \t]<em>&lt;%.</em>?%&gt;[ \t]*(\r?\n)?/m にマッチした場合にのみ空白と改行が削除されます。&nbsp;<a href="#fnref:2" class="reversefootnote">&#8617;</a></p>
    </li>
  </ol>
</div>

                    </div>
                </div>
            </div>
        </div>
    </div>
  </body>
</html>
