<!DOCTYPE html>
<html>
  



  <head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-41117431-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'UA-41117431-1');
  </script>
  <script src="../../js/gtag.js"></script>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>Ruby 2.0.0： require improvements</title>
  <meta name="description" content="">

  <script src="../../js/jquery.min.js"></script>
  <script src="../../js/bootstrap.min.js"></script>
  <link href="../../css/bootstrap.min.css" rel="stylesheet" type="text/css">
  <link href="../../css/theme.css" rel="stylesheet" type="text/css">
  <link href="../../css/syntax.css" rel="stylesheet" type="text/css">
  <link href="../../css/sharebutton.css" rel="stylesheet" type="text/css">
  <link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet">

  <link rel="canonical" href="https://magazine.rubyist.net/articles/ruby200specialen/Ruby200SpecialEn-require.html">
  <link rel="alternate" type="application/rss+xml" title="Rubyist Magazine" href="https://magazine.rubyist.net/feed.xml">
  <link rel="shortcut icon" href="../../images/favicon.ico">
</head>

  <body>
    <div class="container-fluid">
        <div class="row full">
            <div class="col-md-2 hidden-xs sidebar">
                <h4>

</h4>

<h4>バックナンバー</h4>
<ul>
    <li><a href="../../articles/backnumber/backnumber.html">記事単位</a></li>
    <hr>
    
        <li><a href="../../articles/kaigi_on_rails/index.html.html">Kaigi on Rails 特集号</a></li>
    
        <li><a href="../../articles/prerubykaigi2020/preRubyKaigi2020-index.html">RubyKaigi Takeout 2020 特集号</a></li>
    
        <li><a href="../../articles/0061/0061-index.html">0061号(2020-02)</a></li>
    
        <li><a href="../../articles/0060/0060-index.html">0060号(2019-08)</a></li>
    
        <li><a href="../../articles/prerubykaigi2019/preRubyKaigi2019-index.html">RubyKaigi 2019 直前特集号</a></li>
    
        <li><a href="../../articles/0059/0059-index.html">0059号(2019-01)</a></li>
    
        <li><a href="../../articles/0058/0058-index.html">0058号(2018-08)</a></li>
    
        <li><a href="../../articles/prerubykaigi2018/preRubyKaigi2018-index.html">RubyKaigi 2018 直前特集号</a></li>
    
        <li><a href="../../articles/0057/0057-index.html">0057号(2018-02)</a></li>
    
        <li><a href="../../articles/prerubykaigi2017/preRubyKaigi2017-index.html">RubyKaigi 2017 直前特集号</a></li>
    
        <li><a href="../../articles/0056/0056-index.html">0056号(2017-08)</a></li>
    
        <li><a href="../../articles/0055/0055-index.html">0055号(2017-03)</a></li>
    
        <li><a href="../../articles/0054/0054-index.html">0054号(2016-08)</a></li>
    
        <li><a href="../../articles/pretokyorubykaigi11/preTokyoRubyKaigi11-index.html">東京 Ruby 会議 11 直前特集号</a></li>
    
        <li><a href="../../articles/0053/0053-index.html">0053号(2016-04)</a></li>
    
        <li><a href="../../articles/0052/0052-index.html">0052号(2015-12)</a></li>
    
        <li><a href="../../articles/0051/0051-index.html">0051号(2015-09)</a></li>
    
        <li><a href="../../articles/0050/0050-index.html">0050号(2015-05)</a></li>
    
        <li><a href="../../articles/0049/0049-index.html">0049号(2014-12)</a></li>
    
        <li><a href="../../articles/0048/0048-index.html">0048号(2014-09)</a></li>
    
        <li><a href="../../articles/0047/0047-index.html">0047号(2014-06)</a></li>
    
        <li><a href="../../articles/0046/0046-index.html">0046号(2014-04)</a></li>
    
        <li><a href="../../articles/0045/0045-index.html">0045号(2013-12)</a></li>
    
        <li><a href="../../articles/0044/0044-index.html">0044号(2013-09)</a></li>
    
        <li><a href="../../articles/0043/0043-index.html">0043号(2013-07)</a></li>
    
        <li><a href="../../articles/0042/0042-index.html">0042号(2013-05)</a></li>
    
        <li><a href="../../articles/ruby200specialen/Ruby200SpecialEn-index.html">2.0.0 Special (EN)</a></li>
    
        <li><a href="../../articles/0041/0041-index.html">0041号(2013-02)</a></li>
    
        <li><a href="../../articles/0040/0040-index.html">0040号(2012-11)</a></li>
    
        <li><a href="../../articles/0039/0039-index.html">0039号(2012-09)</a></li>
    
        <li><a href="../../articles/rubykaja/kaja.html">RubyKaja のご紹介</a></li>
    
        <li><a href="../../articles/0038/0038-index.html">0038号(2012-05)</a></li>
    
        <li><a href="../../articles/0037/0037-index.html">0037号(2012-02)</a></li>
    
        <li><a href="../../articles/0036/0036-index.html">0036号(2011-11)</a></li>
    
        <li><a href="../../articles/0035/0035-index.html">0035号(2011-09)</a></li>
    
        <li><a href="../../articles/prerubykaigi2011/preRubyKaigi2011-index.html">RubyKaigi2011直前特集号</a></li>
    
        <li><a href="../../articles/0034/0034-index.html">0034号(2011-06)</a></li>
    
        <li><a href="../../articles/0033/0033-index.html">0033号(2011-04)</a></li>
    
        <li><a href="../../articles/0032/0032-index.html">0032号(2011-01)</a></li>
    
        <li><a href="../../articles/0031/0031-index.html">0031号(2010-10)</a></li>
    
        <li><a href="../../articles/prerubykaigi2010/preRubyKaigi2010-index.html">RubyKaigi2010直前特集号</a></li>
    
        <li><a href="../../articles/0030/0030-index.html">0030号(2010-06)</a></li>
    
        <li><a href="../../articles/0029/0029-index.html">0029号(2010-03)</a></li>
    
        <li><a href="../../articles/0028/0028-index.html">0028号(2009-12)</a></li>
    
        <li><a href="../../articles/0027/0027-index.html">0027号(2009-09)</a></li>
    
        <li><a href="../../articles/0026/0026-index.html">0026号(2009-06)</a></li>
    
        <li><a href="../../articles/0025/0025-index.html">0025号(2009-02)</a></li>
    
        <li><a href="../../articles/0024/0024-index.html">0024号(2008-10)</a></li>
    
        <li><a href="../../articles/0023/0023-index.html">0023号(2008-03)</a></li>
    
        <li><a href="../../articles/0022/0022-index.html">0022号(2007-12)</a></li>
    
        <li><a href="../../articles/0021/0021-index.html">0021号(2007-09)</a></li>
    
        <li><a href="../../articles/0020/0020-index.html">0020号(2007-08)</a></li>
    
        <li><a href="../../articles/0019/0019-index.html">0019号(2007-05)</a></li>
    
        <li><a href="../../articles/0018/0018-index.html">0018号(2007-02)</a></li>
    
        <li><a href="../../articles/0017/0017-index.html">0017号(2006-11)</a></li>
    
        <li><a href="../../articles/0016/0016-index.html">0016号(2006-09)</a></li>
    
        <li><a href="../../articles/0015/0015-index.html">0015号(2006-07)</a></li>
    
        <li><a href="../../articles/rubykaigi2006/RubyKaigi2006-index.html">日本 Ruby カンファレンス 2006 特別号</a></li>
    
        <li><a href="../../articles/0014/0014-index.html">0014号(2006-05)</a></li>
    
        <li><a href="../../articles/0013/0013-index.html">0013号(2006-02)</a></li>
    
        <li><a href="../../articles/0012/0012-index.html">0012号(2005-12)</a></li>
    
        <li><a href="../../articles/0011/0011-index.html">0011号(2005-11)</a></li>
    
        <li><a href="../../articles/0010/0010-index.html">0010号(2005-10)</a></li>
    
        <li><a href="../../articles/0009/0009-index.html">0009号(2005-09)</a></li>
    
        <li><a href="../../articles/0008/0008-index.html">0008号(2005-07)</a></li>
    
        <li><a href="../../articles/0007/0007-index.html">0007号(2005-06)</a></li>
    
        <li><a href="../../articles/0006/0006-index.html">0006号(2005-05)</a></li>
    
        <li><a href="../../articles/0005/0005-index.html">0005号(2005-02)</a></li>
    
        <li><a href="../../articles/0004/0004-index.html">0004号(2004-12)</a></li>
    
        <li><a href="../../articles/0003/0003-index.html">0003号(2004-11)</a></li>
    
        <li><a href="../../articles/0002/0002-index.html">0002号(2004-10)</a></li>
    
        <li><a href="../../articles/0001/0001-index.html">0001号(2004-09)</a></li>
    
</ul>
<p class="rss-subscribe"><a href="/feed.xml">RSS</a></p>

            </div>
            <div class="col-md-10 main">
                <div class="row">
                    <div class="col-md-12">
                        <img src="../../images/rubima_logo_l.png">
                        <h1>Ruby 2.0.0： require improvements</h1>
                        <div class="social-buttons">
                            <div class='sns'>            
    <ul class="clearfix">
       <li class="twitter"><a href="https://twitter.com/share?text=Ruby 2.0.0： require improvements&amp;url=https://magazine.rubyist.net/articles/ruby200specialen/Ruby200SpecialEn-require.html" target="_blank" onclick="javascript:window.open(this.href, '', 'menubar=no,toolbar=no,resizable=yes,scrollbars=yes,height=300,width=600');return false;"><i class="fa fa-twitter"></i></a></li>
       <li class="facebook"><a href="https://www.facebook.com/sharer.php?u=https://magazine.rubyist.net/articles/ruby200specialen/Ruby200SpecialEn-require.html&amp;t=Ruby 2.0.0： require improvements" target="_blank" onclick="javascript:window.open(this.href, '', 'menubar=no,toolbar=no,resizable=yes,scrollbars=yes,height=300,width=600');return false;"><i class="fa fa-facebook"></i></a></li>
       <li class="hatebu"><a href="http://b.hatena.ne.jp/add?mode=confirm&amp;url=https://magazine.rubyist.net/articles/ruby200specialen/Ruby200SpecialEn-require.html&amp;Ruby 2.0.0： require improvements" target="_blank" onclick="javascript:window.open(this.href, '', 'menubar=no,toolbar=no,resizable=yes,scrollbars=yes,height=300,width=600');return false;"><i class="fa">B!</i></a></li>
    </ul>
</div>
                        </div>
                        <div class="post_info">
                            



                        </div>
                        
<p>Author: Masaya TARUI, Translator: Tatsuya Ono (<a href="https://twitter.com/ono">@ono</a>)</p>

<h2 id="its-got-faster">It’s got faster.</h2>

<p>Among bunch of new features and improvements, we have also improved the performance of require.</p>

<p>The number of libraries Rubygems distributes has been increased tremendously.
Sometimes you can get your programming work done only with writing little code by yourself.
Typical Ruby on Rails applications also depend on a lot of gem libraries these days.
Especially when you build a large Rails application, the loading time of gem libraries has been the one of most frustrating things to developers.</p>

<p>As a trade-off for adding some features, the file loading speed of require in Ruby 1.9 had got slower than Ruby 1.8.
Although we have been improving it in Ruby 1.9 upgrade, we also have succeeded to make it even faster in Ruby 2.0 with a few changes in the specification.
Please see the benchmark below (I took benchmarks several times and chose the best results):</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text">files=2000
begin
    files.times{|i|
        file = "req/file#{i}.rb"
        open(file,"wb"){}
    }
rescue
end
100.times{ $LOAD_PATH &lt;&lt; "/" } # emulates gem
$LOAD_PATH &lt;&lt; "."
start = Time.now
cnt=0
files.times{|j|
    file = "req/file#{j}.rb"
    require file
    cnt +=1
    puts "#{cnt}, #{Time.now - start}" if cnt % 100 == 0
}</code></pre></figure>

<p><img src="../../images/Ruby200SpecialEn-require/require_bench_linux.png" alt="require_bench_linux.png" />
<img src="../../images/Ruby200SpecialEn-require/require_bench_win.png" alt="require_bench_win.png" /></p>

<p>Since I have been putting a quite effort on opptimizing the performance, I am still bit annoyed with the fact 1.8.7 is the fastest ever.
However you can see it is getting closer to 1.8.7 and most of you would not notice the difference when you develop an application.</p>

<h2 id="changes">Changes</h2>

<p>I said “with a few changes in the specification” above.
Although I think most of you don’t care, I am explaining about these changes anyway.</p>

<ol>
  <li>Ruby 2.0 does <em>freeze</em> String objects in $LOAD_PATH</li>
  <li>Ruby 2.0 does <em>freeze</em> String objects in $LOADED_FEATURES</li>
  <li>Ruby 2.0 doesn’t call <em>to_path</em> method for String objects in $LOAD_PATH</li>
</ol>

<p>Regarding the number 1, Ruby 2.0 <em>freeze</em> String object when <em>require</em> is called. We think that it would not hurt you because String object doesn’t have so many methods changing the contents.
If you are eccentric enough to try to manipulate some objects in $LOAD_PATH… please regret that.</p>

<p>Sample code:</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text">$LOAD_PATH &lt;&lt; "/hoge"
require 'hoga'
$LOAD_PATH[-1] &lt;&lt; "/fuga"
 =&gt; Ruby 1.9: "/hoge" is changed to "/hoge/fuga" in the load path
 =&gt; Ruby 2.0: TypeError(can't modify frozen string) will be raised</code></pre></figure>

<p>About the second point, $LOADED_FEATURES is an array that is used to indentify the file required.
Ruby 2.0 does <em>freeze</em> String objects in $LOADED_FEATURES like $LOAD_PATH.</p>

<p>Lastly about the third point, you probably even did not know this: if an object in $LOAD_PATH has <em>to_path</em> method, Ruby would call the method and use its return value as the path.
Obviously it is just a needless step for any String objects in $LOAD_PATH.
Therefore Ruby 2.0 does not call <em>to_path</em> method for the String objects anymore.</p>

<p>Sample code:</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text">path = "/foo"
class &lt;&lt; path
  def to_path
    self + $MAGIC
  end
end
$LOAD_PATH &lt;&lt; path
$MAGIC = "/bar"
 =&gt; Ruby 1.9: the load path is changed to "/foo/bar"
 =&gt; Ruby 2.0: "/foo" is still the load path</code></pre></figure>

<p>Main reason behind those changes is to cache file paths in order to speed it up. <em>freeze</em> can ensure that the value is not changed.
However, since you can change the return value of <em>to_path</em> method without changing contents, we had to stop calling it for String objects in order to guarantee the file path is not changed.</p>

<p>You can still add non-String objects to $LOAD_PATH. In this case, Ruby 2.0 still calls <em>to_path</em> for the objects but you won’t get any benefit from the performance improvement.
I don’t recommend it<sup id="fnref:1" role="doc-noteref"><a href="#fn:1" class="footnote">1</a></sup>.</p>

<p>In addition, you can find very interesting gimmick in the implementation of the logic detecting the changes on $LOAD_PATH and $LOADED_FEATURES.
It uses share flag of the array inside $LOAD_PATH and $LOADED_FEATURES.
Check out <a href="https://bugs.ruby-lang.org/issues/7158">https://bugs.ruby-lang.org/issues/7158</a> for the details if you are interested.</p>

<h2 id="the-last-message">The last message</h2>

<p>Have a fast Ruby life with Ruby 2.0!</p>

<h2 id="about-the-author">About the author</h2>

<p>Masaya TARUI</p>

<p>“No Tool, No Life. How wonderful civilization is. Let’s civilize!”</p>

<p>I am living in IRB on Windoes and pretty mad at the speed.
Imagine a tool is improved, gets 1 second faster and a thousand people use it a thousand times: it can save a million seconds.
That sounds amazing, doesn’t it?</p>

<hr />

<div class="footnotes" role="doc-endnotes">
  <ol>
    <li id="fn:1" role="doc-endnote">
      <p>I don’t know how many people have tried that :-) <a href="#fnref:1" class="reversefootnote" role="doc-backlink">&#8617;</a></p>
    </li>
  </ol>
</div>

                    </div>
                </div>
            </div>
        </div>
    </div>
  </body>
</html>
