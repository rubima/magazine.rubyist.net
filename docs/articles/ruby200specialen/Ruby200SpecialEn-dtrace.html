<!DOCTYPE html>
<html>
  



  <head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-41117431-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'UA-41117431-1');
  </script>
  <script src="../../js/gtag.js"></script>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>Ruby 2.0.0： DTrace support</title>
  <meta name="description" content="">

  <script src="../../js/jquery.min.js"></script>
  <script src="../../js/bootstrap.min.js"></script>
  <link href="../../css/bootstrap.min.css" rel="stylesheet" type="text/css">
  <link href="../../css/theme.css" rel="stylesheet" type="text/css">
  <link href="../../css/syntax.css" rel="stylesheet" type="text/css">
  <link href="../../css/sharebutton.css" rel="stylesheet" type="text/css">
  <link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet">

  <link rel="canonical" href="https://magazine.rubyist.net/articles/ruby200specialen/Ruby200SpecialEn-dtrace.html">
  <link rel="alternate" type="application/rss+xml" title="Rubyist Magazine" href="https://magazine.rubyist.net/feed.xml">
  <link rel="shortcut icon" href="../../images/favicon.ico">
</head>

  <body>
    <div class="container-fluid">
        <div class="row full">
            <div class="col-md-2 hidden-xs sidebar">
                <h4>

</h4>

<h4>バックナンバー</h4>
<ul>
    <li><a href="../../articles/backnumber/backnumber.html">記事単位</a></li>
    <hr>
    
        <li><a href="../../articles/kaigi_on_rails/index.html.html">Kaigi on Rails 特集号</a></li>
    
        <li><a href="../../articles/prerubykaigi2020/preRubyKaigi2020-index.html">RubyKaigi Takeout 2020 特集号</a></li>
    
        <li><a href="../../articles/0061/0061-index.html">0061号(2020-02)</a></li>
    
        <li><a href="../../articles/0060/0060-index.html">0060号(2019-08)</a></li>
    
        <li><a href="../../articles/prerubykaigi2019/preRubyKaigi2019-index.html">RubyKaigi 2019 直前特集号</a></li>
    
        <li><a href="../../articles/0059/0059-index.html">0059号(2019-01)</a></li>
    
        <li><a href="../../articles/0058/0058-index.html">0058号(2018-08)</a></li>
    
        <li><a href="../../articles/prerubykaigi2018/preRubyKaigi2018-index.html">RubyKaigi 2018 直前特集号</a></li>
    
        <li><a href="../../articles/0057/0057-index.html">0057号(2018-02)</a></li>
    
        <li><a href="../../articles/prerubykaigi2017/preRubyKaigi2017-index.html">RubyKaigi 2017 直前特集号</a></li>
    
        <li><a href="../../articles/0056/0056-index.html">0056号(2017-08)</a></li>
    
        <li><a href="../../articles/0055/0055-index.html">0055号(2017-03)</a></li>
    
        <li><a href="../../articles/0054/0054-index.html">0054号(2016-08)</a></li>
    
        <li><a href="../../articles/pretokyorubykaigi11/preTokyoRubyKaigi11-index.html">東京 Ruby 会議 11 直前特集号</a></li>
    
        <li><a href="../../articles/0053/0053-index.html">0053号(2016-04)</a></li>
    
        <li><a href="../../articles/0052/0052-index.html">0052号(2015-12)</a></li>
    
        <li><a href="../../articles/0051/0051-index.html">0051号(2015-09)</a></li>
    
        <li><a href="../../articles/0050/0050-index.html">0050号(2015-05)</a></li>
    
        <li><a href="../../articles/0049/0049-index.html">0049号(2014-12)</a></li>
    
        <li><a href="../../articles/0048/0048-index.html">0048号(2014-09)</a></li>
    
        <li><a href="../../articles/0047/0047-index.html">0047号(2014-06)</a></li>
    
        <li><a href="../../articles/0046/0046-index.html">0046号(2014-04)</a></li>
    
        <li><a href="../../articles/0045/0045-index.html">0045号(2013-12)</a></li>
    
        <li><a href="../../articles/0044/0044-index.html">0044号(2013-09)</a></li>
    
        <li><a href="../../articles/0043/0043-index.html">0043号(2013-07)</a></li>
    
        <li><a href="../../articles/0042/0042-index.html">0042号(2013-05)</a></li>
    
        <li><a href="../../articles/ruby200specialen/Ruby200SpecialEn-index.html">2.0.0 Special (EN)</a></li>
    
        <li><a href="../../articles/0041/0041-index.html">0041号(2013-02)</a></li>
    
        <li><a href="../../articles/0040/0040-index.html">0040号(2012-11)</a></li>
    
        <li><a href="../../articles/0039/0039-index.html">0039号(2012-09)</a></li>
    
        <li><a href="../../articles/rubykaja/kaja.html">RubyKaja のご紹介</a></li>
    
        <li><a href="../../articles/0038/0038-index.html">0038号(2012-05)</a></li>
    
        <li><a href="../../articles/0037/0037-index.html">0037号(2012-02)</a></li>
    
        <li><a href="../../articles/0036/0036-index.html">0036号(2011-11)</a></li>
    
        <li><a href="../../articles/0035/0035-index.html">0035号(2011-09)</a></li>
    
        <li><a href="../../articles/prerubykaigi2011/preRubyKaigi2011-index.html">RubyKaigi2011直前特集号</a></li>
    
        <li><a href="../../articles/0034/0034-index.html">0034号(2011-06)</a></li>
    
        <li><a href="../../articles/0033/0033-index.html">0033号(2011-04)</a></li>
    
        <li><a href="../../articles/0032/0032-index.html">0032号(2011-01)</a></li>
    
        <li><a href="../../articles/0031/0031-index.html">0031号(2010-10)</a></li>
    
        <li><a href="../../articles/prerubykaigi2010/preRubyKaigi2010-index.html">RubyKaigi2010直前特集号</a></li>
    
        <li><a href="../../articles/0030/0030-index.html">0030号(2010-06)</a></li>
    
        <li><a href="../../articles/0029/0029-index.html">0029号(2010-03)</a></li>
    
        <li><a href="../../articles/0028/0028-index.html">0028号(2009-12)</a></li>
    
        <li><a href="../../articles/0027/0027-index.html">0027号(2009-09)</a></li>
    
        <li><a href="../../articles/0026/0026-index.html">0026号(2009-06)</a></li>
    
        <li><a href="../../articles/0025/0025-index.html">0025号(2009-02)</a></li>
    
        <li><a href="../../articles/0024/0024-index.html">0024号(2008-10)</a></li>
    
        <li><a href="../../articles/0023/0023-index.html">0023号(2008-03)</a></li>
    
        <li><a href="../../articles/0022/0022-index.html">0022号(2007-12)</a></li>
    
        <li><a href="../../articles/0021/0021-index.html">0021号(2007-09)</a></li>
    
        <li><a href="../../articles/0020/0020-index.html">0020号(2007-08)</a></li>
    
        <li><a href="../../articles/0019/0019-index.html">0019号(2007-05)</a></li>
    
        <li><a href="../../articles/0018/0018-index.html">0018号(2007-02)</a></li>
    
        <li><a href="../../articles/0017/0017-index.html">0017号(2006-11)</a></li>
    
        <li><a href="../../articles/0016/0016-index.html">0016号(2006-09)</a></li>
    
        <li><a href="../../articles/0015/0015-index.html">0015号(2006-07)</a></li>
    
        <li><a href="../../articles/rubykaigi2006/RubyKaigi2006-index.html">日本 Ruby カンファレンス 2006 特別号</a></li>
    
        <li><a href="../../articles/0014/0014-index.html">0014号(2006-05)</a></li>
    
        <li><a href="../../articles/0013/0013-index.html">0013号(2006-02)</a></li>
    
        <li><a href="../../articles/0012/0012-index.html">0012号(2005-12)</a></li>
    
        <li><a href="../../articles/0011/0011-index.html">0011号(2005-11)</a></li>
    
        <li><a href="../../articles/0010/0010-index.html">0010号(2005-10)</a></li>
    
        <li><a href="../../articles/0009/0009-index.html">0009号(2005-09)</a></li>
    
        <li><a href="../../articles/0008/0008-index.html">0008号(2005-07)</a></li>
    
        <li><a href="../../articles/0007/0007-index.html">0007号(2005-06)</a></li>
    
        <li><a href="../../articles/0006/0006-index.html">0006号(2005-05)</a></li>
    
        <li><a href="../../articles/0005/0005-index.html">0005号(2005-02)</a></li>
    
        <li><a href="../../articles/0004/0004-index.html">0004号(2004-12)</a></li>
    
        <li><a href="../../articles/0003/0003-index.html">0003号(2004-11)</a></li>
    
        <li><a href="../../articles/0002/0002-index.html">0002号(2004-10)</a></li>
    
        <li><a href="../../articles/0001/0001-index.html">0001号(2004-09)</a></li>
    
</ul>
<p class="rss-subscribe"><a href="/feed.xml">RSS</a></p>

            </div>
            <div class="col-md-10 main">
                <div class="row">
                    <div class="col-md-12">
                        <img src="../../images/rubima_logo_l.png">
                        <h1>Ruby 2.0.0： DTrace support</h1>
                        <div class="social-buttons">
                            <div class='sns'>            
    <ul class="clearfix">
       <li class="twitter"><a href="https://twitter.com/share?text=Ruby 2.0.0： DTrace support&amp;url=https://magazine.rubyist.net/articles/ruby200specialen/Ruby200SpecialEn-dtrace.html" target="_blank" onclick="javascript:window.open(this.href, '', 'menubar=no,toolbar=no,resizable=yes,scrollbars=yes,height=300,width=600');return false;"><i class="fa fa-twitter"></i></a></li>
       <li class="facebook"><a href="https://www.facebook.com/sharer.php?u=https://magazine.rubyist.net/articles/ruby200specialen/Ruby200SpecialEn-dtrace.html&amp;t=Ruby 2.0.0： DTrace support" target="_blank" onclick="javascript:window.open(this.href, '', 'menubar=no,toolbar=no,resizable=yes,scrollbars=yes,height=300,width=600');return false;"><i class="fa fa-facebook"></i></a></li>
       <li class="hatebu"><a href="http://b.hatena.ne.jp/add?mode=confirm&amp;url=https://magazine.rubyist.net/articles/ruby200specialen/Ruby200SpecialEn-dtrace.html&amp;Ruby 2.0.0： DTrace support" target="_blank" onclick="javascript:window.open(this.href, '', 'menubar=no,toolbar=no,resizable=yes,scrollbars=yes,height=300,width=600');return false;"><i class="fa">B!</i></a></li>
    </ul>
</div>
                        </div>
                        <div class="post_info">
                            



                        </div>
                        
<p>Author：Aaron Patterson (<a href="https://twitter.com/tenderlove">@tenderlove</a>)</p>

<h2 id="introduction-to-dtrace-with-ruby-20">Introduction to DTrace with Ruby 2.0</h2>

<p>Ruby 2.0 will feature DTrace probes built in. If your system supports DTrace, you can use these probes to understand how your Ruby process is behaving. This article is a basic introduction to using DTrace probes with Ruby 2.0.</p>

<p>The examples in this article were done on OS X, and may be different depending on your system.</p>

<h2 id="what-is-dtrace">What is DTrace?</h2>

<p>DTrace is a tracing framework created by Sun Microsystems. It allows you to troubleshoot applications in real time, and debug processes while they are running in production.</p>

<h2 id="the-d-language">The D language</h2>

<p>DTrace uses the D language for making queries about a running process. A D program is a series of statements that look like this:</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text">probe /test/ { action }
probe /test/ { action }</code></pre></figure>

<p>When a probe fires, it runs the test, if the test passes, then the action is executed. The test can be omitted, and when the probe fires, the action will always run:</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text">probe { action }</code></pre></figure>

<p>The format of <strong>probe</strong> looks like this.</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text">provider:module:function:name</code></pre></figure>

<ul>
  <li><strong>provider</strong> is the name of the provider. In our case, <strong>ruby</strong>.</li>
  <li><strong>module</strong> is the software location (we won’t use this)</li>
  <li><strong>function</strong> is the software function (we won’t use this either)</li>
  <li><strong>name</strong> is the name of the probe.</li>
</ul>

<p>In our case, “ruby” is the provider, and the probe names are <a href="https://bugs.ruby-lang.org/projects/ruby/wiki/DTraceProbes">any of the names listed on the wiki</a>.</p>

<p>For example, if we want to probe all method entries, we do this:</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text">ruby:::method-entry { action }</code></pre></figure>

<p>In the action section, we can print “hello world” every time a method is entered like this:</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text">ruby:::method-entry { printf("hello world\n"); }</code></pre></figure>

<p>Run this D program with the <strong>dtrace</strong> command like this:</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text">$ sudo dtrace -q -n'ruby$target:::method-entry { printf("hello world\n"); }' -c"ruby -e'puts :hi'"</code></pre></figure>

<p>Note that DTrace works with your kernel, so it requires elevated permissions, so we have to use <strong>sudo</strong>. Also, <strong>$target</strong> is substituted for the process id of the command supplied to the <strong>-c</strong> option. If you don’t use <strong>$target</strong>, then DTrace will probe <strong>all</strong> currently running Ruby process on your system.</p>

<p>Let’s try a few more examples with Ruby!</p>

<h2 id="probing-ruby">Probing Ruby</h2>

<p>Here is a program I put in a file called <strong>t.rb</strong>:</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text">class Foo
  def hello
    puts :hello
  end
end

5.times do
  foo = Foo.new
  foo.hello
  sleep 1
end</code></pre></figure>

<p>The <strong>ruby:::method-entry</strong> probe receives the class name and method name when it is called. Write a file called <strong>x.d</strong> with the following code:</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text">ruby$target:::method-entry
{
  printf("%s#%s\n", copyinstr(arg0), copyinstr(arg1));
}</code></pre></figure>

<p>Then run the following command:</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text">sudo dtrace -q -s x.d -c"ruby t.rb"</code></pre></figure>

<p>You should see lots of output, but eventually it will start to look like this:</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text">hello
Foo#hello
hello
Foo#hello
hello
Foo#hello
hello
Foo#hello</code></pre></figure>

<p>In our D program, <strong>arg0</strong> contains the class name, <strong>arg1</strong> contains the method name. Many methods are executed when starting Ruby, so let’s filter the results to just the t.rb file.</p>

<p><strong>arg2</strong> contains the file name, so we can change the D program and add a test like this:</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text">ruby$target:::method-entry
/copyinstr(arg2) == "t.rb"/
{
  printf("%s#%s\n", copyinstr(arg0), copyinstr(arg1));
}</code></pre></figure>

<p>Now the probe only fires when the method is inside <strong>t.rb</strong>. If you rerun the program, you should only see something like this:</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text">hello
Foo#hello
hello
Foo#hello
hello
Foo#hello
hello
Foo#hello</code></pre></figure>

<h2 id="tracing-a-process">Tracing a process</h2>

<p>With DTrace, we can attach to a currently running process. Change <strong>t.rb</strong> to look like this:</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text">class Foo
  def hello
    puts :hello
  end
end

loop do
  foo = Foo.new
  foo.hello
  sleep 1
end</code></pre></figure>

<p>Run this program in one terminal. In a different terminal, find the process id, and run DTrace like this:</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text">sudo dtrace -q -s x.d -p $PID</code></pre></figure>

<p>where $PID is the process id of the Ruby program. You should see output like this from DTrace:</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text">Foo#hello
Foo#hello
Foo#hello
Foo#hello
Foo#hello</code></pre></figure>

<p>You can use DTrace to understand how a running process is behaving!</p>

<h2 id="one-more-trick">One more trick</h2>

<p>One powerful feature of DTrace is the ability to gather statistics. Let’s write a program to count the number of methods called in a program.</p>

<p>Here is the Ruby program:</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text">class Foo
  def hello
  end
  def world
  end
end

foo = Foo.new
100.times   { foo.hello }
10000.times { foo.world }</code></pre></figure>

<p>Here is the D program:</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text">ruby$target:::method-entry
/copyinstr(arg2) == "t.rb"/
{
  @[copyinstr(arg0), copyinstr(arg1)] = count();
}</code></pre></figure>

<p>The special variable <strong>@</strong> in D is similar to a Ruby hash. The key to this hash is the target class and method. The value is the number of times that method is called.</p>

<p>If we run the program:</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text">$ sudo dtrace -q -s x.d -c"ruby t.rb"</code></pre></figure>

<p>We see output like this:</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text">  Foo          hello          100
  Foo          world        10000</code></pre></figure>

<p>We can clearly see that <strong>Foo#hello</strong> is called 100 times, and <strong>Foo#world</strong> is called 10000 times.</p>

<h2 id="conclusion">Conclusion</h2>

<p>I hope this was a good introduction for getting started with DTrace and Ruby 2.0. Remember that you must use Ruby 2.0.0 and be on a system that supports DTrace for these examples to work.</p>

<p>Have fun hacking with DTrace!</p>

<h2 id="about-the-author">About the Author</h2>

<p>Aaron was born and raised on the mean streets of Salt Lake City. His only hope for survival was to join the local gang of undercover street ballet performers known as the Tender Tights. As a Tender Tights member, Aaron learned to perfect the technique of self-defense pirouettes so that nobody, not even the Parkour Posse could catch him. Between vicious street dance-offs, Aaron taught himself to program. He learned to combine the art of street ballet with the craft of software engineering. Using these unique skills, he was able to leave his life on the streets and become a professional software engineer. He is currently Pirouetting through Processes, and Couruing through code for AT&amp;T. Sometimes he thinks back fondly on his life in the Tender Tights, but then he remembers that it is better to have Tender Loved and Lost than to never have Tender Taught at all.</p>


                    </div>
                </div>
            </div>
        </div>
    </div>
  </body>
</html>
