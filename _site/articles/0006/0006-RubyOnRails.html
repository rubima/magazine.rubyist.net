<!DOCTYPE html>
<html>
  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>RubyOnRails を使ってみる 【第 3 回】 ActiveRecord</title>
  <meta name="description" content="もりきゅうです。">

  <script src="/js/jquery.min.js"></script>
  <script src="/js/bootstrap.min.js"></script>
  <link href="/css/bootstrap.min.css" rel="stylesheet" type="text/css">
  <link href="/css/theme.css" rel="stylesheet" type="text/css">
  <link href="/css/syntax.css" rel="stylesheet" type="text/css">

  <link rel="canonical" href="http://magazine.rubyist.net/articles/0006/0006-RubyOnRails.html">
  <link rel="alternate" type="application/rss+xml" title="Rubyist Magazine" href="http://magazine.rubyist.net/feed.xml">
  <link rel="shortcut icon" href="/images/favicon.ico">
</head>

  <body>
    <div class="container-fluid">
        <div class="row">
            <div class="col-md-1 hidden-xs sidebar">
                <img src="../images/rubima_logo_left_top.png" alt="Rubima Logo" class="img-responsive">

<h4>

</h4>

<h4>バックナンバー</h4>
<ul>
    
        <li><a href="/articles/0056/0056-index.html">0056号(2017-08)</a></li>
    
        <li><a href="/articles/0055/0055-index.html">0055号(2017-03)</a></li>
    
        <li><a href="/articles/0054/0054-index.html">0054号(2016-08)</a></li>
    
        <li><a href="/articles/pretokyorubykaigi11/preTokyoRubyKaigi11.html">東京 Ruby 会議 11 直前特集号</a></li>
    
        <li><a href="/articles/0053/0053-index.html">0053号(2016-04)</a></li>
    
        <li><a href="/articles/0052/0052-index.html">0052号(2015-12)</a></li>
    
        <li><a href="/articles/0051/0051-index.html">0051号(2015-09)</a></li>
    
        <li><a href="/articles/0050/0050-index.html">0050号(2015-05)</a></li>
    
        <li><a href="/articles/0049/0049-index.html">0049号(2014-12)</a></li>
    
        <li><a href="/articles/0048/0048-index.html">0048号(2014-09)</a></li>
    
        <li><a href="/articles/0047/0047-index.html">0047号(2014-06)</a></li>
    
        <li><a href="/articles/0046/0046-index.html">0046号(2014-04)</a></li>
    
        <li><a href="/articles/0045/0045-index.html">0045号(2013-12)</a></li>
    
        <li><a href="/articles/0044/0044-index.html">0044号(2013-09)</a></li>
    
        <li><a href="/articles/0043/0043-index.html">0043号(2013-07)</a></li>
    
        <li><a href="/articles/0042/0042-index.html">0042号(2013-05)</a></li>
    
        <li><a href="/articles/ruby200specialen/Ruby200SpecialEn.html">2.0.0 Special (EN)</a></li>
    
        <li><a href="/articles/0041/0041-index.html">0041号(2013-02)</a></li>
    
        <li><a href="/articles/0040/0040-index.html">0040号(2012-11)</a></li>
    
        <li><a href="/articles/0039/0039-index.html">0039号(2012-09)</a></li>
    
        <li><a href="/articles/rubykaja/kaja.html">RubyKaja のご紹介</a></li>
    
        <li><a href="/articles/0038/0038-index.html">0038号(2012-05)</a></li>
    
        <li><a href="/articles/0037/0037-index.html">0037号(2012-02)</a></li>
    
        <li><a href="/articles/0036/0036-index.html">0036号(2011-11)</a></li>
    
        <li><a href="/articles/0035/0035-index.html">0035号(2011-09)</a></li>
    
        <li><a href="/articles/prerubykaigi2011/preRubyKaigi2011.html">RubyKaigi2011直前特集号</a></li>
    
        <li><a href="/articles/0034/0034-index.html">0034号(2011-06)</a></li>
    
        <li><a href="/articles/0033/0033-index.html">0033号(2011-04)</a></li>
    
        <li><a href="/articles/0032/0032-index.html">0032号(2011-01)</a></li>
    
        <li><a href="/articles/0031/0031-index.html">0031号(2010-10)</a></li>
    
        <li><a href="/articles/prerubykaigi2010/preRubyKaigi2010.html">RubyKaigi2010直前特集号</a></li>
    
        <li><a href="/articles/0030/0030-index.html">0030号(2010-06)</a></li>
    
        <li><a href="/articles/0029/0029-index.html">0029号(2010-03)</a></li>
    
        <li><a href="/articles/0028/0028-index.html">0028号(2009-12)</a></li>
    
        <li><a href="/articles/0027/0027-index.html">0027号(2009-09)</a></li>
    
        <li><a href="/articles/0026/0026-index.html">0026号(2009-06)</a></li>
    
        <li><a href="/articles/0025/0025-index.html">0025号(2009-02)</a></li>
    
        <li><a href="/articles/0024/0024-index.html">0024号(2008-10)</a></li>
    
        <li><a href="/articles/0023/0023-index.html">0023号(2008-03)</a></li>
    
        <li><a href="/articles/0022/0022-index.html">0022号(2007-12)</a></li>
    
        <li><a href="/articles/0021/0021-index.html">0021号(2007-09)</a></li>
    
        <li><a href="/articles/0020/0020-index.html">0020号(2007-08)</a></li>
    
        <li><a href="/articles/0019/0019-index.html">0019号(2007-05)</a></li>
    
        <li><a href="/articles/0018/0018-index.html">0018号(2007-02)</a></li>
    
        <li><a href="/articles/0017/0017-index.html">0017号(2006-11)</a></li>
    
        <li><a href="/articles/0016/0016-index.html">0016号(2006-09)</a></li>
    
        <li><a href="/articles/0015/0015-index.html">0015号(2006-07)</a></li>
    
        <li><a href="/articles/rubykaigi2006/RubyKaigi2006-index.html">日本 Ruby カンファレンス 2006 特別号</a></li>
    
        <li><a href="/articles/0014/0014-index.html">0014号(2006-05)</a></li>
    
        <li><a href="/articles/0013/0013-index.html">0013号(2006-02)</a></li>
    
        <li><a href="/articles/0012/0012-index.html">0012号(2005-12)</a></li>
    
        <li><a href="/articles/0011/0011-index.html">0011号(2005-11)</a></li>
    
        <li><a href="/articles/0010/0010-index.html">0010号(2005-10)</a></li>
    
        <li><a href="/articles/0009/0009-index.html">0009号(2005-09)</a></li>
    
        <li><a href="/articles/0008/0008-index.html">0008号(2005-07)</a></li>
    
        <li><a href="/articles/0007/0007-index.html">0007号(2005-06)</a></li>
    
        <li><a href="/articles/0006/0006-index.html">0006号(2005-05)</a></li>
    
        <li><a href="/articles/0005/0005-index.html">0005号(2005-02)</a></li>
    
        <li><a href="/articles/0004/0004-index.html">0004号(2004-12)</a></li>
    
        <li><a href="/articles/0003/0003-index.html">0003号(2004-11)</a></li>
    
        <li><a href="/articles/0002/0002-index.html">0002号(2004-10)</a></li>
    
        <li><a href="/articles/0001/0001-index.html">0001号(2004-09)</a></li>
    
</ul>
<p class="rss-subscribe"><a href="/feed.xml">RSS</a></p>

            </div>
            <div class="col-md-11 main">
                <img src="/images/rubima_logo_l.png">
                <h1>RubyOnRails を使ってみる 【第 3 回】 ActiveRecord</h1>
                <div class="social-buttons">
                    <a href="http://b.hatena.ne.jp/entry//articles/0006/0006-RubyOnRails.html" class="hatena-bookmark-button" data-hatena-bookmark-title="RubyOnRails を使ってみる 【第 3 回】 ActiveRecord" data-hatena-bookmark-layout="simple-balloon" title="このエントリーをはてなブックマークに追加"><img src="https://b.st-hatena.com/images/entry-button/button-only@2x.png" alt="このエントリーをはてなブックマークに追加" width="20" height="20" style="border: none;" /></a><script type="text/javascript" src="https://b.st-hatena.com/js/bookmark_button.js" charset="utf-8" async="async"></script>
<span id="fb-root"></span>
<script>(function(d, s, id) {
  var js, fjs = d.getElementsByTagName(s)[0];
  if (d.getElementById(id)) return;
  js = d.createElement(s); js.id = id;
  js.src = "//connect.facebook.net/ja_JP/sdk.js#xfbml=1&version=v2.5";
  fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));</script>
<span class="fb-like" data-href="/articles/0006/0006-RubyOnRails.html" data-layout="button_count" data-action="like" data-show-faces="false" data-share="false"></span>
<a href="https://twitter.com/share" class="twitter-share-button" data-url="/articles/0006/0006-RubyOnRails.html" data-text="RubyOnRails を使ってみる 【第 3 回】 ActiveRecord">ツイート</a>
<script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');</script>

                </div>
                <p>もりきゅうです。</p>

<p>今回は Ruby on Rails (以下 RoR) を構成するライブラリ群のうち ActiveRecord について掘り下げていきます。</p>

<p>ActiveRecord (以下 AR) は <a href="http://jp.rubyist.net/magazine/?0004-RLR">RLR 第 4 回</a> に取り上げられたように、Ruby での O/R マッピングライブラリのひとつです。
AR を使えば、簡単かつ効率的にリレーショナルデータベース上の情報を Ruby オブジェクトとして扱うことができます。その理論的なところは <a href="http://www.martinfowler.com/eaaCatalog/activeRecord.html">P of EAA: Active Record</a> を見ていただくことにして、ここではその実際的な使い方を見ていきます。</p>

<p>さて、RoR は非常に早く進化してきましたが、コアはそれほど変わっていません。
AR も使い方はそうそう変わらないだろうと思いますので、一通りその機能を見ていきたいと思います。</p>

<p>今回は、チュートリアルではなく主にリファレンスとして、AR に関する情報を日本語で提供できるように書いてみました。</p>

<p>はじめに、RoR と切り離して AR を使うための簡単なサンプルを紹介します。
次に、AR のソース構造を概観し、AR の test を読んでいきます。</p>

<p>後半はマニュアルの翻訳を試みました。
関連のうち、特に has_many と belongs_to について、生成されるメソッドを概観します。
そして callback, validation といったよく使う機能を見ていきます。
最後に、AR クラス・オブジェクトのリファレンスを載せました。</p>

<p>なお、今回は activerecord-1.10.1 を対象としています。</p>

<h2 id="おさらい">おさらい</h2>

<p>AR オブジェクトの基本的な扱い方を簡単におさらいしておきましょう。</p>

<p>RoR は全て含めると非常に大きいので、なかなか把握しづらいかもしれません。
そこで、今回は AR を単体で使ってみることにします。
AR を RoR から独立したひとつのライブラリとして扱います。</p>

<h3 id="database-table-の準備">database, table の準備</h3>

<p>ここでは RDBMS として MySQL を使うことにします。</p>

<p>rubima という database に rails という user で接続するとします。</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text"> CREATE DATABASE rubima;
 grant all on rubima.* to rails@localhost;</code></pre></figure>

<p>users table を作ります。</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text"> use rubima;
 CREATE TABLE users (
   id int unsigned not null auto_increment,
   name varchar(50),
   occupation varchar(50),
   primary key (id)
 );</code></pre></figure>

<h3 id="ar-で接続">AR で接続</h3>

<p>DB の準備ができました。AR で接続してみましょう。</p>

<ul>
  <li>ar.rb:</li>
</ul>

<figure class="highlight"><pre><code class="language-text" data-lang="text"> # gem を使わない場合
 # require 'active_record'

 # gem を使う場合
 require 'rubygems'
 require_gem 'activerecord'

 ActiveRecord::Base.establish_connection(
   :adapter =&gt; 'mysql',
   :host =&gt; 'localhost',
   :username =&gt; 'rails',
   :password =&gt; '',
   :database =&gt; 'rubima'
 )

 class User &lt; ActiveRecord::Base
 end</code></pre></figure>

<h3 id="new---作成">new - 作成</h3>

<p>AR オブジェクトを作るには new メソッドを使います。</p>

<blockquote>
  <p>create メソッドを使うこともできます。create は new したあと save (DB に格納) します。</p>
</blockquote>

<p>引数として、カラム名と値をハッシュにして与えます。</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text"> user = User.new(:name =&gt; "David", :occupation =&gt; "Code Artist")
 p user.name # =&gt; "David"</code></pre></figure>

<p>また、ブロックを使うこともできます。</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text"> user = User.new do |u|
   u.name = "David"
   u.occupation = "Code Artist"
 end</code></pre></figure>

<p>もちろん、作ってから値を設定してもいいです。</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text"> user = User.new
 user.name = "David"
 user.occupation = "Code Artist"</code></pre></figure>

<p>なお、new で作った AR オブジェクトは</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text"> user.save</code></pre></figure>

<p>のように save するまでは DB に格納されません。</p>

<h3 id="find---検索抽出">find - 検索・抽出</h3>

<p>検索・抽出を行うには find メソッドを使います。</p>

<blockquote>
  <p>find のほか find_first, find_all, find_by_sql といったメソッドがあります。</p>
</blockquote>

<p>base.rb から例を引用しておきます。
オプションの意味を理解するには若干 SQL の知識が必要です。
詳細は<a href="http://ar.rubyonrails.com/">マニュアル</a>を読んでください。</p>

<p>id で検索する例:</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text"> Person.find(1)       # returns the object for ID = 1
 Person.find(1, 2, 6) # returns an array for objects with IDs in (1, 2, 6)
 Person.find([7, 17]) # returns an array for objects with IDs in (7, 17)
 Person.find([1])     # returns an array for objects the object with ID = 1
 Person.find(1, :conditions =&gt; "administrator = 1", :order =&gt; "created_on DESC")</code></pre></figure>

<p>find first の例:</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text"> Person.find(:first) # returns the first object fetched by SELECT * FROM people
 Person.find(:first, :conditions =&gt; [ "user_name = ?", user_name])
 Person.find(:first, :order =&gt; "created_on DESC", :offset =&gt; 5)</code></pre></figure>

<p>find all の例:</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text"> Person.find(:all) # returns an array of objects for all the rows fetched by SELECT * FROM people
 Person.find(:all, :conditions =&gt; [ "category IN (?)", categories], :limit =&gt; 50)
 Person.find(:all, :offset =&gt; 10, :limit =&gt; 10)
 Person.find(:all, :include =&gt; [ :account, :friends ])</code></pre></figure>

<h4 id="パラメータ-プレースフォルダ">パラメータ (プレースフォルダ)</h4>

<p>クエリに変数を適用するときには、直接 #{} で文字列の中に埋め込むのではなく、パラメータとして渡したほうが安全です。
例えば (base.rb 参照) user_name と password 変数を埋め込むとします。</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text"> User &lt; ActiveRecord::Base
   def self.authenticate_unsafely(user_name, password)
     find_first("user_name = '#{user_name}' AND password = '#{password}'")
   end

   def self.authenticate_safely(user_name, password)
     find_first([ "user_name = ? AND password = ?", user_name, password ])
   end
 end</code></pre></figure>

<p>authenticate_unsafely のように書いたとき、user_name や password にエスケープされていない引用符を含めることができれば、任意のSQLを実行させることができてしまいます。
このようなときは authenticate_safely のように ? を用いて値を渡しましょう。
? に渡った値はサニタイズされます (文字列ならエスケープされて引用符で囲まれます)。</p>

<h4 id="名前付きパラメータ">名前付きパラメータ</h4>

<p>? がたくさん付くようになると、パラメータの順序を覚えるのがうっとおしくなります。
このようなときは ? の代わりに :名前 を使ってパラメータに名前を付けると良いでしょう。
このときは対応する値をハッシュで与えます。</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text"> Company.find(:first, [
   "id = :id AND name = :name AND division = :division AND created_at &gt; :accounting_date",
   { :id =&gt; 3, :name =&gt; "37signals", :division =&gt; "First", :accounting_date =&gt; '2005-01-01' }
 ])</code></pre></figure>

<h2 id="ar-の構成">AR の構成</h2>

<p>AR を理解する第一歩として、まず AR の構成を知るところから始めましょう。</p>

<h3 id="ライブラリの構成">ライブラリの構成</h3>

<p>まず、ディレクトリ構造を見てみましょう。</p>

<p>ソースツリーは次のようになっています。</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text"> activerecord-1.10.1/
   examples/
   lib/
   test/</code></pre></figure>

<p>lib/ を見てください。</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text"> lib/
   active_record/
     acts/
     associations/
     connection_adapters/
     vendor/
     wrappers/</code></pre></figure>

<p>acts/ は list, tree といったデータ構造を AR で実現するための拡張です。
詳細はマニュアルをご覧ください。</p>

<p>associations/ は lib/associations.rb が読み込みます。
ここでは外部キーに基づく関連 (relationship) を実装しています。
belongs_to, has_one, has_many, has_and_belongs_to_many といった関連の定義はここにあります。</p>

<p>connection_adapters/ では DB アダプタを実装しています。</p>

<p>vendor/ には RoR の外部から提供されているライブラリが置かれています。</p>

<p>wrappers/ にはカラム値の変換プラグインが置かれています。今のところ YAML だけです。</p>

<p>さて、require ‘active_record’ あるいは require_gem ‘activerecord’ したときに読み込まれるのは lib/active_record.rb です。このファイルを見てみましょう。
すると、fixtures.rb 以外のファイルはすべてここで require され、各 module が ActiveRecord::Base.class_eval の中で include されていることが分かります。</p>

<p>そして、各 module には次のような仕掛けがあります。
例えば validations.rb:</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text"> module Validations
 ...
   def self.append_features(base) # :nodoc:
     super
     base.extend ClassMethods
     base.class_eval do
       alias_method :save_without_validation, :save
       alias_method :save, :save_with_validation

       alias_method :update_attribute_without_validation_skipping, :update_attribute
       alias_method :update_attribute, :update_attribute_with_validation_skipping
     end
   end
 ...
   module ClassMethods</code></pre></figure>

<p>self.append_features(base) は include 時に呼ばれるのでしたね。
そして module ClassMethods は base.extend されているので、ここで定義されたメソッドは base (= ActiveRecord::Base) のクラスメソッドとして扱われます。ライブラリを分割する手法として非常に参考になります。</p>

<p>また、validations.rb では alias_method を使ってメソッドを置き換えています。</p>

<p>結局、module の多くは ActiveRecord::Base クラスに対する定義になっています。</p>

<h3 id="ar-test-を読む">AR test を読む</h3>

<p>AR を単体として見るために、AR 自身の test を取り上げます。</p>

<p>AR には RDoc で生成された良くできたマニュアルが付いていますが、それでもソースを読む価値は常にあります。
AR はテスト駆動で作られているため、test に AR の仕様が具体的にコードの形で表われます。
test を読むと、仕様の微妙な箇所や実装の妥協点がよく分かります。</p>

<p>test を読むとっかかりとして、本稿では connection.rb と Topic, Reply クラスだけ解説します。</p>

<ul>
  <li>activerecord-1.10.1/RUNNING_UNIT_TESTS:</li>
</ul>

<figure class="highlight"><pre><code class="language-text" data-lang="text">  cd test; ruby -I "connections/native_mysql" base_test.rb</code></pre></figure>

<p>-I “connections/native_mysql” は $: の設定であり、require ‘connection’ が読み込む connection.rb のパスを指定しています。</p>

<h4 id="connections">connections</h4>

<p>ここでは MySQL アダプタを用いる例を見ていきますが、どのアダプタでも基本は同じです。</p>

<ul>
  <li>connections/native_mysql/connection.rb:</li>
</ul>

<figure class="highlight"><pre><code class="language-text" data-lang="text"> print "Using native MySQL\n"
 require 'fixtures/course'
 require 'logger'

 ActiveRecord::Base.logger = Logger.new("debug.log")

 db1 = 'activerecord_unittest'
 db2 = 'activerecord_unittest2'

 ActiveRecord::Base.establish_connection(
   :adapter  =&gt; "mysql",
   :host     =&gt; "localhost",
   :username =&gt; "rails",
   :password =&gt; "",
   :database =&gt; db1
 )

 Course.establish_connection(
   :adapter  =&gt; "mysql",
   :host     =&gt; "localhost",
   :username =&gt; "rails",
   :password =&gt; "",
   :database =&gt; db2
 )</code></pre></figure>

<p>ここで require ‘fixtures/course’; db2 = ‘activerecord_unittest2’; Course.establish_connection といった部分は、複数のDBを関連付けて扱う multiple_db_test.rb で使われます。この機能については今回取り上げません。詳細は multiple_db_test.rb を読んでください。</p>

<p>なので、今回扱う範囲では、connection.rb は次のもので十分です。</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text"> print "Using native MySQL\n"
 require 'logger'

 ActiveRecord::Base.logger = Logger.new("debug.log")

 db1 = 'activerecord_unittest'

 ActiveRecord::Base.establish_connection(
   :adapter  =&gt; "mysql",
   :host     =&gt; "localhost",
   :username =&gt; "rails",
   :password =&gt; "",
   :database =&gt; db1
 )</code></pre></figure>

<p>ここで logger を除いてみると、ここで行っているのは ActiveRecord::Base.establish_connection の呼び出しのみということになります。
establish_connection は引数を見て分かるとおり、DBに接続して、その接続を維持します。これ以降、この接続は ActiveRecord::Base.connection で参照できます。</p>

<h4 id="abstract_unitrb">abstract_unit.rb</h4>

<p>次に base_test.rb を見ると、頭に require ‘abstract_unit’ があります。</p>

<ul>
  <li>abstract_unit.rb:</li>
</ul>

<figure class="highlight"><pre><code class="language-text" data-lang="text"> $:.unshift(File.dirname(__FILE__) + '/../lib')
 $:.unshift(File.dirname(__FILE__) + '/../../activesupport/lib')

 require 'test/unit'
 require 'active_record'
 require 'active_record/fixtures'
 require 'active_support/binding_of_caller'
 require 'active_support/breakpoint'
 require 'connection'

 class Test::Unit::TestCase #:nodoc:
   def create_fixtures(*table_names)
     if block_given?
       Fixtures.create_fixtures(File.dirname(__FILE__) + "/fixtures/", table_names) { yield }
     else
       Fixtures.create_fixtures(File.dirname(__FILE__) + "/fixtures/", table_names)
     end
   end
 end

 Test::Unit::TestCase.fixture_path = File.dirname(__FILE__) + "/fixtures/"</code></pre></figure>

<p>ここではライブラリの require を行っています。require ‘connection’ もここにあります。</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text"> require 'test/unit'</code></pre></figure>

<p>これはみなさんお馴染みの Test::Unit ライブラリです。</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text"> require 'active_record'
 require 'active_record/fixtures'</code></pre></figure>

<p>ここで AR ライブラリを読み込んでいます。
fixtures だけ別になっています。fixtures は test のみで使われるからです。</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text"> require 'active_support/binding_of_caller'
 require 'active_support/breakpoint'</code></pre></figure>

<p>これはデバッグ用のライブラリです。
binding_of_caller, breakpoint の詳細は複雑かつ興味深いものですが、今回は避けます。</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text"> require 'connection'</code></pre></figure>

<p>ここで先の connection.rb を読み込みます。</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text"> class Test::Unit::TestCase #:nodoc:
   def create_fixtures(*table_names)</code></pre></figure>

<p>create_fixtures を定義していますが、現在は create_fixtures よりも fixtures を使うのが普通です。</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text"> Test::Unit::TestCase.fixture_path = File.dirname(__FILE__) + "/fixtures/"</code></pre></figure>

<p>fixtures のパスはこのように指定します。</p>

<p>ここまで特に難しくはないですね。</p>

<p>base_test.rb に戻ります。</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text"> require 'fixtures/topic'
 require 'fixtures/reply'</code></pre></figure>

<h4 id="topicrb">topic.rb</h4>

<ul>
  <li>fixtures/topic.rb:</li>
</ul>

<figure class="highlight"><pre><code class="language-text" data-lang="text"> class Topic &lt; ActiveRecord::Base
   has_many :replies, :dependent =&gt; true, :foreign_key =&gt; "parent_id"
   serialize :content

   before_create  :default_written_on
   before_destroy :destroy_children

   def parent
     self.class.find(parent_id)
   end

   protected
     def default_written_on
       self.written_on = Time.now unless attribute_present?("written_on")
     end

     def destroy_children
       self.class.delete_all "parent_id = #{id}"
     end
 end</code></pre></figure>

<p>これも、もうみなさんは見慣れたであろう ActiveRecord::Base から継承した AR クラスの定義です。
普段は、script/generator model で作っておくファイルですね。</p>

<p>この Topic クラスでは、いくつかARの機能が見て取れます。</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text"> has_many :replies, :dependent =&gt; true, :foreign_key =&gt; "parent_id"</code></pre></figure>

<p>has_many は1対多の関連付けに用います。
普通はふたつのテーブルを使いますが、Topic は Reply と共に <a href="http://www.martinfowler.com/eaaCatalog/singleTableInheritance.html">Single table inheritance</a> を構成します。
<img src="/images/0006-RubyOnRails/topics.png" alt="topics.png" /></p>

<ul>
  <li>:dependent =&gt; true</li>
</ul>

<p>親 (Topic) を削除するときは子 (Reply) も削除するという指定です。</p>

<ul>
  <li>:foreign_key =&gt; “parent_id”</li>
</ul>

<p>外部キーを parent_id にします。:foreign_key を省略したときは、外部キーの名前は相手のテーブル名から作られます。 逆に言うと、キー名を自由に決めていいときは、AR の仕様に合わせて名前を決めたほうがいいでしょう。</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text">   serialize :content</code></pre></figure>

<p>content を YAML 形式で格納します。</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text">   before_create  :default_written_on
   before_destroy :destroy_children</code></pre></figure>

<p>コールバックです。create, destroy 時に実行するメソッドを指定しています。</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text">   def parent</code></pre></figure>

<p>これは Topic から継承する Reply クラスで使うことを想定しているものと考えられます。
Reply ではない Topic では parent_id は nil のはずですから、find は常に失敗します。</p>

<h4 id="dbスキーマ">DBスキーマ</h4>

<p>ここで Topic に対応するDBスキーマを見ておきましょう。
MySQL のものは以下にあります。</p>

<ul>
  <li>fixtures/db_definitions/mysql.sql:</li>
</ul>

<figure class="highlight"><pre><code class="language-text" data-lang="text"> CREATE TABLE `topics` (
   `id` int(11) NOT NULL auto_increment,
   `title` varchar(255) default NULL,
   `author_name` varchar(255) default NULL,
   `author_email_address` varchar(255) default NULL,
   `written_on` datetime default NULL,
   `bonus_time` time default NULL,
   `last_read` date default NULL,
   `content` text,
   `approved` tinyint(1) default 1,
   `replies_count` int(11) default 0,
   `parent_id` int(11) default NULL,
   `type` varchar(50) default NULL,
   PRIMARY KEY  (`id`)
 ) TYPE=InnoDB;</code></pre></figure>

<p>注目したいのは replies_count, parent_id, type カラムです。これらは Reply との関係で使われます。
type カラムはクラス名を格納します。これは Single table inheritance の肝です。
id カラムは auto_increment な primary key です。
そのほかのカラムは単純な値の入れ物です。</p>

<h4 id="replyrb">reply.rb</h4>

<p>topic.rb で何度も Reply について言及しましたので、reply.rb も合わせて見ておきましょう。</p>

<ul>
  <li>fixtures/reply.rb:</li>
</ul>

<figure class="highlight"><pre><code class="language-text" data-lang="text"> class Reply &lt; Topic
   belongs_to :topic, :foreign_key =&gt; "parent_id", :counter_cache =&gt; true
   has_many :silly_replies, :dependent =&gt; true, :foreign_key =&gt; "parent_id"

   validate :errors_on_empty_content
   validate_on_create :title_is_wrong_create

   attr_accessible :title, :author_name, :author_email_address, :written_on, :content, :last_read

   def validate
     errors.add("title", "Empty")   unless attribute_present? "title"
   end

   def errors_on_empty_content
     errors.add("content", "Empty") unless attribute_present? "content"
   end

   def validate_on_create
     if attribute_present?("title") &amp;&amp; attribute_present?("content") &amp;&amp; content == "Mismatch"
       errors.add("title", "is Content Mismatch")
     end
   end

   def title_is_wrong_create
     errors.add("title", "is Wrong Create") if attribute_present?("title") &amp;&amp; title == "Wrong Create"
   end

   def validate_on_update
     errors.add("title", "is Wrong Update") if attribute_present?("title") &amp;&amp; title == "Wrong Update"
   end
 end

 class SillyReply &lt; Reply
 end</code></pre></figure>

<figure class="highlight"><pre><code class="language-text" data-lang="text">   belongs_to :topic, :foreign_key =&gt; "parent_id", :counter_cache =&gt; true</code></pre></figure>

<p>belongs_to は関連するふたつのテーブルのうち association id を持つテーブル側に指定する関連付けでしたね。</p>

<ul>
  <li>:foreign_key =&gt; “parent_id”</li>
</ul>

<p>topics table は parent_id を association id として、ひとつのテーブルで継承関係を作ります。</p>

<ul>
  <li>:counter_cache =&gt; true</li>
</ul>

<p>この指定により replies_count カラムを自動的に更新します。</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text">   validate :errors_on_empty_content
   validate_on_create :title_is_wrong_create
   def validate
   def validate_on_create
   def validate_on_update</code></pre></figure>

<p>これらは validation と呼ばれる機能です。値のチェックを行います。</p>

<p>ActiveRecord::Base#attribute_present?(カラム名) は、カラムが存在してかつ nil? でも empty? でもない、ようするに、値を持っていることを確認します。</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text">   attr_accessible :title, :author_name, :author_email_address, :written_on, :content, :last_read</code></pre></figure>

<p>attr_accessible は、アクセスできるカラム名を (緩やかに) 制限します。attr_protected と対になります。</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text">   has_many :silly_replies, :dependent =&gt; true, :foreign_key =&gt; "parent_id"

 class SillyReply &lt; Reply
 end</code></pre></figure>

<p>Reply からさらに継承しています。Topic から見ると二段階の has_many になります。</p>

<p>参考: 特に一般化したリスト構造やツリー構造を扱う際には acts mixin が使えます。</p>

<p>base_test.rb ではほかにも多くのテーブルを扱っていますが、とりあえず Topic と Reply で留めておきます。
base_test.rb の test を読むと、AR の仕様が見えてくると思います。</p>

<p>以降は、関連、コールバック、validation について、マニュアルを読みつつ見ていきます。</p>

<h2 id="associations">associations</h2>

<p>Topic, Reply を元に、AR の関連 (relationship) についてまとめてみます。</p>

<p>Topic, Reply は AR クラスです。よって new, find など AR クラスのメソッドは全て使えます。</p>

<p>さらに has_many, belongs_to の指定によってメソッドが追加されます。</p>

<h3 id="has_many">has_many</h3>

<p>Topic クラスで has_many :replies を宣言すると、次のメソッドが追加されます。</p>

<h4 id="topicrepliesforce_reload--false">Topic#replies(force_reload = false)</h4>

<p>関連付けられた reply の配列を返します。
もし reply がなければ空配列を返します。</p>

<p>Reply を使えば</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text"> Reply.find :all, :conditions =&gt; "parent_id = #{topic.id}"</code></pre></figure>

<p>と書けます。</p>

<p>Topic#replies の結果はキャッシュされます。
同じ topic で再度 topic.replies を呼び出したときはキャッシュされた値が返ります。
force_reload = true にすると、リロードします (キャッシュを削除して DB から読み直します)。</p>

<h4 id="topicrepliesreply-">Topic#replies&lt;&lt;(reply, …)</h4>

<p>指定された reply を追加します。</p>

<p>DB 上は外部キーに topic.id を設定します。</p>

<h4 id="topicrepliesdeletereply-">Topic#replies.delete(reply, …)</h4>

<p>指定された reply を取り除きます。</p>

<p>DB 上は外部キーに NULL を設定します。</p>

<p>もし :dependent =&gt; true であれば reply は destroy されます。</p>

<h4 id="topicrepliesclear">Topic#replies.clear</h4>

<p>全ての reply を取り除きます。ただし reply は destroy されません。</p>

<h4 id="topicrepliesempty">Topic#replies.empty?</h4>

<p>reply がなければ真を返します。</p>

<p>これは</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text"> Topic#replies.size == 0</code></pre></figure>

<p>と同等です。</p>

<h4 id="topicrepliessize">Topic#replies.size</h4>

<p>reply の個数を返します。</p>

<p>Reply を使えば</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text"> Reply.count("parent_id = #{topic.id}")</code></pre></figure>

<p>と書けます。</p>

<p>counter_cache が有効であればキャッシュの値が使われます。</p>

<h4 id="topicrepliesfind">Topic#replies.find(…)</h4>

<p>reply を検索・抽出します。
引数は Base.find と同じ規則です。</p>

<p>Reply を使えば</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text"> Reply.find(id, :conditions =&gt; "parent_id = #{topic.id}")</code></pre></figure>

<p>と書けます。</p>

<h4 id="topicrepliesbuildattributes--">Topic#replies.build(attributes = {})</h4>

<p>新たな reply オブジェクトを生成します。
引数は Base.new と同じ規則です。</p>

<p>new と同様、すぐに save はされません。</p>

<p>Reply を使えば</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text"> Reply.new("parent_id" =&gt; topic.id)</code></pre></figure>

<p>と書けます。</p>

<h4 id="topicrepliescreateattributes--">Topic#replies.create(attributes = {})</h4>

<p>新たな reply オブジェクトを生成し、save します (validation チェックは行います)。</p>

<p>Reply を使えば</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text"> reply = Reply.new("parent_id" =&gt; topic.id)
 reply.save
 reply</code></pre></figure>

<p>あるいは</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text"> Reply.create("parent_id" =&gt; topic.id)</code></pre></figure>

<p>と書けます。</p>

<h4 id="オプション">オプション</h4>

<p>has_many はオプションのハッシュをとることができます。</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text">   has_many :replies, :dependent =&gt; true, :foreign_key =&gt; "parent_id"</code></pre></figure>

<p>全て書く余白がないので ;)、オプションについては割愛します。</p>

<h3 id="belongs_to">belongs_to</h3>

<p>Reply クラスで belongs_to :topic を宣言すると、次のメソッドが追加されます。</p>

<h4 id="replytopicforce_reload--false">Reply#topic(force_reload = false)</h4>

<p>関連付けられた topic を返します。なければ nil を返します。</p>

<h4 id="replytopictopic">Reply#topic=(topic)</h4>

<p>topic を関連付けます。DB 上は外部キーに topic.id を設定します。</p>

<h4 id="replybuild_topicattributes--">Reply#build_topic(attributes = {})</h4>

<p>新たな topic を生成し、そして、この reply を関連付けます。
save しません。</p>

<h4 id="replycreate_topicattributes--">Reply#create_topic(attributes = {})</h4>

<p>新たな topic を生成し、そして、この reply を関連付けます。
save します。</p>

<h4 id="オプション-1">オプション</h4>

<p>belongs_to はオプションのハッシュをとることができます。</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text">   belongs_to :topic, :foreign_key =&gt; "parent_id", :counter_cache =&gt; true</code></pre></figure>

<p>詳しくはマニュアルをご覧ください。</p>

<h2 id="callbacks">callbacks</h2>

<p>(callbacks.rb の部分的な翻訳です)</p>

<p>(new_record な) AR オブジェクトを save するときに呼ばれるコールバックは次の通りです。</p>

<ul>
  <li>(-) save</li>
  <li>(-) valid?</li>
  <li>(1) before_validation</li>
  <li>(2) before_validation_on_create</li>
  <li>(-) validate</li>
  <li>(-) validate_on_create</li>
  <li>(4) after_validation</li>
  <li>(5) after_validation_on_create</li>
  <li>(6) before_save</li>
  <li>(7) before_create</li>
  <li>(-) create</li>
  <li>(8) after_create</li>
  <li>(9) after_save</li>
</ul>

<p>9 つのコールバックがありますね。
コールバックは、Active Record ライフサイクルのそれぞれの状態に反応し準備するための、とても大きな力となります。</p>

<p>コールバックの例:</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text"> class CreditCard &lt; ActiveRecord::Base
   # Strip everything but digits, so the user can specify "555 234 34" or
   # "5552-3434" or both will mean "55523434"
   def before_validation_on_create
     self.number = number.gsub(/[^0-9]/, "") if attribute_present?("number")
   end
 end

 class Subscription &lt; ActiveRecord::Base
   before_create :record_signup

   private
     def record_signup
       self.signed_up_on = Date.today
     end
 end

 class Firm &lt; ActiveRecord::Base
   # Destroys the associated clients and people when the firm is destroyed
   before_destroy { |record| Person.destroy_all "firm_id = #{record.id}"   }
   before_destroy { |record| Client.destroy_all "client_of = #{record.id}" }
 end</code></pre></figure>

<h3 id="継承可能なコールバックキュー">継承可能なコールバックキュー</h3>

<p>上書き可能なコールバックメソッドに加えて、コールバックマクロでコールバックを登録できます。
その主な利点は、マクロは継承階層の影響を受けずにコールバックキューに振る舞いを追加できることです。</p>

<p>例えば:</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text"> class Topic &lt; ActiveRecord::Base
   before_destroy :destroy_author
 end

 class Reply &lt; Topic
   before_destroy :destroy_readers
 end</code></pre></figure>

<p>さて、
Topic#destroy を実行すると、destroy_author だけ呼ばれます。
Reply#destroy を実行すると、destroy_author と destroy_readers が呼ばれます。</p>

<p>同じ振る舞いを、上書き可能なメソッドで実装した場合と比較してみましょう。</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text"> class Topic &lt; ActiveRecord::Base
   def before_destroy() destroy_author end
 end

 class Reply &lt; Topic
   def before_destroy() destroy_readers end
 end</code></pre></figure>

<p>こうすると、Reply#destroy は destroy_readers だけ実行し、destroy_author は実行しません。</p>

<p>なので、
あるコールバックが全階層で呼ばれることを保証したいときには、コールバックマクロを使い、
それぞれの派生先で留めたいときは、上書きメソッドを使えばいいでしょう。
上書きメソッドは、super を呼んで派生元のコールバックを行うか決めることができます。</p>

<p>重要: 
継承関係がコールバックキューに対して正しく働くためには、
関連を指定する前にコールバックを指定する必要があります。
そうしないと、コールバックを登録している親の前に子を load したときに、継承されません。</p>

<h3 id="コールバックのタイプ">コールバックのタイプ</h3>

<p>コールバックには 4 つのタイプがあります。</p>

<ul>
  <li>メソッドリファレンス (symbol)</li>
  <li>コールバックオブジェクト</li>
  <li>インラインメソッド (proc を使います)</li>
  <li>インライン eval メソッド (string を使います)</li>
</ul>

<p>メソッドリファレンスとコールバックオブジェクトは、推奨されるアプローチです。
proc を使ったインラインメソッドは、ときには適しています (例えば mix-in するとき)。
インライン eval メソッドは推奨されません。</p>

<h3 id="after_find-と-after_initialize-の扱い">after_find と after_initialize の扱い</h3>

<p>after_find と after_initialize は、パフォーマンスの制約から、(def after_find のように) 明確に定義されたときだけ実行されます。</p>

<h3 id="コールバックのキャンセル">コールバックのキャンセル</h3>

<p>bafore_* の戻り値を false にすると、それ以降のコールバック全てと、そのコールバックに関連付けられたアクションがキャンセルされます。
after_* の戻り値を false にすると、それ以降のコールバック全てがキャンセルされます。</p>

<p>コールバックは定義された順に呼ばれますが、モデル上にメソッドとして定義されたコールバックは最後に呼ばれます。</p>

<h2 id="validations">validations</h2>

<p>(validations.rb の部分的な翻訳です)</p>

<p>AR オブジェクトは Base#validate (あるいは validate_on_create validate_on_update) を上書きすることで validation を実装できます。
これらのメソッドは、オブジェクトの状態を検査でき、カラムがある値を持つこと (empty でない、範囲内にある、ある正規表現にマッチするといったようなこと) を保証できます。</p>

<p>validation の例:</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text"> class Person &lt; ActiveRecord::Base
   protected
     def validate
       errors.add_on_empty %w( first_name last_name )
       errors.add("phone_number", "has invalid format") unless phone_number =~ /[0-9]*/
     end

     def validate_on_create # is only run the first time a new object is saved
       unless valid_discount?(membership_discount)
         errors.add("membership_discount", "has expired")
       end
     end

     def validate_on_update
       errors.add_to_base("No changes have occurred") if unchanged_attributes?
     end
 end

 person = Person.new("first_name" =&gt; "David", "phone_number" =&gt; "what?")
 person.save                         # =&gt; false (and doesn't do the save)
 person.errors.empty?                # =&gt; false
 person.count                        # =&gt; 2
 person.errors.on "last_name"        # =&gt; "can't be empty"
 person.errors.on "phone_number"     # =&gt; "has invalid format"
 person.each_full { |msg| puts msg } # =&gt; "Last name can't be empty\n" +
                                          "Phone number has invalid format"

 person.attributes = { "last_name" =&gt; "Heinemeier", "phone_number" =&gt; "555-555" }
 person.save # =&gt; true (and person is now saved in the database)</code></pre></figure>

<p>errors オブジェクトは、それぞれの AR オブジェクトに対して自動的に生成されます。
より高度な validation については ActiveRecord::Validations::ClassMethods をご覧ください。</p>

<h2 id="actionpack-と絡めた話">ActionPack と絡めた話</h2>

<p>ActiveRecord は ActionPack から独立していますが、連携させて用いることが多いです。
ここでは ActionPack の ActiveRecord 対応機能をいくつか取り上げます。</p>

<h3 id="validation-と-template">validation と template</h3>

<p>ActionController の create, update action で AR オブジェクトを save するときに、値をチェックしたいことがあります。</p>

<p>値をチェックするには、モデルクラスに validation メソッドを定義して、
望ましくない値を持つ場合に errors.add(カラム名, メッセージ) でエラーを追加します。</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text">   def validate
     errors.add("code", "重複しています") if ...
   end</code></pre></figure>

<p>errors が存在すると (errors.empty? でないと) save に失敗することになります (ActiveRecord::Base#save が false を返します)。
ActionController 側では、普通、save に成功すれば redirect_to し、失敗すれば render で元のページを表示します。</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text">    if @customer.save
      redirect_to :action =&gt; "show", :id =&gt; @customer.id
    else
      render_action "edit"
    end</code></pre></figure>

<p>errors.on(カラム名) は対応するメッセージを返します。そのカラム名に対応するエラーがないときは nil を返します。
これを編集用テンプレートに埋め込むと、save に失敗した理由を表示することができます。</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text">   &lt;tr&gt;
     &lt;th&gt;会員NO&lt;/th&gt;
     &lt;td&gt;&lt;%= text_field "customer", "code" %&gt;&lt;div&gt;&lt;%=h @customer.errors.on("code") %&gt;&lt;/div&gt;&lt;/td&gt;
   &lt;/tr&gt;</code></pre></figure>

<p>また、text_field といった helper メソッドは、カラム名に対応するエラーが存在するときにはタグを &lt;div class=”fieldWithErrors”&gt;…&lt;/div&gt; で囲みます。
これを利用すると、スタイルシートを使ってエラーの原因となった入力フォーム要素を目立たせることができます。</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text"> div.fieldWithErrors {
   background-color: red;
 }</code></pre></figure>

<h3 id="activerecordstore">ActiveRecordStore</h3>

<p>RoR の session 機能は CGI::Session を用いていて、標準では PStore を用いてファイルとして格納しています。
この格納方法は取り替えることができ、そのひとつに ActiveRecordStore があります。
これは session を AR オブジェクトとして扱い、DB に格納します。</p>

<h3 id="date-time-datetime">date, time, datetime</h3>

<p>date_helper を使うとひとつのカラムに対して複数の値を渡すことになります。
この複数の値をひとつにまとめているのは ActionPack でしょうか。それとも ActiveRecord でしょうか。
これは ActiveRecord です。
ActiveRecord::Base#attributes= がそれを実現しています。</p>

<h2 id="activerecord-リファレンス">ActiveRecord リファレンス</h2>

<h3 id="ar-クラス共通設定-名前">AR クラス共通設定 (名前)</h3>

<p>RoR は cattr_accessor という accessor 宣言を用意しています。
これはクラス変数用の attr_accessor です。
例えば、</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text"> module ActiveRecord
   class Base
     cattr_accessor :primary_key_prefix_type</code></pre></figure>

<p>とすれば、@@primary_key_prefix_type は</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text"> ActiveRecord::Base.primary_key_prefix_type
 ActiveRecord::Base.primary_key_prefix_type=</code></pre></figure>

<p>で読み書きできるようになります。</p>

<p>ここでは特に名前の設定に関するクラス変数をまとめておきます。</p>

<h4 id="primary_key_prefix_type--nil">@@primary_key_prefix_type = nil</h4>

<p>全てのプライマリキーカラム名の頭に付加する prefix のタイプを指定します。</p>

<p><em>:table_name</em> を指定すると、Product クラスはプライマリキーカラムとして “id” の代わりに “productid” を探します。</p>

<p><em>:table_name_with_underscore</em> を指定すると、Product クラスはプライマリキーカラムとして “id” の代わりに “product_id” を探します。</p>

<p>これは全 AR クラスに共通の設定になります。</p>

<h4 id="table_name_prefix--">@@table_name_prefix = “”</h4>

<p>全てのテーブル名の頭に付加する prefix 文字列を指定します。</p>

<p>“basecamp_” を設定すると、テーブル名は “basecamp_projects”, “basecamp_people” などとなります。
これは共有される DB の名前空間を作るのに便利です。</p>

<p>デフォルトは空文字列です。</p>

<h4 id="table_name_suffix--">@@table_name_suffix = “”</h4>

<p>table_name_prefix と同様に働きますが、頭ではなく後ろに付加されます (“_basecamp” を設定すると “projects_basecamp”, “people_basecamp” となります)。</p>

<p>デフォルトは空文字列です。</p>

<h4 id="pluralize_table_names--true">@@pluralize_table_names = true</h4>

<p>テーブル名をクラス名の複数形にするかを指定します。</p>

<p>true なら、Product クラスのデフォルトテーブル名は products になります。false なら、product になります。</p>

<p>table/class 名前付けの規則の詳細については、table_name を見てください。</p>

<p>デフォルトは true です。</p>

<h3 id="ar-クラスメソッド-削除-更新-カウント">AR クラスメソッド (削除, 更新, カウント)</h3>

<p>AR のクラスメソッドをまとめてみます。
ただし、ここでは base.rb で定義されているものだけ扱います。
すでに書いた new, create, find, find_* は除きます。</p>

<p>データ操作を行うメソッドは、おおまかにみて、SQL を直接扱うものと AR オブジェクトを通すものに区別できます。</p>

<h4 id="destroyid">destroy(id)</h4>

<h4 id="deleteid">delete(id)</h4>

<p>destroy と delete は、DB から該当行を削除します。
削除という意味ではどちらも同じですが、実行の仕方に違いがあります。</p>

<p>destory は find で得た AR オブジェクトを destroy します。このとき、AR のコールバックは全て働きます。
例えば、:dependent による子の削除は、コールバック (before_destroy) によって実現されているので、destroy したときに行われます。</p>

<p>delete は AR オブジェクトを生成せずに直接 SQL (delete from …) を発行します。
そのため、コールバックは働きません。:dependent による削除は行われません。</p>

<h4 id="destroy_allconditions">destroy_all(conditions)</h4>

<h4 id="delete_allconditions">delete_all(conditions)</h4>

<p>destroy_all, delete_all は、条件に合う行を削除します。
条件の書き方は find と同じです。</p>

<p>destroy_all, delete_all は destroy, delete と同じ関係にあります。</p>

<h4 id="updateid-attributes">update(id, attributes)</h4>

<p>update は、複数のカラムを更新し、save します。</p>

<p>update は find(id) して得られる AR オブジェクトに対して update_attributes(attributes) を行います。
update_attributes(attributes) は self.attributes = attributes して save します。戻り値は save の戻り値です。</p>

<h4 id="update_allupdates-conditions--nil">update_all(updates, conditions = nil)</h4>

<p>update_all は、直接 SQL を使った更新を行います。updates は SQL 文です。
delete_all と同様、直接 SQL (update …) を発行します。</p>

<h4 id="countconditions--nil-joins--nil">count(conditions = nil, joins = nil)</h4>

<h4 id="count_by_sqlsql">count_by_sql(sql)</h4>

<p>count は、条件に合う行数を返します。
直接 SQL (select count(*) from …) を発行します。joins は追加 SQL 文です。</p>

<p>count_by_sql は直接 SQL を発行します。sql は SQL 文で、select count(*) from … で書き始めます。
戻り値は、最初のカラムを to_i した値です。</p>

<h4 id="increment_countercounter_name-id">increment_counter(counter_name, id)</h4>

<h4 id="decrement_countercounter_name-id">decrement_counter(counter_name, id)</h4>

<p>increment_counter, decrement_counter は、カウンタとして扱うカラムの値を +1, -1 します。</p>

<p>update_all を用いて実現されています。直接 SQL を発行します。</p>

<h3 id="ar-クラスメソッド-属性">AR クラスメソッド (属性)</h3>

<p>上に書いたような SQL を用いたデータ操作のためのメソッドとは別に、Ruby レベルでの動作を設定するためのクラスメソッドがあります。
これらは AR のクラス定義で関数的に使います。</p>

<p>なお、Ruby 側の属性 (attribute) と DB 側のカラム (column) は区別されますが、ここでは全てカラムと書いています。</p>

<h4 id="attr_protectedattributes">attr_protected(*attributes)</h4>

<p>attr_protected は、カラムへの代入を制限します。制限するのは new や attributes= のようにオブジェクトのカラムを一括して扱うメソッドに対してであって、カラムに対応するメソッドを使って代入することは制限しません。</p>

<h4 id="protected_attributes">protected_attributes</h4>

<p>attr_protected で指定されたカラム名の配列を返します。</p>

<h4 id="attr_accessibleattributes">attr_accessible(*attributes)</h4>

<p>attr_accessible は、attr_protected とは逆に、(一括した) 代入を許すカラム名を指定します。</p>

<h4 id="accessible_attributes">accessible_attributes</h4>

<p>attr_accessible で指定されたカラム名の配列を返します。</p>

<h4 id="serializeattr_name-class_name--object">serialize(attr_name, class_name = Object)</h4>

<p>serialize は、シリアライズするカラムを指定します。
カラムへの格納する値を YAML で変換します。これにより、Ruby の配列やハッシュをそのまま読み書きできるようになります。</p>

<p>class_name を指定すると、カラムに格納するオブジェクトのクラスを制限できます。</p>

<h4 id="serialized_attributes">serialized_attributes</h4>

<p>serialize で指定されたカラム名をキーとし、クラスを値とするハッシュを返します。</p>

<h3 id="ar-クラスメソッド-テーブル-キー">AR クラスメソッド (テーブル, キー)</h3>

<p>DB テーブルやキーの名前を扱うクラスメソッドです。</p>

<h4 id="table_name">table_name</h4>

<p>AR クラスに対応する DB テーブル名を返します。
これは AR クラスの継承に対応しています。
例えば、Reply &lt; Topic &lt; ActiveRecord ならば、Reply 上でも Topic の table_name が返ります。</p>

<h4 id="primary_key">primary_key</h4>

<p>プライマリキーを返します。標準では “id” ですが、オプションによってはテーブル名が付加されたりします。</p>

<h4 id="inheritance_column">inheritance_column</h4>

<p>AR クラスの継承を行う際、DB 側にクラス名を保存します。
inheritance_column はクラス名の保存先となるカラム名です。</p>

<h4 id="set_table_name-valuenil-block-">set_table_name( value=nil, &amp;block )</h4>

<h4 id="set_primary_key-valuenil-block-">set_primary_key( value=nil, &amp;block )</h4>

<h4 id="set_inheritance_column-valuenil-block-">set_inheritance_column( value=nil, &amp;block )</h4>

<p>これらは、対応する getter メソッドを再定義します。
以前の getter メソッドは original_* に alias されるので (table_name なら original_table_name)、block の中で original_* メソッドを使うと、以前の規則を元に名前を作ることができます。</p>

<h4 id="class_nametable_name--table_name">class_name(table_name = table_name)</h4>

<p>DB テーブル名に対応する AR クラス名を返します。
table_name メソッドの逆です。</p>

<h3 id="ar-クラスメソッド-カラム">AR クラスメソッド (カラム)</h3>

<p>カラムオブジェクト (ActiveRecord::Base::Column) を扱うクラスメソッドです。</p>

<h4 id="columns">columns</h4>

<p>カラムオブジェクトの配列を返します。</p>

<h4 id="columns_hash">columns_hash</h4>

<p>カラム名をキーとし、カラムオブジェクトを値とするハッシュを返します。</p>

<h4 id="column_names">column_names</h4>

<p>カラム名の配列を返します。</p>

<h4 id="content_columns">content_columns</h4>

<p>カラムオブジェクトのうち、プライマリキーや継承クラス名キーそして _count, _id で終わる名前のカラムに対応するものを除いた配列を返します。</p>

<h4 id="column_methods_hash">column_methods_hash</h4>

<p>カラム名をキーとし、カラムに対応するメソッド名 (attr, attr=, attr?, attr_before_type_cast) のシンボル値を値とするハッシュの配列を返します。</p>

<h3 id="ar-クラスメソッド-そのほか">AR クラスメソッド (そのほか)</h3>

<h4 id="quoteobject">quote(object)</h4>

<h4 id="sanitizeobject">sanitize(object)</h4>

<p>サニタイズした値を返します。connection.quote の委譲です。</p>

<h4 id="benchmarktitle-">benchmark(title) {}</h4>

<p>Benchmark.measure を用いたベンチマークを行います。</p>

<h4 id="silence-">silence {}</h4>

<p>logger によるログをとらないブロックを提供します。</p>

<h3 id="ar-インスタンスメソッド">AR インスタンスメソッド</h3>

<p>AR のインスタンスメソッドをまとめます。</p>

<h4 id="id">id</h4>

<p>id の値を返します。
id は DB のプライマリキーに対応します。</p>

<h4 id="id_before_type_cast">id_before_type_cast</h4>

<p>キャストする前の id の値を返します。</p>

<h4 id="quoted_id">quoted_id</h4>

<p>quote した id の値を返します。</p>

<h4 id="idvalue">id=(value)</h4>

<p>id の値を設定します。</p>

<h4 id="new_record">new_record?</h4>

<p>save されていない (まだ DB 上に格納されていない) オブジェクトであるか。</p>

<h4 id="save">save</h4>

<p>DB に格納します。true を返します。</p>

<p>new_record であれば insert し、そうでなければ update します。</p>

<p>ただし、validation チェックに引っかかった場合は格納しません。このときは false を返します。</p>

<h4 id="destroy">destroy</h4>

<p>save されていれば (new_record? でなければ) DB から行を削除します (SQL 文 (delete from …) を発行します)。</p>

<p>また、どちらにしても freeze します。</p>

<h4 id="clone">clone</h4>

<p>AR オブジェクトのクローンを作成します。この際 id を未設定にするので、new_record として扱います。</p>

<h4 id="update_attributename-value">update_attribute(name, value)</h4>

<p>ひとつのカラムを更新し、save します。
これは特に、既存 record の boolean フラグの更新に役立ちます。</p>

<p>戻り値は save の戻り値です。
ただし、validation チェックは回避されます。</p>

<h4 id="update_attributesattributes">update_attributes(attributes)</h4>

<p>複数のカラムを更新し、save します。</p>

<p>self.attributes = attributes して save します。戻り値は save の戻り値です。</p>

<h4 id="incrementattribute">increment(attribute)</h4>

<h4 id="decrementattribute">decrement(attribute)</h4>

<p>0 で初期化したあと、+1, -1 します。数値を扱うカラムでのみ動作します。</p>

<h4 id="incrementattribute-1">increment!(attribute)</h4>

<h4 id="decrementattribute-1">decrement!(attribute)</h4>

<p>increment, decrement したあと、save します。</p>

<h4 id="toggleattribute">toggle(attribute)</h4>

<p>真偽を入れ替えます。self を返します。</p>

<h4 id="toggleattribute-1">toggle!(attribute)</h4>

<p>toggle したあと、save します。</p>

<h4 id="reload">reload</h4>

<p>リロードします (キャッシュを破棄し、DB から値を取り込みます)。self を返します。</p>

<h4><a href="attr_name"></a></h4>

<p>カラム値を取得します。</p>

<p>得られるのはキャスト後の値です。例えば DATE カラムの “2004-12-12” は Date.new(2004, 12, 12) として得られます。</p>

<p>read_attribute メソッド (protected) の alias です。</p>

<h4 id="attr_name-value">[]=(attr_name, value)</h4>

<p>カラム値を設定します。</p>

<p>write_attribute メソッド (protected) の alias です。</p>

<h4 id="attributesattributes">attributes=(attributes)</h4>

<p>ハッシュで一度に複数のカラム値を設定します。
attr_protected, attr_accessible の制限を受けます。</p>

<h4 id="attributes">attributes</h4>

<p>カラム名をキーとし、カラム値 (キャスト後) を値とするハッシュを返します。</p>

<h4 id="attribute_presentattribute">attribute_present?(attribute)</h4>

<p>attribute はカラム名です。
その名前のカラムが存在してかつ値が nil? でも empty? でもなければ true を、そうでなければ false を返します。</p>

<h4 id="attribute_names">attribute_names</h4>

<p>ソートしたカラム名の配列を返します。</p>

<h4 id="column_for_attributename">column_for_attribute(name)</h4>

<p>name に対応するカラムオブジェクトを返します。</p>

<h2 id="おわりに">おわりに</h2>

<p>ごめんなさい。力尽きました。orz
今回もさまざまな形でご意見をいただきました。感謝いたします。</p>

<h2 id="著者について">著者について</h2>

<p>もりきゅうは <a href="http://www.mitta-sys.jp/">ミッタシステム</a> のプログラマです。</p>

<p>著者の連絡先は moriq@moriq.com です。</p>

<h2 id="rubyonrails-を使ってみる-連載一覧">RubyOnRails を使ってみる 連載一覧</h2>

<ul>
  <li>
    <p><a href="/articles/0019/0019-RubyOnRails.html">RubyOnRails を使ってみる 【第 10 回】 パフォーマンスチューニング</a></p>
  </li>
  <li>
    <p><a href="/articles/0018/0018-RubyOnRails.html">RubyOnRails を使ってみる 【第 9 回】 Rails で XML-DB にチャレンジ</a></p>
  </li>
  <li>
    <p><a href="/articles/0015/0015-RubyOnRails.html">RubyOnRails を使ってみる 【第 8 回】 Rails はまり道</a></p>
  </li>
  <li>
    <p><a href="/articles/0014/0014-RubyOnRails.html">RubyOnRails を使ってみる 【第 7 回】 RJS を使ってみる</a></p>
  </li>
  <li>
    <p><a href="/articles/0013/0013-RubyOnRails.html">RubyOnRails を使ってみる 【第 6 回】 テストの書き方</a></p>
  </li>
  <li>
    <p><a href="/articles/0012/0012-RubyOnRails.html">RubyOnRails を使ってみる 【第 5 回】 ActiveHeart</a></p>
  </li>
  <li>
    <p><a href="/articles/0008/0008-RubyOnRails.html">RubyOnRails を使ってみる 【第 4 回】 ActionPack</a></p>
  </li>
  <li>
    <p><a href="/articles/0006/0006-RubyOnRails.html">RubyOnRails を使ってみる 【第 3 回】 ActiveRecord</a></p>
  </li>
  <li>
    <p><a href="/articles/0005/0005-RubyOnRails.html">RubyOnRails を使ってみる 【第 2 回】 (続・RubyOnRails を使ってみる)</a></p>
  </li>
  <li>
    <p><a href="/articles/0004/0004-RubyOnRails.html">RubyOnRails を使ってみる 【第 1 回】</a></p>
  </li>
</ul>


            </div>
        </div>
    </div>
  </body>
</html>
<!DOCTYPE html>
<html>
