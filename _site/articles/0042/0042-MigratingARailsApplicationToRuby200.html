<!DOCTYPE html>
<html>
  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>クックパッドを Ruby 2.0.0 に対応させた話</title>
  <meta name="description" content="書いた人：村田賢太 (@mrkn)">

  <script src="/js/jquery.min.js"></script>
  <script src="/js/bootstrap.min.js"></script>
  <link href="/css/bootstrap.min.css" rel="stylesheet" type="text/css">
  <link href="/css/theme.css" rel="stylesheet" type="text/css">
  <link href="/css/syntax.css" rel="stylesheet" type="text/css">

  <link rel="canonical" href="http://localhost:4000/articles/0042/0042-MigratingARailsApplicationToRuby200.html">
  <link rel="alternate" type="application/rss+xml" title="Rubyist Magazine" href="http://localhost:4000/feed.xml">
  <link rel="shortcut icon" href="/images/favicon.ico">
</head>

  <body>
    <div class="container container-left">
        <div class="row">
            <div class="col-md-1 hidden-xs sidebar">
                <h4>

</h4>

<h4>バックナンバー</h4>
<ul>
    
        <li><a href="/articles/0056/0056-index.html">0056号(2017-08)</a></li>
    
        <li><a href="/articles/0055/0055-index.html">0055号(2017-03)</a></li>
    
        <li><a href="/articles/0054/0054-index.html">0054号(2016-08)</a></li>
    
        <li><a href="/articles/pretokyorubykaigi11/preTokyoRubyKaigi11.html">東京 Ruby 会議 11 直前特集号</a></li>
    
        <li><a href="/articles/0053/0053-index.html">0053号(2016-04)</a></li>
    
        <li><a href="/articles/0052/0052-index.html">0052号(2015-12)</a></li>
    
        <li><a href="/articles/0051/0051-index.html">0051号(2015-09)</a></li>
    
        <li><a href="/articles/0050/0050-index.html">0050号(2015-05)</a></li>
    
        <li><a href="/articles/0049/0049-index.html">0049号(2014-12)</a></li>
    
        <li><a href="/articles/0048/0048-index.html">0048号(2014-09)</a></li>
    
        <li><a href="/articles/0047/0047-index.html">0047号(2014-06)</a></li>
    
        <li><a href="/articles/0046/0046-index.html">0046号(2014-04)</a></li>
    
        <li><a href="/articles/0045/0045-index.html">0045号(2013-12)</a></li>
    
        <li><a href="/articles/0044/0044-index.html">0044号(2013-09)</a></li>
    
        <li><a href="/articles/0043/0043-index.html">0043号(2013-07)</a></li>
    
        <li><a href="/articles/0042/0042-index.html">0042号(2013-05)</a></li>
    
        <li><a href="/articles/ruby200specialen/Ruby200SpecialEn.html">2.0.0 Special (EN)</a></li>
    
        <li><a href="/articles/0041/0041-index.html">0041号(2013-02)</a></li>
    
        <li><a href="/articles/0040/0040-index.html">0040号(2012-11)</a></li>
    
        <li><a href="/articles/0039/0039-index.html">0039号(2012-09)</a></li>
    
        <li><a href="/articles/rubykaja/kaja.html">RubyKaja のご紹介</a></li>
    
        <li><a href="/articles/0038/0038-index.html">0038号(2012-05)</a></li>
    
        <li><a href="/articles/0037/0037-index.html">0037号(2012-02)</a></li>
    
        <li><a href="/articles/0036/0036-index.html">0036号(2011-11)</a></li>
    
        <li><a href="/articles/0035/0035-index.html">0035号(2011-09)</a></li>
    
        <li><a href="/articles/prerubykaigi2011/preRubyKaigi2011.html">RubyKaigi2011直前特集号</a></li>
    
        <li><a href="/articles/0034/0034-index.html">0034号(2011-06)</a></li>
    
        <li><a href="/articles/0033/0033-index.html">0033号(2011-04)</a></li>
    
        <li><a href="/articles/0032/0032-index.html">0032号(2011-01)</a></li>
    
        <li><a href="/articles/0031/0031-index.html">0031号(2010-10)</a></li>
    
        <li><a href="/articles/prerubykaigi2010/preRubyKaigi2010.html">RubyKaigi2010直前特集号</a></li>
    
        <li><a href="/articles/0030/0030-index.html">0030号(2010-06)</a></li>
    
        <li><a href="/articles/0029/0029-index.html">0029号(2010-03)</a></li>
    
        <li><a href="/articles/0028/0028-index.html">0028号(2009-12)</a></li>
    
        <li><a href="/articles/0027/0027-index.html">0027号(2009-09)</a></li>
    
        <li><a href="/articles/0026/0026-index.html">0026号(2009-06)</a></li>
    
        <li><a href="/articles/0025/0025-index.html">0025号(2009-02)</a></li>
    
        <li><a href="/articles/0024/0024-index.html">0024号(2008-10)</a></li>
    
        <li><a href="/articles/0023/0023-index.html">0023号(2008-03)</a></li>
    
        <li><a href="/articles/0022/0022-index.html">0022号(2007-12)</a></li>
    
        <li><a href="/articles/0021/0021-index.html">0021号(2007-09)</a></li>
    
        <li><a href="/articles/0020/0020-index.html">0020号(2007-08)</a></li>
    
        <li><a href="/articles/0019/0019-index.html">0019号(2007-05)</a></li>
    
        <li><a href="/articles/0018/0018-index.html">0018号(2007-02)</a></li>
    
        <li><a href="/articles/0017/0017-index.html">0017号(2006-11)</a></li>
    
        <li><a href="/articles/0016/0016-index.html">0016号(2006-09)</a></li>
    
        <li><a href="/articles/0015/0015-index.html">0015号(2006-07)</a></li>
    
        <li><a href="/articles/rubykaigi2006/RubyKaigi2006-index.html">日本 Ruby カンファレンス 2006 特別号</a></li>
    
        <li><a href="/articles/0014/0014-index.html">0014号(2006-05)</a></li>
    
        <li><a href="/articles/0013/0013-index.html">0013号(2006-02)</a></li>
    
        <li><a href="/articles/0012/0012-index.html">0012号(2005-12)</a></li>
    
        <li><a href="/articles/0011/0011-index.html">0011号(2005-11)</a></li>
    
        <li><a href="/articles/0010/0010-index.html">0010号(2005-10)</a></li>
    
        <li><a href="/articles/0009/0009-index.html">0009号(2005-09)</a></li>
    
        <li><a href="/articles/0008/0008-index.html">0008号(2005-07)</a></li>
    
        <li><a href="/articles/0007/0007-index.html">0007号(2005-06)</a></li>
    
        <li><a href="/articles/0006/0006-index.html">0006号(2005-05)</a></li>
    
        <li><a href="/articles/0005/0005-index.html">0005号(2005-02)</a></li>
    
        <li><a href="/articles/0004/0004-index.html">0004号(2004-12)</a></li>
    
        <li><a href="/articles/0003/0003-index.html">0003号(2004-11)</a></li>
    
        <li><a href="/articles/0002/0002-index.html">0002号(2004-10)</a></li>
    
        <li><a href="/articles/0001/0001-index.html">0001号(2004-09)</a></li>
    
</ul>
<p class="rss-subscribe"><a href="/feed.xml">RSS</a></p>

            </div>
            <div class="col-md-11 main">
                <img src="/images/rubima_logo_l.png">
                <h1>クックパッドを Ruby 2.0.0 に対応させた話</h1>
                <div class="social-buttons">
                    <a href="http://b.hatena.ne.jp/entry//articles/0042/0042-MigratingARailsApplicationToRuby200.html" class="hatena-bookmark-button" data-hatena-bookmark-title="クックパッドを Ruby 2.0.0 に対応させた話" data-hatena-bookmark-layout="simple-balloon" title="このエントリーをはてなブックマークに追加"><img src="https://b.st-hatena.com/images/entry-button/button-only@2x.png" alt="このエントリーをはてなブックマークに追加" width="20" height="20" style="border: none;" /></a><script type="text/javascript" src="https://b.st-hatena.com/js/bookmark_button.js" charset="utf-8" async="async"></script>
<span id="fb-root"></span>
<script>(function(d, s, id) {
  var js, fjs = d.getElementsByTagName(s)[0];
  if (d.getElementById(id)) return;
  js = d.createElement(s); js.id = id;
  js.src = "//connect.facebook.net/ja_JP/sdk.js#xfbml=1&version=v2.5";
  fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));</script>
<span class="fb-like" data-href="/articles/0042/0042-MigratingARailsApplicationToRuby200.html" data-layout="button_count" data-action="like" data-show-faces="false" data-share="false"></span>
<a href="https://twitter.com/share" class="twitter-share-button" data-url="/articles/0042/0042-MigratingARailsApplicationToRuby200.html" data-text="クックパッドを Ruby 2.0.0 に対応させた話">ツイート</a>
<script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');</script>

                </div>
                <p>書いた人：村田賢太 (<a href="http://twitter.com/mrkn">@mrkn</a>)</p>

<h2 id="クックパッドを-ruby-200-に対応させた話">クックパッドを Ruby 2.0.0 に対応させた話</h2>

<p>Ruby 2.0.0-p0 がリリースされて2ヶ月ちょっと経過してます。<sup id="fnref:1"><a href="#fn:1" class="footnote">1</a></sup>この新しい Ruby を皆さんはもう使っているでしょうか。</p>

<p>先日クックパッドが本番環境で使用する Ruby が 2.0.0-p0 にアップグレードされました。アップグレード作業を担当したのは著者です。本稿では、この移行作業で得られた知識を皆さんに紹介します。</p>

<h2 id="目次">目次</h2>

<ul id="markdown-toc">
  <li><a href="#クックパッドを-ruby-200-に対応させた話" id="markdown-toc-クックパッドを-ruby-200-に対応させた話">クックパッドを Ruby 2.0.0 に対応させた話</a></li>
  <li><a href="#目次" id="markdown-toc-目次">目次</a></li>
  <li><a href="#ruby-200-に移行するまでの流れ" id="markdown-toc-ruby-200-に移行するまでの流れ">Ruby 2.0.0 に移行するまでの流れ</a></li>
  <li><a href="#ruby-のバージョンアップ作業" id="markdown-toc-ruby-のバージョンアップ作業">Ruby のバージョンアップ作業</a>    <ul>
      <li><a href="#193-への移行" id="markdown-toc-193-への移行">1.9.3 への移行</a></li>
      <li><a href="#syntaxerror-を誘発する非互換性" id="markdown-toc-syntaxerror-を誘発する非互換性">SyntaxError を誘発する非互換性</a>        <ul>
          <li><a href="#マジックコメント" id="markdown-toc-マジックコメント">マジックコメント</a></li>
          <li><a href="#then-や-do-の代わりのコロン" id="markdown-toc-then-や-do-の代わりのコロン">then や do の代わりのコロン</a></li>
          <li><a href="#ブロックパラメータとしてのインスタンス変数" id="markdown-toc-ブロックパラメータとしてのインスタンス変数">ブロックパラメータとしてのインスタンス変数</a></li>
        </ul>
      </li>
      <li><a href="#消された機能" id="markdown-toc-消された機能">消された機能</a>        <ul>
          <li><a href="#next-でメソッドから抜けられない" id="markdown-toc-next-でメソッドから抜けられない"><code class="highlighter-rouge">next</code> でメソッドから抜けられない</a></li>
          <li><a href="#symbolto_int-が消えたイイ話" id="markdown-toc-symbolto_int-が消えたイイ話"><code class="highlighter-rouge">Symbol#to_int</code> が消えたイイ話</a></li>
          <li><a href="#enumerableenum_with_index" id="markdown-toc-enumerableenum_with_index"><code class="highlighter-rouge">Enumerable#enum_with_index</code></a></li>
          <li><a href="#time--timeinclude-time" id="markdown-toc-time--timeinclude-time"><code class="highlighter-rouge">(time .. time).include? time</code></a></li>
          <li><a href="#datestep-と-activesupportduration" id="markdown-toc-datestep-と-activesupportduration"><code class="highlighter-rouge">Date#step</code> と <code class="highlighter-rouge">ActiveSupport::Duration</code></a></li>
        </ul>
      </li>
      <li><a href="#意味が変わったもの" id="markdown-toc-意味が変わったもの">意味が変わったもの</a>        <ul>
          <li><a href="#lambda-で生成される-proc-オブジェクトの引数マッチング" id="markdown-toc-lambda-で生成される-proc-オブジェクトの引数マッチング"><code class="highlighter-rouge">lambda</code> で生成される Proc オブジェクトの引数マッチング</a></li>
          <li><a href="#多重代入" id="markdown-toc-多重代入">多重代入</a></li>
          <li><a href="#正規表現の非互換性" id="markdown-toc-正規表現の非互換性">正規表現の非互換性</a></li>
          <li><a href="#activerecord-と-nilid" id="markdown-toc-activerecord-と-nilid">ActiveRecord と <code class="highlighter-rouge">nil.id</code></a></li>
          <li><a href="#新ハッシュ記法" id="markdown-toc-新ハッシュ記法">新ハッシュ記法</a></li>
        </ul>
      </li>
      <li><a href="#文字エンコーディング関係" id="markdown-toc-文字エンコーディング関係">文字エンコーディング関係</a>        <ul>
          <li><a href="#tempfile-のオープンモード" id="markdown-toc-tempfile-のオープンモード"><code class="highlighter-rouge">Tempfile</code> のオープンモード</a></li>
          <li><a href="#nkf-kconv-jcode-iconv" id="markdown-toc-nkf-kconv-jcode-iconv">nkf, kconv, jcode, iconv</a></li>
          <li><a href="#独自の-stringblank" id="markdown-toc-独自の-stringblank">独自の <code class="highlighter-rouge">String#blank?</code></a></li>
        </ul>
      </li>
      <li><a href="#200-への移行" id="markdown-toc-200-への移行">2.0.0 への移行</a>        <ul>
          <li><a href="#objectinitialize_clone-と-objectinitialize_dup-がプライベートメソッドになった" id="markdown-toc-objectinitialize_clone-と-objectinitialize_dup-がプライベートメソッドになった"><code class="highlighter-rouge">Object#initialize_clone</code> と <code class="highlighter-rouge">Object#initialize_dup</code> がプライベートメソッドになった</a></li>
          <li><a href="#スレッド周辺の非互換性" id="markdown-toc-スレッド周辺の非互換性">スレッド周辺の非互換性</a></li>
          <li><a href="#rubygems-のバグ" id="markdown-toc-rubygems-のバグ">rubygems のバグ</a></li>
        </ul>
      </li>
      <li><a href="#バージョンアップ対応の進め方" id="markdown-toc-バージョンアップ対応の進め方">バージョンアップ対応の進め方</a></li>
    </ul>
  </li>
  <li><a href="#ruby-のバージョンアップした結果" id="markdown-toc-ruby-のバージョンアップした結果">Ruby のバージョンアップした結果</a></li>
  <li><a href="#まとめ" id="markdown-toc-まとめ">まとめ</a></li>
  <li><a href="#著者について" id="markdown-toc-著者について">著者について</a></li>
</ul>

<h2 id="ruby-200-に移行するまでの流れ">Ruby 2.0.0 に移行するまでの流れ</h2>

<p>2011 年 11 月から著者はクックパッドの Ruby 1.9.3 対応を開始しました。当サイトは <a href="http://www.rubyenterpriseedition.com/">Ruby Enterprise Edition</a> で運用されていました。諸事情により移行作業は3ヶ月後に一時中断され、他の業務にあたる事になりました。そしてちょうど 1 年後、2012 年 11 月に移行作業を再開し、2013 年 2 月 26 日に完了しました。さらに、そのあとすぐに Ruby 2.0.0 対応を開始し、同年 4 月 9 日に完了しました。</p>

<p>作業開始から終了までの期間は、Ruby 1.9.3 対応では約7ヶ月、Ruby 2.0.0 対応では約 1.5 ヶ月です。この期間、バージョンアップ対応だけをやっているわけではなく、新バージョンのための環境構築、全く異なる別の作業などを並行して行っています。純粋なバージョンアップ作業で必要になった時間は、Ruby 1.9.3 対応では約 4 ヶ月分の時間を使った事になります。Ruby 2.0.0 対応においては、約 2 週間分ほどの時間しか使っていません。</p>

<p>Ruby 2.0.0 対応に要した時間がとても短い理由は、__2.0.0 が 1.9.3 との高い互換性を維持したままリリースされたから__でしょう。</p>

<h2 id="ruby-のバージョンアップ作業">Ruby のバージョンアップ作業</h2>

<h3 id="193-への移行">1.9.3 への移行</h3>

<p>Ruby Enterprise Edition から Ruby 1.9.3 へ移行する際に出会った問題と、私がとった対策について説明します。</p>

<h3 id="syntaxerror-を誘発する非互換性">SyntaxError を誘発する非互換性</h3>

<p>ここでは 1.8 と 1.9 の間で起きた仕様の変化によって SyntaxError が発生してしまうようになったものを紹介します。</p>

<h4 id="マジックコメント">マジックコメント</h4>

<p>Ruby 1.9 から m17n が導入され、すべての文字列と正規表現が文字エンコーディングを持つことになりました(<a href="http://jp.rubyist.net/magazine/?0025-Ruby19_m17n">参考</a>)。Ruby 1.9 ではスクリプトエンコーディングのデフォルト値が US-ASCII であるため、文字列や正規表現でマルチバイト文字を使用しているファイルにマジックコメントを書く必要がありました。</p>

<p>著者以外のエンジニアは 1.8 を使用しているため、新しく追加されるファイルにマジックコメントが記載されないことが原因の Syntax Error が時々発生していました。著者は以下のスクリプトを使って、リポジトリ内のすべてのファイルを走査し、マジックコメントが必要なファイルに自動的にマジックコメントを入れました。</p>

<div class="language-ruby highlighter-rouge"><pre class="highlight"><code><span class="c1">#! /usr/bin/env ruby</span>
<span class="c1"># coding: utf-8</span>
<span class="c1"># https://gist.github.com/mrkn/5173137</span>

<span class="k">def</span> <span class="nf">has_magic_comment?</span><span class="p">(</span><span class="n">content</span><span class="p">)</span>
  <span class="k">if</span> <span class="n">content</span><span class="p">.</span><span class="nf">lines</span><span class="p">.</span><span class="nf">first</span> <span class="o">=~</span> <span class="sr">/\A#!/</span>
    <span class="n">first_line</span> <span class="o">=</span> <span class="n">content</span><span class="p">.</span><span class="nf">lines</span><span class="p">.</span><span class="nf">take</span><span class="p">(</span><span class="mi">2</span><span class="p">).</span><span class="nf">last</span>
  <span class="k">else</span>
    <span class="n">first_line</span> <span class="o">=</span> <span class="n">content</span><span class="p">.</span><span class="nf">lines</span><span class="p">.</span><span class="nf">first</span>
  <span class="k">end</span>
  <span class="n">comment</span> <span class="o">=</span> <span class="n">first_line</span><span class="p">.</span><span class="nf">sub</span><span class="p">(</span><span class="sr">/(?:\"(?:[^"]|\\\")*\"|\'(?:[^']|\\\')*\'|[^#]*)#/</span><span class="p">,</span> <span class="s1">''</span><span class="p">).</span><span class="nf">strip</span>
  <span class="n">comment</span> <span class="o">=~</span> <span class="sr">/\b(?:en)?coding\s*:\s*(?:utf|UTF)-?8\b/</span>
<span class="k">end</span>

<span class="k">def</span> <span class="nf">insert_magic_comment</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
  <span class="n">content</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s1">'rb'</span><span class="p">)</span> <span class="p">{</span><span class="o">|</span><span class="n">io</span><span class="o">|</span> <span class="n">io</span><span class="p">.</span><span class="nf">read</span> <span class="p">}</span> <span class="k">rescue</span> <span class="vg">$!</span>
  <span class="k">return</span> <span class="k">if</span> <span class="no">Exception</span> <span class="o">===</span> <span class="n">content</span> <span class="o">||</span> <span class="n">content</span><span class="p">.</span><span class="nf">empty?</span>
  <span class="n">content</span><span class="p">.</span><span class="nf">force_encoding</span><span class="p">(</span><span class="s1">'BINARY'</span><span class="p">)</span> <span class="k">if</span> <span class="n">content</span><span class="p">.</span><span class="nf">respond_to?</span><span class="p">(</span><span class="ss">:force_encoding</span><span class="p">)</span>
  <span class="k">unless</span> <span class="n">has_magic_comment?</span><span class="p">(</span><span class="n">content</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">content</span> <span class="o">=~</span> <span class="sr">/[^\x00-\x7E]/m</span>
      <span class="vg">$stderr</span><span class="p">.</span><span class="nf">puts</span> <span class="s2">"inserting magic comment to </span><span class="si">#{</span><span class="n">path</span><span class="si">}</span><span class="s2">"</span>
      <span class="nb">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s1">'wb'</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">io</span><span class="o">|</span>
        <span class="n">io</span><span class="p">.</span><span class="nf">puts</span> <span class="s2">"# coding: utf-8"</span>
        <span class="n">io</span><span class="p">.</span><span class="nf">write</span> <span class="n">content</span>
      <span class="k">end</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="k">if</span> <span class="no">ARGV</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">'--pre-commit'</span>
  <span class="nb">open</span><span class="p">(</span><span class="s2">"|git diff --cached --name-only HEAD"</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">io</span><span class="o">|</span>
    <span class="k">while</span> <span class="n">path</span> <span class="o">=</span> <span class="n">io</span><span class="p">.</span><span class="nf">gets</span>
      <span class="n">path</span><span class="p">.</span><span class="nf">strip!</span>
      <span class="k">next</span> <span class="k">unless</span> <span class="n">path</span> <span class="o">=~</span> <span class="sr">/\.rb$/</span>
      <span class="n">insert_magic_comment</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">else</span>
  <span class="nb">require</span> <span class="s1">'find'</span>
  <span class="no">Find</span><span class="p">.</span><span class="nf">find</span><span class="p">(</span><span class="no">Dir</span><span class="p">.</span><span class="nf">pwd</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">path</span><span class="o">|</span>
    <span class="k">next</span> <span class="k">unless</span> <span class="n">path</span> <span class="o">=~</span> <span class="sr">/\.rb$/</span>
    <span class="n">insert_magic_comment</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>

</code></pre>
</div>

<p>このスクリプトは pwd 以下にある拡張子が <code class="highlighter-rouge">.rb</code> のファイルを対象にマジックコメントが必要だったら <code class="highlighter-rouge"># coding: utf-8</code> をファイルの先頭に挿入します。コマンドラインで <code class="highlighter-rouge">--pre-commit</code> オプションを指定すると git add されたファイルのみを対象にマジックコメントを挿入するようになっています。git の pre-commit フックから呼び出すときに便利です。</p>

<h4 id="then-や-do-の代わりのコロン">then や do の代わりのコロン</h4>

<p>Ruby 1.8 までは、以下に示すように、<code class="highlighter-rouge">if</code> や <code class="highlighter-rouge">while</code> の条件の後ろにコロン (<code class="highlighter-rouge">:</code>) を置く記法が許されていました:</p>

<div class="language-ruby highlighter-rouge"><pre class="highlight"><code><span class="n">y</span> <span class="o">=</span> <span class="n">y0</span>
<span class="k">while</span> <span class="n">y</span> <span class="o">&gt;</span> <span class="ss">height:
  </span><span class="n">x</span> <span class="o">=</span> <span class="n">x0</span>
  <span class="k">while</span> <span class="n">x</span> <span class="o">&gt;</span> <span class="ss">width:
    </span><span class="n">calculate</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">dx</span><span class="p">,</span> <span class="n">dy</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">+=</span> <span class="n">dx</span>
  <span class="k">end</span>
  <span class="n">y</span> <span class="o">+=</span> <span class="n">dy</span>
<span class="k">end</span>

</code></pre>
</div>

<p>この記法は Ruby 1.9 で削除されたため、上記のコードは Syntax Error になります。</p>

<p>これに対する技術的な対策は特にやっていません。テストを実行して Syntax Error が発生する度に手動でコロンを削除しました。</p>

<h4 id="ブロックパラメータとしてのインスタンス変数">ブロックパラメータとしてのインスタンス変数</h4>

<p>みなさんは 1.8 まで以下のようなブロックパラメータが許されていた事をご存知ですか？</p>

<div class="language-ruby highlighter-rouge"><pre class="highlight"><code><span class="n">recipes</span><span class="p">.</span><span class="nf">each</span> <span class="k">do</span> <span class="o">|</span><span class="vi">@recipe</span><span class="o">|</span>
  <span class="n">render</span> <span class="s1">'shared/recipe_detail'</span>
<span class="k">end</span>

</code></pre>
</div>

<p>そう、インスタンス変数をブロックパラメータにできたんです。びっくりですね。</p>

<p>著者は、このようなコードを、手っ取り早く次のように書き換えて対処しました。
同じような変更を <a href="https://github.com/rails/rails/commit/5f7c42413b099f8811c45a27202cce5dc9e7d285">@a_matsuda さんが rails でやっている</a>ので、問題ないでしょう(笑)</p>

<div class="language-ruby highlighter-rouge"><pre class="highlight"><code><span class="n">recipes</span><span class="p">.</span><span class="nf">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">recipe</span><span class="o">|</span> <span class="vi">@recipe</span> <span class="o">=</span> <span class="n">recipe</span>
  <span class="n">render</span> <span class="s1">'shared/recipe_detail'</span>
<span class="k">end</span>

</code></pre>
</div>

<p>くそ真面目に対策するなら、partial view template の中まで調べて、view template 内で新しいインスタンス変数を導入しないように修正すべきです。クックパッドの 1.9.3 対応作業では、そこまで真面目にやっていると仕事が終わらない可能性が高かったので手抜きをしました。</p>

<h3 id="消された機能">消された機能</h3>

<p>本セクションでは Ruby 1.9 になって削除された機能をまとめました。</p>

<h4 id="next-でメソッドから抜けられない"><code class="highlighter-rouge">next</code> でメソッドから抜けられない</h4>

<p>1.8 までは、<code class="highlighter-rouge">return</code> だけでなく、<code class="highlighter-rouge">next</code> でもメソッドを抜けることができました。</p>

<p>クックパッドでは <a href="http://cookpad.github.io/chanko/">Chanko</a> を使って新機能の開発を実施しているため、開発中の多くの機能が Proc クラスのインスタンスで提供されています。それらの新機能は、アプリケーションのメインコードへ結合されるときに、コントローラのアクションや、ヘルパのメソッドへと置換されます。</p>

<p>その際、<code class="highlighter-rouge">next</code> を <code class="highlighter-rouge">return</code> に書き換えるのを忘れてしまうことがあるらしく、いくつかのメソッドが <code class="highlighter-rouge">next</code> でメソッドを抜けるように作られていました。</p>

<p>この問題は、<code class="highlighter-rouge">Invalid next</code> エラーが出るため、コードを実行するとすぐに気付けます。</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text">  $ ruby -e 'def foo; next; end; foo'
  -e:1: Invalid next
  -e: compile error (SyntaxError)</code></pre></figure>

<p>私は、この <code class="highlighter-rouge">Invalid next</code> を見つけるたびに手で置き換えることで対策しました。</p>

<h4 id="symbolto_int-が消えたイイ話"><code class="highlighter-rouge">Symbol#to_int</code> が消えたイイ話</h4>

<figure class="highlight"><pre><code class="language-text" data-lang="text"> hash[:symbol]</code></pre></figure>

<p>このコードは、<code class="highlighter-rouge">hash</code> に <code class="highlighter-rouge">:symbol</code> がキーとして含まれていればそれに対応する値を、そうでなければ <code class="highlighter-rouge">nil</code> を結果とします。</p>

<p>本当にそうでしょうか？</p>

<p>このコードがそのような振る舞いを示すためには、<code class="highlighter-rouge">hash</code> が <code class="highlighter-rouge">Hash</code> クラスのインスタンスであるか、それ相当の振る舞いを示すオブジェクトである必要があります。</p>

<p>もし <code class="highlighter-rouge">hash</code> が配列や文字列など、整数インデックスだけを受け付けるオブジェクトだったら……そのような場合であっても、Ruby 1.8 ではエラーが起きずに動いてしまいます！　その理由は <code class="highlighter-rouge">Symbol#to_int</code> が存在するからです。</p>

<p>Ruby 1.9 では、<code class="highlighter-rouge">Symbol#to_int</code> が削除されています。そのため <code class="highlighter-rouge">hash</code> が配列や文字列である場合に上記のコードはかならずエラーを発生させます。</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text"> $ ruby -e '"str"[:sym]'
 -e:1:in `[]': no implicit conversion of Symbol into Integer (TypeError)
 from -e:1:in`&lt;main&gt;'</code></pre></figure>

<p>これはとても良い話です。私はこの仕様変更のおかげで、この移行作業中にテストで発見できなかったバグを見つけて修正しています。バグを生みやすい仕様が是正されることはとても歓迎できる仕様変更だと思います。</p>

<h4 id="enumerableenum_with_index"><code class="highlighter-rouge">Enumerable#enum_with_index</code></h4>

<p>1.8 では、<code class="highlighter-rouge">each_with_index</code> と同じ働きをする <code class="highlighter-rouge">enum_with_index</code> がありました。これを使っていると <code class="highlighter-rouge">NoMethodError</code> が発生するので、その例外を見つけるたびに置き換える方法もあります。しかし、私はその方法はとらず、<code class="highlighter-rouge">enum_with_index</code> を <code class="highlighter-rouge">git grep</code> コマンドで検索し、発見された行を機械的に置き換える方法で解決しました。メソッド名が独特だからできる技だと思います。</p>

<h4 id="time--timeinclude-time"><code class="highlighter-rouge">(time .. time).include? time</code></h4>

<p>1.9 から <code class="highlighter-rouge">Time#succ</code> が廃止されたことで、両端が Time オブジェクトの Range に対して <code class="highlighter-rouge">Range#include?</code> を使って包含関係を調べられなくなりました。これは、<code class="highlighter-rouge">Range#cover?</code> を使うよう変更することで対処できます。</p>

<p>この問題に対しては、Ruby Enterprise Edition の場合に以下のような monkey patch を使って警告を出す事で、使用箇所の発見だけでなく、サービス開発者によって新たな使用箇所が追加されることを防ぎました。</p>

<div class="language-ruby highlighter-rouge"><pre class="highlight"><code><span class="k">class</span> <span class="nc">Time</span>
  <span class="k">def</span> <span class="nf">succ_with_warning</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">)</span>
    <span class="vg">$stderr</span><span class="p">.</span><span class="nf">puts</span> <span class="s2">"[WARN] Time#succ is obsolete; use time + 1 at </span><span class="si">#{</span><span class="nb">caller</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">"</span>
    <span class="n">succ_without_warning</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">)</span>
  <span class="k">end</span>
  <span class="k">alias</span> <span class="n">succ_without_warning</span> <span class="n">succ</span>
  <span class="k">alias</span> <span class="n">succ</span> <span class="n">succ_with_warning</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Range</span>
  <span class="k">def</span> <span class="nf">include_with_warn?</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
    <span class="k">if</span> <span class="no">Time</span> <span class="o">===</span> <span class="nb">self</span><span class="p">.</span><span class="nf">begin</span>
      <span class="nb">caller</span><span class="p">.</span><span class="nf">tap</span> <span class="k">do</span> <span class="o">|</span><span class="n">callstack</span><span class="o">|</span>
        <span class="n">repository_root</span> <span class="o">=</span> <span class="no">File</span><span class="p">.</span><span class="nf">expand_path</span><span class="p">(</span><span class="s1">'../../../../../../../'</span><span class="p">,</span> <span class="kp">__FILE__</span><span class="p">)</span> <span class="o">+</span> <span class="s1">'/'</span>
        <span class="n">offending_line</span> <span class="o">=</span> <span class="n">callstack</span><span class="p">.</span><span class="nf">find</span> <span class="p">{</span><span class="o">|</span><span class="n">line</span><span class="o">|</span>
          <span class="no">File</span><span class="p">.</span><span class="nf">expand_path</span><span class="p">(</span><span class="n">line</span><span class="p">.</span><span class="nf">split</span><span class="p">(</span><span class="s1">':'</span><span class="p">).</span><span class="nf">first</span><span class="p">).</span><span class="nf">start_with?</span><span class="p">(</span><span class="n">repository_root</span><span class="p">)</span>
        <span class="p">}</span> <span class="o">||</span> <span class="n">callstack</span><span class="p">.</span><span class="nf">first</span>
        <span class="vg">$stderr</span><span class="p">.</span><span class="nf">puts</span> <span class="s2">"[WARN] can't iterate from Time since 1.9 at </span><span class="si">#{</span><span class="n">offending_line</span><span class="si">}</span><span class="s2">"</span>
      <span class="k">end</span>
    <span class="k">end</span>
    <span class="n">include_without_warn?</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
  <span class="k">end</span>
  <span class="k">alias</span> <span class="n">include_without_warn?</span> <span class="kp">include</span><span class="p">?</span>
  <span class="k">alias</span> <span class="kp">include</span><span class="p">?</span> <span class="n">include_with_warn?</span>
<span class="k">end</span>

</code></pre>
</div>

<h4 id="datestep-と-activesupportduration"><code class="highlighter-rouge">Date#step</code> と <code class="highlighter-rouge">ActiveSupport::Duration</code></h4>

<p>1.9 から date ライブラリが拡張ライブラリにかわりました。その過程で、Date#step は第2引数に Numeric だけを受け付けるようになりました。そのため、1週間単位の繰り返しを以下のように書けなくなりました。</p>

<div class="language-ruby highlighter-rouge"><pre class="highlight"><code><span class="n">begin_date</span><span class="p">.</span><span class="nf">step</span><span class="p">(</span><span class="n">end_date</span><span class="p">,</span> <span class="mi">1</span><span class="p">.</span><span class="nf">week</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">date</span><span class="o">|</span>
  <span class="c1"># ...</span>
<span class="k">end</span>

</code></pre>
</div>

<p>このようなコードが増えていかないように、以下のモンキーパッチを導入して警告を出し、サービス開発者に注意を促すようにして対応しました。</p>

<div class="language-ruby highlighter-rouge"><pre class="highlight"><code><span class="nb">require</span> <span class="s1">'date'</span>

<span class="k">class</span> <span class="nc">Date</span>
  <span class="k">def</span> <span class="nf">step_with_warn</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">)</span>
    <span class="k">unless</span> <span class="no">Numeric</span> <span class="o">===</span> <span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">||</span> <span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="nf">nil?</span>
      <span class="vg">$stderr</span><span class="p">.</span><span class="nf">puts</span> <span class="s2">"[WARN] non-Numeric object is given for the 2nd argument of step at </span><span class="si">#{</span><span class="nb">caller</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">"</span>
    <span class="k">end</span>
    <span class="n">step_without_warn</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">block</span><span class="p">)</span>
  <span class="k">end</span>
  <span class="k">alias</span> <span class="n">step_without_warn</span> <span class="n">step</span>
  <span class="k">alias</span> <span class="n">step</span> <span class="n">step_with_warn</span>
<span class="k">end</span>

</code></pre>
</div>

<h3 id="意味が変わったもの">意味が変わったもの</h3>

<p>本セクションでは Ruby 1.9 になって意味が変化したものをまとめました。</p>

<h4 id="lambda-で生成される-proc-オブジェクトの引数マッチング"><code class="highlighter-rouge">lambda</code> で生成される Proc オブジェクトの引数マッチング</h4>

<p><code class="highlighter-rouge">lambda</code> で作った Proc オブジェクトの引数マッチングが、メソッドの引数マッチングと同じルールに変更されました。そのため、これまで動いていた以下のコードが動かなくなりました。</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text"> lambda { }.call(1)</code></pre></figure>

<p>これは、任意の引数を受け付けるように変更して対応しました。</p>

<h4 id="多重代入">多重代入</h4>

<p>次のコードを 1.8 と 1.9 の両方で実行してみてください。</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text"> a = *[1]
 p a</code></pre></figure>

<p>Ruby 1.8 では <code class="highlighter-rouge">1</code> が表示されるのに対して、Ruby 1.9 では <code class="highlighter-rouge">[1]</code> が表示されます。多重代入のルールが変わったためです。以下のようにカンマを付けることで同じ挙動にできます。</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text"> a, = *[1]
 p a</code></pre></figure>

<h4 id="正規表現の非互換性">正規表現の非互換性</h4>

<p>1.9 から正規表現エンジンが鬼車に変わりました。鬼車は 1.8 で採用されていた正規表現エンジンよりも多くの機能を持っています。1.9 から導入された m17n にも対応しています。</p>

<p>これはとても良い改善ですが、同時に非互換性が導入され、同じ正規表現が Ruby 1.8 と 1.9 で意味が異なってしまう場合も出ています。</p>

<p>最も大きな影響がありそうな仕様変更が単語構成文字クラスを表す <code class="highlighter-rouge">\w</code> とその否定形の <code class="highlighter-rouge">\W</code> でしょう。この2つの文字クラスの構成文字種は、Ruby 1.8 までは <code class="highlighter-rouge">$KCODE</code> の値によって変化していました。<code class="highlighter-rouge">$KCODE</code> が <code class="highlighter-rouge">none</code> である場合、単語構成文字は ASCII の範囲に限られ、アルファベットと数字とアンスコ (<code class="highlighter-rouge">_</code>) でした。<code class="highlighter-rouge">$KCODE</code> が <code class="highlighter-rouge">utf8</code> などマルチバイト文字エンコーディングを意味する値の場合は、ASCII の範囲外の文字も単語構成文字に含まれます。たとえば、ひらがな、カタカナ、漢字などです。</p>

<p>ところが、Ruby 1.9 からは <code class="highlighter-rouge">\w</code> と <code class="highlighter-rouge">\W</code> が持つ文字が常に ASCII の範囲内に限定されることになりました。その理由は、新しい正規表現処理エンジンが Unicode のプロパティを使って文字クラスを作れるようになったからです。その機能を使うと、ASCII の範囲外の文字も含む単語構成文字クラスは <code class="highlighter-rouge">\p{Word}</code> であり、その否定形は <code class="highlighter-rouge">\P{Word}</code> になります。</p>

<p>この違いを吸収するため、私は以下のように正規表現を実行時にコンパイルする方法を採用しました。</p>

<div class="language-ruby highlighter-rouge"><pre class="highlight"><code><span class="n">word</span> <span class="o">=</span> <span class="no">RUBY_VERSION</span> <span class="o">&lt;</span> <span class="s1">'1.9'</span> <span class="p">?</span> <span class="s1">'\w'</span> <span class="p">:</span> <span class="s1">'\p{Word}'</span>
<span class="n">regex</span> <span class="o">=</span> <span class="sr">/</span><span class="si">#{</span><span class="n">word</span><span class="si">}</span><span class="sr">/</span>

</code></pre>
</div>

<p>正規表現を実行時に作っている理由はコンパイルエラーを避けるためです。以下の方法では、Ruby 1.8 で <code class="highlighter-rouge">\p</code> や <code class="highlighter-rouge">\P</code> を含む正規表現をコンパイルしようとするため、コンパイルエラーになります。</p>

<div class="language-ruby highlighter-rouge"><pre class="highlight"><code><span class="n">regex</span> <span class="o">=</span> <span class="no">RUBY_VERSION</span> <span class="o">&lt;</span> <span class="s1">'1.9'</span> <span class="p">?</span> <span class="sr">/\w/</span> <span class="p">:</span> <span class="sr">/\p{Word}/</span>

</code></pre>
</div>

<p>Ruby 1.9 では、正規表現とマッチさせる文字列の文字エンコーディングを気にする必要があります。この話は「独自の <code class="highlighter-rouge">String#blank?</code>」の項で詳しく説明します。</p>

<h4 id="activerecord-と-nilid">ActiveRecord と <code class="highlighter-rouge">nil.id</code></h4>

<p>次に示すコードはシンプルな has_many 関係を持つ ActiveRecord のモデルです。</p>

<div class="language-ruby highlighter-rouge"><pre class="highlight"><code><span class="k">module</span> <span class="nn">User</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="n">belongs_to</span> <span class="ss">:group</span>
<span class="k">end</span>

<span class="k">module</span> <span class="nn">Group</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="n">has_many</span> <span class="ss">:users</span>
<span class="k">end</span>

</code></pre>
</div>

<p>ActiveRecord は、<code class="highlighter-rouge">User#group</code> に保持されたオブジェクトが DB に保存される際、<code class="highlighter-rouge">group.id</code> の結果を <code class="highlighter-rouge">group_id</code> カラムに保存しようとします。このとき、<code class="highlighter-rouge">User#group</code> に nil が入っていると <code class="highlighter-rouge">nil.id</code> が呼ばれ、<code class="highlighter-rouge">nil.id</code> が CRuby では 4 になることから、whiny_nils が無効になっていると <code class="highlighter-rouge">group_id</code> に 4 が入ってしまう現象が起きることは有名です。</p>

<p>Ruby 1.9 ではこの現象は発生しません。代わりに NoMethodError が発生します。その理由は <code class="highlighter-rouge">Object#id</code> メソッドが削除されたからです。<sup id="fnref:2"><a href="#fn:2" class="footnote">2</a></sup></p>

<p>この問題に対しては、Ruby 1.8 の場合に <code class="highlighter-rouge">nil.id</code> でエラーが出ないことの方を問題だと解釈し、以下のようなモンキーパッチを使用して <code class="highlighter-rouge">nil.id</code> が呼ばれた場所を検出する方法をとりました。このモンキーパッチは <code class="highlighter-rouge">Rails.application.config.whiny_nils</code> を参照するため、initializer の中でロードする必要があります。</p>

<div class="language-ruby highlighter-rouge"><pre class="highlight"><code><span class="k">if</span> <span class="no">Rails</span><span class="p">.</span><span class="nf">application</span><span class="p">.</span><span class="nf">config</span><span class="p">.</span><span class="nf">whiny_nils</span>
  <span class="nb">require</span> <span class="s1">'active_support/whiny_nil'</span>
<span class="k">end</span>

<span class="k">if</span> <span class="no">RUBY_VERSION</span> <span class="o">&lt;</span> <span class="s1">'1.9'</span>
  <span class="k">class</span> <span class="nc">NilClass</span>
    <span class="k">def</span> <span class="nf">id_with_warn</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">)</span>
      <span class="k">return</span> <span class="mi">4</span> <span class="k">unless</span> <span class="no">File</span><span class="p">.</span><span class="nf">expand_path</span><span class="p">(</span><span class="nb">caller</span><span class="p">[</span><span class="mi">0</span><span class="p">]).</span><span class="nf">starts_with?</span><span class="p">(</span><span class="no">Rails</span><span class="p">.</span><span class="nf">root</span><span class="p">)</span>
      <span class="n">message</span> <span class="o">=</span> <span class="s2">"nil.id was called at </span><span class="si">#{</span><span class="nb">caller</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">"</span>
      <span class="k">if</span> <span class="n">defined?</span> <span class="no">Logger</span>
        <span class="no">Logger</span><span class="p">.</span><span class="nf">error</span><span class="p">.</span><span class="nf">post</span><span class="p">(</span><span class="s1">'nil.id'</span><span class="p">,</span> <span class="n">message</span><span class="p">)</span>
      <span class="k">else</span>
        <span class="vg">$stderr</span><span class="p">.</span><span class="nf">puts</span> <span class="n">message</span>
      <span class="k">end</span>
      <span class="mi">4</span>
    <span class="k">end</span>

    <span class="k">alias</span> <span class="n">id_without_warn</span> <span class="nb">id</span>
    <span class="k">alias</span> <span class="nb">id</span> <span class="n">id_with_warn</span>
  <span class="k">end</span>
<span class="k">end</span>

</code></pre>
</div>

<h4 id="新ハッシュ記法">新ハッシュ記法</h4>

<p>Ruby 1.9 から導入された新ハッシュ記法に関連する面白い非互換性があります。</p>

<div class="language-ruby highlighter-rouge"><pre class="highlight"><code><span class="k">def</span> <span class="nf">foo</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
  <span class="s2">"foo: </span><span class="si">#{</span><span class="n">x</span><span class="si">}</span><span class="s2">"</span>
<span class="k">end</span>

<span class="k">def</span> <span class="nf">bar</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
  <span class="s2">"bar: </span><span class="si">#{</span><span class="n">x</span><span class="si">}</span><span class="s2">"</span>
<span class="k">end</span>

<span class="nb">p</span> <span class="n">foo</span> <span class="n">bar</span><span class="ss">:baz</span>

</code></pre>
</div>

<p>上記のコードは 1.8 では <code class="highlighter-rouge">foo: bar: baz</code> が表示されます。<sup id="fnref:3"><a href="#fn:3" class="footnote">3</a></sup>ところが 1.9 では <code class="highlighter-rouge">bar:</code> というキーに変数 <code class="highlighter-rouge">baz</code> の値を対応させたハッシュを引数に <code class="highlighter-rouge">foo</code> メソッドを呼び出そうとして、変数 <code class="highlighter-rouge">baz</code> が無いため NameError になります。</p>

<h3 id="文字エンコーディング関係">文字エンコーディング関係</h3>

<p>本セクションでは文字エンコーディング関係のことがらをまとめました。</p>

<h4 id="tempfile-のオープンモード"><code class="highlighter-rouge">Tempfile</code> のオープンモード</h4>

<p>Ruby 1.9 で文字エンコーディングに関する機能が組み込まれた事で、IO オブジェクトにも文字エンコーディング関連の新しい振る舞いが増えています。それは、IO オブジェクトが持つ外部エンコーディングと内部エンコーディングです。外部エンコーディングは IO オブジェクトの向こう側にあるもの (e.g. ファイル) が持つデータのエンコーディングです。IO オブジェクトから読み込んだ文字列は、IO オブジェクトに外部エンコーディングとして指定した文字エンコーディングを持っています。特に指定しない場合、デフォルトの外部エンコーディングは <code class="highlighter-rouge">Encoding.default_external</code> で指定された文字エンコーディングになります。入力文字列を外部エンコーディングとは異なる文字エンコーディングへ自動変換する場合は、その変換先の文字エンコーディングを IO オブジェクトの内部エンコーディングに設定します。</p>

<p>このような仕組みが増えたことで、バイナリファイルを開いて作業する際は、ファイルのオープンモードを <code class="highlighter-rouge">'rb'</code> や <code class="highlighter-rouge">'wb'</code> にして明示的にバイナリモードで開くか、ファイルを開いた後で <code class="highlighter-rouge">IO#set_encoding</code> を使用して外部エンコーディングを <code class="highlighter-rouge">ASCII-8BIT</code> または <code class="highlighter-rouge">BINARY</code> に設定する必要があります。</p>

<p>クックパッドには、Eメールで投稿された画像データを処理しているコードがあり、この部分でメールから取り出した画像データを一時的にファイルに書き出して処理しています。一時ファイルを取り扱うために標準ライブラリで提供されている <code class="highlighter-rouge">Tempfile</code> を使っているのですが、<code class="highlighter-rouge">Tempfile</code> が使用するオープンモードは <code class="highlighter-rouge">'w+'</code> に固定されていて、かつ、<code class="highlighter-rouge">Encoding.default_external</code> が UTF-8 になっていたため、画像データを書き込む際に Invalid byte sequence が発生してしまいました。</p>

<p>これの解決方法としては、IO#set_encoding メソッドでエンコーディングを変更する方法と Tempfile.new に encoding オプションを使う方法の2種類があります。既にオープンされた Tempfile オブジェクトが与えられる場合は前者を、自分で Tempfile.new できる場合は後者を採用して解決します。</p>

<h4 id="nkf-kconv-jcode-iconv">nkf, kconv, jcode, iconv</h4>

<p>Ruby 1.9 から文字エンコーディングの仕組みが組み込まれたことで、1.8 で標準だった  kconv, jcode, iconv などの文字エンコーディング関係のライブラリの使用は非推奨になっています。</p>

<p>クックパッドのコードでは、これらと nkf のそれぞれに依存しているコードが散らばっている状態でした。私はそれらを整理し、1.8 での文字エンコーディング関連の処理は NKF だけに依存するようにして、1.9 では原則として組み込みのエンコーディング変換機能のみを使用するように修正したいと考えました。そこで次のモンキーパッチを String クラスに対して導入し、それだけを使用するようにアプリケーションコードを書き換えました。</p>

<div class="language-ruby highlighter-rouge"><pre class="highlight"><code><span class="c1"># Ruby 1.8 に対するモンキーパッチ</span>
<span class="k">class</span> <span class="nc">String</span>
  <span class="k">alias</span> <span class="n">b</span> <span class="nb">dup</span>

  <span class="k">def</span> <span class="nf">force_encoding</span><span class="p">(</span><span class="n">encoding</span><span class="p">)</span>
    <span class="nb">self</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">to_utf8_from_win31j</span>
    <span class="n">encode_to_utf8</span><span class="p">(</span><span class="s1">'Windows-31J'</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">to_win31j_from_utf8</span>
    <span class="n">encode_from_utf8</span><span class="p">(</span><span class="s1">'Windows-31J'</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">to_utf8_from_cp50221</span>
    <span class="n">encode_to_utf8</span><span class="p">(</span><span class="s1">'CP50221'</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">to_cp50221_from_utf8</span>
    <span class="n">encode_from_utf8</span><span class="p">(</span><span class="s1">'CP50221'</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">encode_to_utf8</span><span class="p">(</span><span class="n">from_encoding</span><span class="p">)</span>
    <span class="n">nkf_options</span> <span class="o">=</span> <span class="k">case</span> <span class="n">from_encoding</span>
                  <span class="k">when</span> <span class="s1">'Windows-31J'</span>
                    <span class="s1">'-S'</span>
                  <span class="k">when</span> <span class="s1">'CP50221'</span>
                    <span class="s1">'-J'</span>
                  <span class="k">else</span>
                    <span class="k">raise</span> <span class="s1">'invalid encoding'</span>
                  <span class="k">end</span>
    <span class="n">nkf_options</span> <span class="o">+=</span> <span class="s1">' -w -m0 -x'</span>
    <span class="no">NKF</span><span class="p">.</span><span class="nf">nkf</span><span class="p">(</span><span class="n">nkf_options</span><span class="p">,</span> <span class="nb">self</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">encode_from_utf8</span><span class="p">(</span><span class="n">to_encoding</span><span class="p">)</span>
    <span class="n">nkf_options</span> <span class="o">=</span> <span class="k">case</span> <span class="n">from_encoding</span>
                  <span class="k">when</span> <span class="s1">'Windows-31J'</span>
                    <span class="s1">'-s'</span>
                  <span class="k">when</span> <span class="s1">'CP50221'</span>
                    <span class="s1">'-j'</span>
                  <span class="k">else</span>
                    <span class="k">raise</span> <span class="s1">'invalid encoding'</span>
                  <span class="k">end</span>
    <span class="n">nkf_options</span> <span class="o">+=</span> <span class="s1">' -W -m0 -x'</span>
    <span class="no">NKF</span><span class="p">.</span><span class="nf">nkf</span><span class="p">(</span><span class="n">nkf_options</span><span class="p">,</span> <span class="nb">self</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>

</code></pre>
</div>

<p>文字エンコーディング変換処理のほとんどの用途は、ガラケーに対応する際の UTF-8 と Windows-31J の間での変換と、メール処理での UTF-8 と CP50221 の間の変換です。そのため、この2つの場合に対しては専用のメソッドを用意しておきました。</p>

<p>次に Ruby 1.9 用のモンキーパッチを示します。1.9 では、nkf と挙動をそろえるために、未定義コードポイントや不正なバイト列に対して空文字でフォールバックするようにしています。</p>

<div class="language-ruby highlighter-rouge"><pre class="highlight"><code><span class="c1"># Ruby 1.9 に対するモンキーパッチ</span>
<span class="k">class</span> <span class="nc">String</span>
  <span class="k">def</span> <span class="nf">b</span>
    <span class="nb">dup</span><span class="p">.</span><span class="nf">force_encoding</span><span class="p">(</span><span class="s1">'BINARY'</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">to_utf8_from_win31j</span>
    <span class="n">encode_to_utf8</span><span class="p">(</span><span class="s1">'Windows-31J'</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">to_win31j_from_utf8</span>
    <span class="n">encode_from_utf8</span><span class="p">(</span><span class="s1">'Windows-31J'</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">to_utf8_from_cp50221</span>
    <span class="n">encode_to_utf8</span><span class="p">(</span><span class="s1">'CP50221'</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">to_cp50221_from_utf8</span>
    <span class="n">encode_from_utf8</span><span class="p">(</span><span class="s1">'CP50221'</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">encode_to_utf8</span><span class="p">(</span><span class="n">from_encoding</span><span class="p">)</span>
    <span class="n">encode</span><span class="p">(</span><span class="s1">'UTF-8'</span><span class="p">,</span> <span class="n">from_encoding</span><span class="p">,</span> <span class="ss">:invalid</span> <span class="o">=&gt;</span> <span class="ss">:replace</span><span class="p">,</span> <span class="ss">:undef</span> <span class="o">=&gt;</span> <span class="ss">:replace</span><span class="p">,</span> <span class="ss">:replace</span> <span class="o">=&gt;</span> <span class="s1">''</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">encode_from_utf8</span><span class="p">(</span><span class="n">to_encoding</span><span class="p">)</span>
    <span class="n">encode</span><span class="p">(</span><span class="n">to_encoding</span><span class="p">,</span> <span class="s1">'UTF-8'</span><span class="p">,</span> <span class="ss">:invalid</span> <span class="o">=&gt;</span> <span class="ss">:replace</span><span class="p">,</span> <span class="ss">:undef</span> <span class="o">=&gt;</span> <span class="ss">:replace</span><span class="p">,</span> <span class="ss">:replace</span> <span class="o">=&gt;</span> <span class="s1">''</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>

</code></pre>
</div>

<h4 id="独自の-stringblank">独自の <code class="highlighter-rouge">String#blank?</code></h4>

<p>Ruby 1.9 では正規表現も文字エンコーディングを保持します。そのため、正規表現と文字列が持つ文字エンコーディングが比較に対して互換でなければエラーが出てしまいます。</p>

<p>クックパッドで使用している <code class="highlighter-rouge">String#blank?</code> は、IDEOGRAPHIC SPACE (U+3000) も空白として扱うようカスタマイズしてあるのですが、文字列自身の文字エンコーディングが UTF-8 ではない場合に incompatible encoding regexp match というエラーが出てしまいました。この問題に対しては、Ruby 1.9 の場合に以下のような <code class="highlighter-rouge">String#blank?</code> を使用することで対応しました。</p>

<div class="language-ruby highlighter-rouge"><pre class="highlight"><code><span class="k">class</span> <span class="nc">String</span>
  <span class="k">def</span> <span class="nf">blank?</span>
    <span class="k">case</span> <span class="n">encoding</span>
    <span class="k">when</span> <span class="no">Encoding</span><span class="o">::</span><span class="no">UTF_8</span>
      <span class="sr">/\A[\s\u{3000}]*\z/</span> <span class="o">===</span> <span class="nb">self</span>
    <span class="k">when</span> <span class="no">Encoding</span><span class="o">::</span><span class="no">US_ASCII</span><span class="p">,</span> <span class="no">Encoding</span><span class="o">::</span><span class="no">ASCII_8BIT</span>
      <span class="sr">/\A\s*\z/</span> <span class="o">===</span> <span class="nb">self</span>
    <span class="k">else</span>
      <span class="k">begin</span>
        <span class="nb">self</span><span class="p">.</span><span class="nf">encode</span><span class="p">(</span><span class="s1">'UTF-8'</span><span class="p">).</span><span class="nf">blank?</span>
      <span class="k">rescue</span>
        <span class="nb">self</span><span class="p">.</span><span class="nf">dup</span><span class="p">.</span><span class="nf">force_encoding</span><span class="p">(</span><span class="s1">'BINARY'</span><span class="p">).</span><span class="nf">blank?</span>
      <span class="k">end</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>

</code></pre>
</div>

<p>上記のコードは UTF-8 とバイナリを特別扱いしています。他に良く使用される文字エンコーディングが存在するなら、それも特別扱いすると再帰呼び出しコストを抑えることができるでしょう。</p>

<h3 id="200-への移行">2.0.0 への移行</h3>

<p>Ruby 1.9.3 から Ruby 2.0.0 へ移行する際に出会った問題について説明します。</p>

<h4 id="objectinitialize_clone-と-objectinitialize_dup-がプライベートメソッドになった"><code class="highlighter-rouge">Object#initialize_clone</code> と <code class="highlighter-rouge">Object#initialize_dup</code> がプライベートメソッドになった</h4>

<p>Ruby 2.0 では <code class="highlighter-rouge">Object#initialize_clone</code> と <code class="highlighter-rouge">Object#initialize_dup</code> がプライベートメソッドになりました。そのため、Rails に<a href="https://github.com/rails/rails/commit/127411fdf3a3470e8830abf0c7876db67c0c344a">このパッチ</a>を適用する必要がありました。<sup id="fnref:4"><a href="#fn:4" class="footnote">4</a></sup></p>

<h4 id="スレッド周辺の非互換性">スレッド周辺の非互換性</h4>

<p>Ruby 2.0.0 ではスレッド周辺の実装が改善されていますが、これが 1.9.3 との非互換性を生み出しています。クックパッドがハマった非互換性は、シグナルハンドラの中で Mutex のロックを取得できなくなったことです。あるシグナルハンドラの中で FluentLogger に情報を記録する処理が存在していたのですが、FluentLogger は書き込み時に Mutex のロックを取得する場合があり、そのため例外が発生してしまいました。</p>

<p>FluentLogger に書き込んでいた情報が現在は必要ない情報であったため、シグナルハンドラを削除して解決させました。</p>

<h4 id="rubygems-のバグ">rubygems のバグ</h4>

<p>Ruby 2.0.0-p0 に同梱されてる rubygems にバグがあって bson_ext の拡張ライブラリが正常にインストールされない問題が起きました。この問題は 2.0.0-p0 リリース後に ruby_2_0_0 ブランチで修正されました。クックパッドでは、rubygems だけを修正済みのリビジョンに置き換えることで対応しました。</p>

<h3 id="バージョンアップ対応の進め方">バージョンアップ対応の進め方</h3>

<p>Ruby 1.9.3 へのバージョンアップ対応では、常に Ruby Enterprise Edition  と Ruby 1.9.3 の両方でテストが通る状態を維持することに努めました。Ruby 2.0.0 へのバージョンアップ対応も同様に、Ruby 1.9.3 と Ruby 2.0.0 の両方でテストが通る状態を維持しながら進めました。</p>

<p>このような方法を採用した理由は、新バージョンへ対応するための変更を「バージョン移行用ブランチ」に溜めず、master ブランチに次々とマージできるようになるからです。</p>

<p>Ruby のバージョンアップでは、バージョン間の差をモンキーパッチで吸収しやすいので、このような方法をとることができます。</p>

<p>一方、Rails のバージョンアップでは、バージョン間差異をモンキーパッチで吸収しにくい為、バージョン移行用のブランチ内で作業する必要があります (本稿で扱っているクックパッドは、Rails がバージョン 1 の頃のコードベースを使い続け、Rails のバージョンアップを何度か実施し、現在は Rails 3.2 系で運用しています)。</p>

<h2 id="ruby-のバージョンアップした結果">Ruby のバージョンアップした結果</h2>

<p>Ruby をバージョンアップすることで、2点うれしいことがありました。</p>

<p>1つ目はサービスの平均レスポンスタイムが大きく改善されたことです。以下は、試験環境で計測したレスポンスタイムの比較です。クックパッドは本番環境での平均レスポンスタイムを 200ms 未満にすることを目標にしていますが、Ruby Enterprise Edition を使用していたときは目標を 100ms 以上も越えていることが多かったのに対して、Ruby を 1.9 にバージョンアップしただけで達成でき、かつ EC2 のインスタンス数を減らすこともできました。
<img src="/images/0042-MigratingARailsApplicationToRuby200/Screenshot_5_12_13_8_20_PM.png" alt="Screenshot_5_12_13_8_20_PM.png" /></p>

<p>2 つ目は、クックパッドが抱える大量の spec ファイルの実行時間が大幅に短縮されたことです。Ruby Enterprise Edition を使用しているときは、分散 RSpec で使用するワーカーの台数をいくら増やしても実行時間は 14 分を越えていました。ところが Ruby 1.9 へ移行することでサーバ 8 台で 12 分、Ruby 2.0 へ移行するとサーバ 6 台で 8 分台にまで短縮されました。</p>

<p>この結果は、Ruby 1.9 から導入されている YARV によって処理時間が短縮されたこと、さらにメモリの使用効率が非常に良くなっていることが効いていると考えています。メモリの使用傾向が変わったことで、Unicorn のワーカーの使用メモリ量の時間に対する増加の仕方がゆるやかになったため、プロセスが大幅に延命されました。</p>

<p>Ruby のバージョンアップによって、クックパッドのユーザと開発者の双方に大きな恩恵が与えられたことになります。</p>

<h2 id="まとめ">まとめ</h2>

<p>本記事では、Ruby Enterprise Edition 上で動いていた Rails アプリケーションを、Ruby 1.9.3、そして Ruby 2.0.0 に対応させた際に実施した問題対応についてまとめました。この情報が、読者のみなさんのお役に立てれば幸いです。</p>

<h2 id="著者について">著者について</h2>

<p>村田賢太（クックパッド株式会社）。北海道出身。CRuby のコミッタとして bigdecimal のメンテナンスを担当。2009年に北大で博士号を取得し札幌で就職。2年後に転職し現職へ。クックパッドでは開発基盤エンジニアとして社内のサービス開発エンジニアを幸せにすることで、世界中の料理を楽しくすることに間接的に貢献している。 Twitter: <a href="https://twitter.com/mrkn">@mrkn</a></p>

<hr />

<div class="footnotes">
  <ol>
    <li id="fn:1">
      <p>この記事が出た時には ruby-2.0.0-p195 がリリースされています。&nbsp;<a href="#fnref:1" class="reversefootnote">&#8617;</a></p>
    </li>
    <li id="fn:2">
      <p>名前が変わり、Object#object_id になりました。&nbsp;<a href="#fnref:2" class="reversefootnote">&#8617;</a></p>
    </li>
    <li id="fn:3">
      <p>まず :baz を引数に bar メソッドが呼び出され、その結果が foo メソッドに渡されます。&nbsp;<a href="#fnref:3" class="reversefootnote">&#8617;</a></p>
    </li>
    <li id="fn:4">
      <p>Object#respond_to? の第 2 引数に true を指定すると、private なメソッドも含めて調べてくれる。&nbsp;<a href="#fnref:4" class="reversefootnote">&#8617;</a></p>
    </li>
  </ol>
</div>

            </div>
        </div>
    </div>
  </body>
</html>
<!DOCTYPE html>
<html>
