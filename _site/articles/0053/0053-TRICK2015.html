<!DOCTYPE html>
<html>
  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>TRICK2015 開催報告＆入賞作品紹介</title>
  <meta name="description" content="">

  <script src="/js/jquery.min.js"></script>
  <script src="/js/bootstrap.min.js"></script>
  <link href="/css/bootstrap.min.css" rel="stylesheet" type="text/css">
  <link href="/css/theme.css" rel="stylesheet" type="text/css">
  <link href="/css/syntax.css" rel="stylesheet" type="text/css">

  <link rel="canonical" href="http://magazine.rubyist.net/articles/0053/0053-TRICK2015.html">
  <link rel="alternate" type="application/rss+xml" title="Rubyist Magazine" href="http://magazine.rubyist.net/feed.xml">
  <link rel="shortcut icon" href="/images/favicon.ico">
</head>

  <body>
    <div class="container-fluid">
        <div class="row full">
            <div class="col-md-2 hidden-xs sidebar">
                <h4>

</h4>

<h4>バックナンバー</h4>
<ul>
    
        <li><a href="/articles/0056/0056-index.html">0056号(2017-08)</a></li>
    
        <li><a href="/articles/0055/0055-index.html">0055号(2017-03)</a></li>
    
        <li><a href="/articles/0054/0054-index.html">0054号(2016-08)</a></li>
    
        <li><a href="/articles/pretokyorubykaigi11/preTokyoRubyKaigi11.html">東京 Ruby 会議 11 直前特集号</a></li>
    
        <li><a href="/articles/0053/0053-index.html">0053号(2016-04)</a></li>
    
        <li><a href="/articles/0052/0052-index.html">0052号(2015-12)</a></li>
    
        <li><a href="/articles/0051/0051-index.html">0051号(2015-09)</a></li>
    
        <li><a href="/articles/0050/0050-index.html">0050号(2015-05)</a></li>
    
        <li><a href="/articles/0049/0049-index.html">0049号(2014-12)</a></li>
    
        <li><a href="/articles/0048/0048-index.html">0048号(2014-09)</a></li>
    
        <li><a href="/articles/0047/0047-index.html">0047号(2014-06)</a></li>
    
        <li><a href="/articles/0046/0046-index.html">0046号(2014-04)</a></li>
    
        <li><a href="/articles/0045/0045-index.html">0045号(2013-12)</a></li>
    
        <li><a href="/articles/0044/0044-index.html">0044号(2013-09)</a></li>
    
        <li><a href="/articles/0043/0043-index.html">0043号(2013-07)</a></li>
    
        <li><a href="/articles/0042/0042-index.html">0042号(2013-05)</a></li>
    
        <li><a href="/articles/ruby200specialen/Ruby200SpecialEn.html">2.0.0 Special (EN)</a></li>
    
        <li><a href="/articles/0041/0041-index.html">0041号(2013-02)</a></li>
    
        <li><a href="/articles/0040/0040-index.html">0040号(2012-11)</a></li>
    
        <li><a href="/articles/0039/0039-index.html">0039号(2012-09)</a></li>
    
        <li><a href="/articles/rubykaja/kaja.html">RubyKaja のご紹介</a></li>
    
        <li><a href="/articles/0038/0038-index.html">0038号(2012-05)</a></li>
    
        <li><a href="/articles/0037/0037-index.html">0037号(2012-02)</a></li>
    
        <li><a href="/articles/0036/0036-index.html">0036号(2011-11)</a></li>
    
        <li><a href="/articles/0035/0035-index.html">0035号(2011-09)</a></li>
    
        <li><a href="/articles/prerubykaigi2011/preRubyKaigi2011.html">RubyKaigi2011直前特集号</a></li>
    
        <li><a href="/articles/0034/0034-index.html">0034号(2011-06)</a></li>
    
        <li><a href="/articles/0033/0033-index.html">0033号(2011-04)</a></li>
    
        <li><a href="/articles/0032/0032-index.html">0032号(2011-01)</a></li>
    
        <li><a href="/articles/0031/0031-index.html">0031号(2010-10)</a></li>
    
        <li><a href="/articles/prerubykaigi2010/preRubyKaigi2010.html">RubyKaigi2010直前特集号</a></li>
    
        <li><a href="/articles/0030/0030-index.html">0030号(2010-06)</a></li>
    
        <li><a href="/articles/0029/0029-index.html">0029号(2010-03)</a></li>
    
        <li><a href="/articles/0028/0028-index.html">0028号(2009-12)</a></li>
    
        <li><a href="/articles/0027/0027-index.html">0027号(2009-09)</a></li>
    
        <li><a href="/articles/0026/0026-index.html">0026号(2009-06)</a></li>
    
        <li><a href="/articles/0025/0025-index.html">0025号(2009-02)</a></li>
    
        <li><a href="/articles/0024/0024-index.html">0024号(2008-10)</a></li>
    
        <li><a href="/articles/0023/0023-index.html">0023号(2008-03)</a></li>
    
        <li><a href="/articles/0022/0022-index.html">0022号(2007-12)</a></li>
    
        <li><a href="/articles/0021/0021-index.html">0021号(2007-09)</a></li>
    
        <li><a href="/articles/0020/0020-index.html">0020号(2007-08)</a></li>
    
        <li><a href="/articles/0019/0019-index.html">0019号(2007-05)</a></li>
    
        <li><a href="/articles/0018/0018-index.html">0018号(2007-02)</a></li>
    
        <li><a href="/articles/0017/0017-index.html">0017号(2006-11)</a></li>
    
        <li><a href="/articles/0016/0016-index.html">0016号(2006-09)</a></li>
    
        <li><a href="/articles/0015/0015-index.html">0015号(2006-07)</a></li>
    
        <li><a href="/articles/rubykaigi2006/RubyKaigi2006-index.html">日本 Ruby カンファレンス 2006 特別号</a></li>
    
        <li><a href="/articles/0014/0014-index.html">0014号(2006-05)</a></li>
    
        <li><a href="/articles/0013/0013-index.html">0013号(2006-02)</a></li>
    
        <li><a href="/articles/0012/0012-index.html">0012号(2005-12)</a></li>
    
        <li><a href="/articles/0011/0011-index.html">0011号(2005-11)</a></li>
    
        <li><a href="/articles/0010/0010-index.html">0010号(2005-10)</a></li>
    
        <li><a href="/articles/0009/0009-index.html">0009号(2005-09)</a></li>
    
        <li><a href="/articles/0008/0008-index.html">0008号(2005-07)</a></li>
    
        <li><a href="/articles/0007/0007-index.html">0007号(2005-06)</a></li>
    
        <li><a href="/articles/0006/0006-index.html">0006号(2005-05)</a></li>
    
        <li><a href="/articles/0005/0005-index.html">0005号(2005-02)</a></li>
    
        <li><a href="/articles/0004/0004-index.html">0004号(2004-12)</a></li>
    
        <li><a href="/articles/0003/0003-index.html">0003号(2004-11)</a></li>
    
        <li><a href="/articles/0002/0002-index.html">0002号(2004-10)</a></li>
    
        <li><a href="/articles/0001/0001-index.html">0001号(2004-09)</a></li>
    
</ul>
<p class="rss-subscribe"><a href="/feed.xml">RSS</a></p>

            </div>
            <div class="col-md-10 main">
                <div class="row">
                    <div class="col-md-12">
                        <img src="/images/rubima_logo_l.png">
                        <h1>TRICK2015 開催報告＆入賞作品紹介</h1>
                        <div class="social-buttons">
                            <a href="http://b.hatena.ne.jp/entry//articles/0053/0053-TRICK2015.html" class="hatena-bookmark-button" data-hatena-bookmark-title="TRICK2015 開催報告＆入賞作品紹介" data-hatena-bookmark-layout="simple-balloon" title="このエントリーをはてなブックマークに追加"><img src="https://b.st-hatena.com/images/entry-button/button-only@2x.png" alt="このエントリーをはてなブックマークに追加" width="20" height="20" style="border: none;" /></a><script type="text/javascript" src="https://b.st-hatena.com/js/bookmark_button.js" charset="utf-8" async="async"></script>
<span id="fb-root"></span>
<script>(function(d, s, id) {
  var js, fjs = d.getElementsByTagName(s)[0];
  if (d.getElementById(id)) return;
  js = d.createElement(s); js.id = id;
  js.src = "//connect.facebook.net/ja_JP/sdk.js#xfbml=1&version=v2.5";
  fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));</script>
<span class="fb-like" data-href="/articles/0053/0053-TRICK2015.html" data-layout="button_count" data-action="like" data-show-faces="false" data-share="false"></span>
<a href="https://twitter.com/share" class="twitter-share-button" data-url="/articles/0053/0053-TRICK2015.html" data-text="TRICK2015 開催報告＆入賞作品紹介">ツイート</a>
<script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');</script>

                        </div>
                        <ul id="markdown-toc">
  <li><a href="#はじめに" id="markdown-toc-はじめに">はじめに</a></li>
  <li><a href="#trick-について" id="markdown-toc-trick-について">TRICK について</a></li>
  <li><a href="#入賞作品一覧" id="markdown-toc-入賞作品一覧">入賞作品一覧</a>    <ul>
      <li><a href="#上位-5-位" id="markdown-toc-上位-5-位">上位 5 位</a></li>
      <li><a href="#審査員賞" id="markdown-toc-審査員賞">審査員賞</a></li>
    </ul>
  </li>
  <li><a href="#各作品解説" id="markdown-toc-各作品解説">各作品解説</a>    <ul>
      <li><a href="#金賞-best-piphilology" id="markdown-toc-金賞-best-piphilology">金賞: “Best piphilology”</a>        <ul>
          <li><a href="#解説" id="markdown-toc-解説">解説</a></li>
        </ul>
      </li>
      <li><a href="#銀賞-most-unreadable-alu" id="markdown-toc-銀賞-most-unreadable-alu">銀賞: “Most unreadable ALU”</a>        <ul>
          <li><a href="#解説-1" id="markdown-toc-解説-1">解説</a></li>
        </ul>
      </li>
      <li><a href="#銅賞-doubling-amphisbaena-award" id="markdown-toc-銅賞-doubling-amphisbaena-award">銅賞: “Doubling amphisbaena award”</a>        <ul>
          <li><a href="#解説-2" id="markdown-toc-解説-2">解説</a></li>
        </ul>
      </li>
      <li><a href="#4位-least-general-solver" id="markdown-toc-4位-least-general-solver">4位: “Least general solver”</a>        <ul>
          <li><a href="#解説-3" id="markdown-toc-解説-3">解説</a></li>
        </ul>
      </li>
      <li><a href="#5位-most-general-solver" id="markdown-toc-5位-most-general-solver">5位: “Most general solver”</a>        <ul>
          <li><a href="#解説-4" id="markdown-toc-解説-4">解説</a></li>
        </ul>
      </li>
      <li><a href="#yhara-賞-most-beautiful-pattern" id="markdown-toc-yhara-賞-most-beautiful-pattern">yhara 賞： “Most beautiful pattern”</a>        <ul>
          <li><a href="#解説-5" id="markdown-toc-解説-5">解説</a></li>
        </ul>
      </li>
      <li><a href="#shinh-賞-most-fragile" id="markdown-toc-shinh-賞-most-fragile">shinh 賞: “Most fragile”</a>        <ul>
          <li><a href="#解説-6" id="markdown-toc-解説-6">解説</a></li>
        </ul>
      </li>
      <li><a href="#matz-賞-matz-lisp-award" id="markdown-toc-matz-賞-matz-lisp-award">matz 賞: “Matz Lisp award”</a>        <ul>
          <li><a href="#解説-7" id="markdown-toc-解説-7">解説</a></li>
        </ul>
      </li>
      <li><a href="#mame-賞-most-timely" id="markdown-toc-mame-賞-most-timely">mame 賞: “Most timely”</a>        <ul>
          <li><a href="#解説-8" id="markdown-toc-解説-8">解説</a></li>
        </ul>
      </li>
      <li><a href="#eban-賞-best-document" id="markdown-toc-eban-賞-best-document">eban 賞: “Best document”</a>        <ul>
          <li><a href="#解説-9" id="markdown-toc-解説-9">解説</a></li>
        </ul>
      </li>
      <li><a href="#leonid-賞-most-inconsistent" id="markdown-toc-leonid-賞-most-inconsistent">leonid 賞: “Most inconsistent”</a>        <ul>
          <li><a href="#解説-10" id="markdown-toc-解説-10">解説</a></li>
        </ul>
      </li>
      <li><a href="#eto-賞-most-illusionistic" id="markdown-toc-eto-賞-most-illusionistic">eto 賞: “Most illusionistic”</a>        <ul>
          <li><a href="#解説-11" id="markdown-toc-解説-11">解説</a></li>
        </ul>
      </li>
      <li><a href="#景品" id="markdown-toc-景品">景品</a></li>
      <li><a href="#全体評" id="markdown-toc-全体評">全体評</a></li>
      <li><a href="#まとめ" id="markdown-toc-まとめ">まとめ</a></li>
    </ul>
  </li>
  <li><a href="#筆者について" id="markdown-toc-筆者について">筆者について</a></li>
</ul>

<p>書いた人： 遠藤侑介 (<a href="https://twitter.com/mametter">@mametter</a>)</p>

<h2 id="はじめに">はじめに</h2>

<p>TRICK は、Ruby を使って「変」なプログラムを書き、その「変」度で競い合うプログラミングコンテストです。第 2 回となる TRICK 2015 は、RubyKaigi 2015 の場を借りて結果発表を行いました。この記事はその入賞作品について紹介していきます。</p>

<h2 id="trick-について">TRICK について</h2>

<p>TRICK は Transcendental Ruby Imbroglio Contest for rubyKaigi の略で、日本語にすると「超絶技巧 Ruby 意味不明コンテスト」という意味です。</p>

<p>内容としては上述の通り、競い合って変なプログラムを書き、愛でようというイベントです。Ruby は「読みやすいプログラム」だけでなく、「読みにくいプログラム」を書く言語としても一流であることを実証したいと思ってます。<a href="http://ioccc.org/">IOCCC</a> をご存知の方は、それの Ruby 版と考えて貰えば早いです。</p>

<p>開催の目的やルール、審査員などについては、<a href="https://github.com/tric/trick2015/blob/master/README.ja.md">公式サイト</a>をご覧ください。基本的に第 1 回の TRICK 2013 から変わっていないので、<a href="http://magazine.rubyist.net/?0043-TRICK2013">過去の開催報告</a>もあわせてご覧ください。</p>

<h2 id="入賞作品一覧">入賞作品一覧</h2>

<p>今回の入賞は 12 作品です。総合点で上位だったトップ 5 作品に加え、審査員ごとに最高点を取った 7 作品を入賞としました。入賞作品は<a href="http://github.com/tric/trick2015/">公式サイト</a>で公開しています。</p>

<h3 id="上位-5-位">上位 5 位</h3>

<ul>
  <li><strong>金賞: “Best piphilology”</strong> - kinaba</li>
  <li><strong>銀賞: “Most unreadable ALU”</strong> - Keisuke Nakano</li>
  <li><strong>銅賞: “Doubling amphisbaena award”</strong> - monae</li>
  <li><strong>4位: “Least general solver”</strong> - Benoit Daloze (eregon)</li>
  <li><strong>5位: “Most general solver”</strong>- Keisuke Nakano</li>
</ul>

<h3 id="審査員賞">審査員賞</h3>

<ul>
  <li><strong>leonid 賞: “Most inconsistent”</strong> - Koichi Sasada (ko1)</li>
  <li><strong>eto 賞: “Most illusionistic”</strong> - Don Yang</li>
  <li><strong>eban 賞: “Best document”</strong> - yoshi-taka</li>
  <li><strong>mame 賞: “Most timely”</strong> - Koichi Sasada (ko1)</li>
  <li><strong>matz 賞: “Matz Lisp award”</strong> - Kazuki Tsujimoto</li>
  <li><strong>shinh 賞: “Most fragile”</strong> - NAKAMURA Usaku</li>
  <li><strong>yhara 賞: “Most beautiful pattern”</strong> - Shinichiro Hamaji</li>
</ul>

<h2 id="各作品解説">各作品解説</h2>

<p>以下、各作品をネタバレ気にせず紹介していきます。自分で読解を楽しみたい人はご注意ください。</p>

<h3 id="金賞-best-piphilology">金賞: “Best piphilology”</h3>

<ul>
  <li>入賞者： kinaba</li>
  <li>ソースコード： <a href="https://github.com/tric/trick2015/blob/master/kinaba/entry.rb">https://github.com/tric/trick2015/blob/master/kinaba/entry.rb</a></li>
  <li>勝者の声：<a href="http://www.kmonos.net/wlog/140.html#_2126151211">http://www.kmonos.net/wlog/140.html#_2126151211</a></li>
</ul>

<p>「円周率おぼえ歌」を Ruby で実現したものです。プログラムのトークンの長さを順番に見ていくと、</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text">   big , temp = Array 100000000 ** 0x04e2
    3  1   4  1   5       9      2    6</code></pre></figure>

<p>ということで、円周率の桁数が出てきます。そして、実行すると円周率 10000 桁が出力されます。</p>

<h4 id="解説">解説</h4>

<p>これはとても強烈なプログラムでした。グローバル変数の alias を使うことで、異なる桁数のトークンから同じ変数にアクセスしたり、前の乱数の種を返り値とする srand を記憶領域として使ったり、まさに TRICK でしか使えないような知識がいろいろ発見されました。</p>

<p>さすがにすべてのトークンを活用するのは難しいということで、桁合わせのために無意味なトークンが挿入されています。77 の本質的に必要なトークンに対し、165 のムダなトークンがあるとのことで、何倍に膨れ上がったかを計算すると、(165 + 77) / 77 ≒ 3.14 になるという。無意味さの中にも意味を入れるという、隙のないプログラムでした。</p>

<p>詳しくは、<a href="http://www.kmonos.net/wlog/140.html#_2126151211">作者の kinaba さんが解説している</a>ので、そちらもお読みください。</p>

<p>なお、誤解してはいけないのは、3文字＋スペース＋1文字＋スペース＋4文字＋… というだけのプログラムではないことです。1+1 とスペースを空けずに書いても、トークンとしては 1 文字が 3 つになります。</p>

<h3 id="銀賞-most-unreadable-alu">銀賞: “Most unreadable ALU”</h3>

<ul>
  <li>入賞者： Keisuke Nakano</li>
  <li>ソースコード： <a href="https://github.com/tric/trick2015/blob/master/ksk_1/entry.rb">https://github.com/tric/trick2015/blob/master/ksk_1/entry.rb</a></li>
</ul>

<p>コラッツ数列<sup id="fnref:1"><a href="#fn:1" class="footnote">1</a></sup>の生成器です。これを、整数演算も分岐も使わずに実現しています。</p>

<h4 id="解説-1">解説</h4>

<p>全体的に % だらけの意味不明なプログラムになっています。N の偶奇によって処理を切り替える仕組みを整数演算も分岐も使わずに実現するトリックだけ紹介します。</p>

<p>”, という 2 文字を N 回繰り返す、次のようなプログラム文字列を作って eval します。</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text">[ ", ", ..., ", ]; even #"]; odd</code></pre></figure>

<p>N が偶数の場合、例えば 4 のときは次のようになります。</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text">[ ", ", ", ", ]; even #"]; odd</code></pre></figure>

<p>見ての通り、意味のない配列リテラルの直後にある even が実行されます。odd はコメントアウトされます。</p>

<p>N が奇数の場合、例えば 3 の場合は次のようになります。</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text">[ ", ", ", ]; even #"]; odd</code></pre></figure>

<p>even やコメント記号が文字列リテラルに閉じ込められ、odd が地の文として現れてきます。以上。</p>

<p>このように整数演算や分岐を使っていないところもすごいんですが、それだけでなく、意味ありげに見える文字列に意味がなかったり、意味なさそうに見える文字列が重要な意味を持っていたり、これほど読みにくい 106 バイトはなかなかお目にかかれません。ぜひ解読に挑戦してください。これも<a href="http://d.hatena.ne.jp/KeisukeNakano/20151213">作者の Keisuke Nakano さん自身が詳しく解説してくださっている</a>ので、そちらをお読みください。</p>

<h3 id="銅賞-doubling-amphisbaena-award">銅賞: “Doubling amphisbaena award”</h3>

<ul>
  <li>入賞者：monae</li>
  <li>ソースコード： <a href="https://github.com/tric/trick2015/blob/master/monae/entry.rb">https://github.com/tric/trick2015/blob/master/monae/entry.rb</a></li>
  <li>勝者の声：<a href="http://monae.github.io/trick2015.html">http://monae.github.io/trick2015.html</a></li>
</ul>

<p>実行すると、自分自身を 2 倍に増殖させたプログラムを表示します。それを実行するとさらに 2 倍に、と、ドンドン大きくなっていきます。</p>

<h4 id="解説-2">解説</h4>

<p>アンフィスバエナというのは、しっぽも頭になっている双頭の蛇のことですが、よくドラゴンのように書かれるようです。それにちなんで、プログラムの形状はドラゴン曲線（の亜種）になってます。</p>

<p>挙動自体はわりと普通と言えなくもないんですが、コードがかなり簡潔にまとまっていて、多くの審査員の心を打ってこの順位となりました。<a href="http://monae.github.io/trick2015.html">作者の monae さんが詳しく解説している</a>ので、そちらをどうぞ。</p>

<h3 id="4位-least-general-solver">4位: “Least general solver”</h3>

<ul>
  <li>入賞者： Benoit Daloze (eregon)</li>
  <li>ソースコード： <a href="https://github.com/tric/trick2015/blob/master/eregon/entry.rb">https://github.com/tric/trick2015/blob/master/eregon/entry.rb</a></li>
</ul>

<p>数独ソルバです。単に 1 つの解を見つけるのではなく、全部の解を列挙します。なお、数独の問題は、コード中に直接埋め込んであります。当然、盤面は固定ではなく、書き換え可です。</p>

<h4 id="解説-3">解説</h4>

<p>1 行めのコードが難読化の肝です。</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text">class String;def[]*a;$*&lt;&lt;a;b;end</code></pre></figure>

<p>String#[] を再定義し、引数の列を $* に追加しています。$* はコマンドライン引数の配列ですが、ゴルフ界隈では空として初期化済みの配列として使われます。b は String#b で、バイナリエンコーディングの文字列を返すメソッドですが、このプログラムでは事実上の self として使っています。エンコーディングなんかどうでもいい。</p>

<p>このような String#[] を定義すると何が嬉しいかというと、</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text">   code="pri"[1, 2, 3]+"nt 1"</code></pre></figure>

<p>というコードを実行した時、変数 code には “print 1” というプログラム文字列が代入され、$* には <a href="1, 2, 3">1, 2, 3</a> という数列が入ります。これによって、プログラム本体に割り込んでくる数独盤面のゴミ文字列を巧妙に回避しつつ、その盤面の情報も記憶することができています。</p>

<p>数独を解くプログラム本体は、Fiber を使って全探索をするコードが書かれています。たいへん教科書的なコードですが、Fiber での探索は慣れていないとなかなか解読が大変だと思います。でも勉強になるので、ぜひ解読してください。</p>

<p>ちなみに、5 位の SAT ソルバもこの数独ソルバもどちらも NP 完全問題の解を見つけるプログラムですが、SAT ソルバは色々な問題に応用できるのに対し、この数独ソルバは数独にしか使えません<sup id="fnref:2"><a href="#fn:2" class="footnote">2</a></sup>。ということで、数独ソルバの方がより役に立たないわけですが、役に立たない方が上位に来たのは TRICK らしくていいなあと個人的に思っています。</p>

<h3 id="5位-most-general-solver">5位: “Most general solver”</h3>

<ul>
  <li>入賞者： Keisuke Nakano</li>
  <li>ソースコード： <a href="https://github.com/tric/trick2015/blob/master/ksk_2/entry.rb">https://github.com/tric/trick2015/blob/master/ksk_2/entry.rb</a></li>
  <li>勝者の声：<a href="http://d.hatena.ne.jp/KeisukeNakano/20151213">http://d.hatena.ne.jp/KeisukeNakano/20151213</a></li>
</ul>

<p>194 バイトの SAT ソルバです。以上。</p>

<h4 id="解説-4">解説</h4>

<p>一定の形式をした論理式を真にするような変数割当を見つける問題を、<a href="https://ja.wikipedia.org/wiki/%E5%85%85%E8%B6%B3%E5%8F%AF%E8%83%BD%E6%80%A7%E5%95%8F%E9%A1%8C">充足可能性問題 (Satisfiability problem, SAT)</a> といいます。</p>

<p>以下、Ruby の式を使って説明します。x &amp;&amp; !y という式が与えられたとき、これを真にするには x = true; y = false としておけばいいです。x &amp;&amp; !x は、x にどのような値を入れても真にすることはできません<sup id="fnref:3"><a href="#fn:3" class="footnote">3</a></sup>。こういうふうに、式が与えられたとき、それを真にするように変数の値を決めていく問題が SAT です。<sup id="fnref:4"><a href="#fn:4" class="footnote">4</a></sup></p>

<p>そして SAT ソルバとは、SAT 問題を解いてくれるツールのことです。有名な SAT ソルバには <a href="http://minisat.se/">MiniSAT</a> や <a href="http://www.sat4j.org/">Sat4j</a> などがあり、さらにこれらを改良したり組み込んだりした亜種がいろいろ存在します。SAT ソルバは、何か解きたい問題があるときに、その問題を SAT に変換し、SAT ソルバで解を見つけて、解を逆変換する、という風に使われます。興味のある人は調べてください。</p>

<p>……という SAT ソルバと、（理論上は）同等の振る舞いをするプログラムを、たった 194 バイトで実現したというのがこの作品です。SAT 問題を正規表現マッチングの問題に変換し、正規表現エンジンにぶん投げるという仕組みになっています。（後方参照のある）正規表現マッチングは NP 完全問題なんですよね。詳しくは、<a href="http://d.hatena.ne.jp/KeisukeNakano/20151213">作者の Keisuke Nakano さん自身が丁寧に解説してくださっている</a>ので、そちらをお読みください。なお、Keisuke Nakano (ksk) さんは著名な Ruby ゴルファーです。</p>

<p>後日談として、この SAT ソルバは果たして最小なのか？ということで、TRICK の審査員のひとりである浜地慎一郎 (shinh) さんが経営する<a href="http://golf.shinh.org/p.rb?SAT+solver">ゴルフ場</a>で同様のプログラムを書くコンペが開かれたようです。チートっぽいのを除けば、shinh さん自身が書いた 188B が今のところ最短のよう？</p>

<h3 id="yhara-賞-most-beautiful-pattern">yhara 賞： “Most beautiful pattern”</h3>

<ul>
  <li>入賞者： Shinichiro Hamaji</li>
  <li>ソースコード： <a href="https://github.com/tric/trick2015/blob/master/shinh/entry.rb">https://github.com/tric/trick2015/blob/master/shinh/entry.rb</a></li>
</ul>

<p>コードがバラバラ殺人事件です。もちろん、このままちゃんと動きます。実行すると、自分自身のソースコードを出力します。つまり Quine ですね。</p>

<h4 id="解説-5">解説</h4>

<p>これの肝は「ほぼ 2 文字単位でバラバラにするという形状制約の下で、如何に eval を呼ぶか」というところになります。これは大変込み入っているので発表時には割愛したんですが、ここで要点だけ説明します。</p>

<p>Ruby には、eval という文字列を使わずに eval を呼び出すという、何とも意味不明なイディオムというのがあります。それがこれです。</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text">-&gt;(&amp;_){_["","ev"+"al","実行したいコード"]}[&amp;:send]</code></pre></figure>

<p>これがどのように動くかは解説しません<sup id="fnref:5"><a href="#fn:5" class="footnote">5</a></sup>が、なんとこれで</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text">eval("実行したいコード")</code></pre></figure>

<p>と（ほぼ）同等の意味になっています。</p>

<p>これを使えば、ほとんどの部分は 2 文字単位でバラバラにできるのですが、:send のところだけはうまく切れません。ここで、Ruby 2.0 で導入された %I() というシンボルの配列のリテラルが活用できます。</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text">%I(  #{ ?s + ?e + ?n + ?d }  )[0]</code></pre></figure>

<p>これで :send が得られます。残念ながら %I( の 3 文字だけはこれ以上分割できませんが、それ以外は無事 2 文字単位バラバラが実現できました<sup id="fnref:6"><a href="#fn:6" class="footnote">6</a></sup>。%I() は必要性がよくわからない機能ですが、このようなプログラムのために生まれたのだと納得できました。</p>

<h3 id="shinh-賞-most-fragile">shinh 賞: “Most fragile”</h3>

<ul>
  <li>入賞者： NAKAMURA Usaku</li>
  <li>ソースコード： <a href="https://github.com/tric/trick2015/blob/master/unak/entry.rb">https://github.com/tric/trick2015/blob/master/unak/entry.rb</a></li>
  <li>勝者の声：<a href="http://www.garbagecollect.jp/~usa/d/201512b.html#id20151211_P1">http://www.garbagecollect.jp/~usa/d/201512b.html#id20151211_P1</a></li>
</ul>

<p>これも実行するとメッセージが出る系です。</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text">$ ruby entry.rb
hello trick</code></pre></figure>

<p>さて、このメッセージはどのように隠されているでしょうか。</p>

<h4 id="解説-6">解説</h4>

<p>各行の長さとしてメッセージが埋め込まれています。</p>

<p>例えば 1 行めの lines = Array.new は 18 文字です。18 に 62 を足すと 112 で、これは ‘p’ の ASCII コードです。2 行めは 23 文字で、62 を足すと ‘u’ の ASCII コードです。こんな風に各行を解釈していくと、</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text">puts"hello trick"</code></pre></figure>

<p>という Ruby コードが出現します。これを eval するという仕組み。</p>

<p>各行の文字数を変えるだけで動かなくなるので、「少し変えて動作を見てみる」という解析方法が使えず、なかなか巧妙でした。自然なインデントに仕上げようとしている意図を感じつつ、一部不自然なところが残っているところ（謎のセミコロンだけの 1 行など）がかえって好評になったようです。</p>

<h3 id="matz-賞-matz-lisp-award">matz 賞: “Matz Lisp award”</h3>

<ul>
  <li>入賞者： Kazuki Tsujimoto</li>
  <li>ソースコード： <a href="https://github.com/tric/trick2015/blob/master/k_tsj/entry.rb">https://github.com/tric/trick2015/blob/master/k_tsj/entry.rb</a></li>
  <li>勝者の声：<a href="http://www.callcc.net/diary/20151212.html">http://www.callcc.net/diary/20151212.html</a></li>
</ul>

<p>大きな「λ」が目を引きますが、注目すべきは最後の 5 行です。どう見ても Ruby ではなく Scheme な階乗計算プログラムが書かれています。実はこの 5 行は、ちゃんと階乗計算をする Ruby プログラムです。どういうことでしょうか。</p>

<h4 id="解説-7">解説</h4>

<p>Ruby としても Scheme としても実行できるプログラムです。いわゆる polyglot 。</p>

<p>前半の「λ」形をしたのコードブロックは、Ruby として解釈した時には Scheme インタプリタになっています。このインタプリタは、Scheme 風に書かれた最後の 5 行を実行します。</p>

<p>Scheme として解釈した時には、前半のラムダはコメントとしてすっかり無視され、最後の 5 行が Scheme プログラム本体として実行されます。つまり、Scheme 風に書かれたプログラムは本当に Scheme プログラムだったのでした。</p>

<p>このプログラムの審査についてはちょっと申し訳ないところがあります。インタプリタが作りこまれてるわりに、サンプルプログラムが階乗計算だけなのがつまらない、などと思っていたのですが、remarks にちゃんと metacircular evaluator の例が載ってました。他の審査員はどうか知りませんが、遠藤は完全にこれを見逃していました。すみません。<a href="https://github.com/k-tsj/ruby-scheme/blob/master/metacircular.rb">このプログラム</a>が Ruby インタプリタで評価できるのはなかなか圧巻ですね。</p>

<h3 id="mame-賞-most-timely">mame 賞: “Most timely”</h3>

<ul>
  <li>入賞者： Koichi Sasada (ko1)</li>
  <li>ソースコード： <a href="https://github.com/tric/trick2015/blob/master/ko1_1/entry.rb">https://github.com/tric/trick2015/blob/master/ko1_1/entry.rb</a></li>
  <li>勝者の声：<a href="http://www.atdot.net/~ko1/diary/201512.html#d13">http://www.atdot.net/~ko1/diary/201512.html#d13</a></li>
</ul>

<p>実行すると、なんかメッセージが出てきます。</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text">$ ruby entry.rb
"Nope. Already been there."</code></pre></figure>

<p>Back to the Future III のドクのセリフだそうです。</p>

<h4 id="解説-8">解説</h4>

<p>このプログラムのどこにこのようなメッセージが隠されているでしょう。といってもクイズにならないくらい、見るからに怪しい時刻の列がありますね。デコード方法が少し凝っています。まずこの時刻の列をソートし、UNIX 時間の整数に変換し、0xff でビット積を取るとメッセージの ASCII 文字列が出てくるという趣向です。Ruby が 2038 年問題をすでに解決していることを華麗にデモしているとも言えます。</p>

<p>これの良さを文章で語るのは難しいのですが、プログラム中にメッセージを隠す系の投稿はかなりあった中で、シンプルかつお洒落に感じました。</p>

<h3 id="eban-賞-best-document">eban 賞: “Best document”</h3>

<ul>
  <li>入賞者： yoshi-taka</li>
  <li>ソースコード： <a href="https://github.com/tric/trick2015/blob/master/yoshi-taka/entry.rb">https://github.com/tric/trick2015/blob/master/yoshi-taka/entry.rb</a></li>
</ul>

<p>Ruby プログラムとしても、markdown としても解釈できるテキストです。</p>

<p>Ruby プログラムとして実行しても何も起きません。驚くべきことに、エラーも出ないんです。プログラム全体にわたって、さまざまなテクニックを駆使して SyntaxError も NoMethodError も起きないよう、大変巧妙に書かれています。</p>

<h4 id="解説-9">解説</h4>

<p>例えば 3 行目を見てみると、</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text">What if $1 and under junk games take over the world.</code></pre></figure>

<p>は、$1 が正規表現の backref ですが、この時点で正規表現マッチングをしていないので nil と評価されます。すると nil and … という式になるので、後半部分は実行されません。さらにこの文全体は What if nil という文になるので、後置 if にとして解釈され、やはり What の部分が実行されません。</p>

<p>4 行目の最後は</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text">TRICK!!!</code></pre></figure>

<p>となっていますが、このびっくりマークは 2 つ以上必要です。というのは、1 つめは TRICK! というメソッド名の一部として解釈され、2 つめ以降は式の否定演算子となるからです。これによって、2 行先の Demo まで無効化しています。</p>

<p>10 行目の</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text">Criminal 1 :: There he is!</code></pre></figure>

<p>の :: もわからない人もいるかもしれません。これは定数参照の演算子で、Enumerator::Lazy などの :: と同じです。が、普通に実行すれば 1 はクラスでもモジュールでもないのでエラーになるのですが、これも巧妙に実行されないようになっています。（どこで無効化されているでしょうか？）</p>

<p>他にも Ruby の文法の闇に触れるヒントが多数仕込まれているので、ぜひ解読してみてください。</p>

<h3 id="leonid-賞-most-inconsistent">leonid 賞: “Most inconsistent”</h3>

<ul>
  <li>入賞者： Koichi Sasada (ko1)</li>
  <li>ソースコード： <a href="https://github.com/tric/trick2015/blob/master/ko1_2/entry.rb">https://github.com/tric/trick2015/blob/master/ko1_2/entry.rb</a></li>
  <li>勝者の声：<a href="http://www.atdot.net/~ko1/diary/201512.html#d13">http://www.atdot.net/~ko1/diary/201512.html#d13</a></li>
</ul>

<p>Ruby としては見慣れない文字列が並んでいるプログラムです。実行すると、以下のようになります。</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text">$ ruby entry.rb
"__\x10_________\xF0_____________"</code></pre></figure>

<p>26 文字なので、A から Z がだいたい _ になっているのですが、2 箇所ほど文字化けが起きています。どういう意味でしょうか？</p>

<h4 id="解説-10">解説</h4>

<p>このプログラムを理解するには、Ruby の少しマイナーな言語機能を知っている必要があります。</p>

<p>?X が「文字リテラル」であることはご存知の人も多いでしょう。Ruby において文字は 1 文字の文字列なので、つまり “X” と同じ意味です。しかしこれにエスケープシーケンスが使えることは、あまり知られていないかも知れません。たとえば ?\n で “\n” と同じ意味になります。</p>

<p>それから、存在しないエスケープシーケンスを使ったときは、エスケープ記号が無視されるという挙動を知っておく必要があります。”\A” と書いても、そういうエスケープシーケンスはないので、”A” と書いたのと同じになります。<sup id="fnref:7"><a href="#fn:7" class="footnote">7</a></sup></p>

<p>例として、?\A-p を解釈してみます。?\A の部分は、”\A” と同じ意味なので、”A” という文字列になります。p はデバッグ出力に使う Kernel#p メソッドですが、無引数で呼び出すと nil を返します。よってこの式は、”A” - nil を計算することになります。String#- というメソッドはないですが、プログラムの末尾で Object#- を定義しています。このメソッドは単に self を返すので、この式は “A” を返すことになります。このように得られた文字列を A から Z まで結合し、最後に tr(“A-Z”, “_”) を実行するので、基本的にはアンダースコアばかりの文字列になります。</p>

<p>ここまでが前提知識。このプログラムの本題は、一部だけアンダースコアでなくなるのはなぜか？ということです。あっさり答えを言ってしまうと、”\C-p” と “\M-p” が仲間はずれです。これらは全体として、コントロール文字とメタ文字を表すエスケープシーケンスになります。</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text">$ ruby -e 'p "\C-p"; p "\M-p"'
"\u0010"
"\xF0"</code></pre></figure>

<p>この機能は Emacs Lisp 由来という噂ですが、正直、現代でどの程度使われている機能なのかわかりません。そんな機能に脚光を浴びせてみるのも TRICK の一興です。</p>

<h3 id="eto-賞-most-illusionistic">eto 賞: “Most illusionistic”</h3>

<ul>
  <li>入賞者： Don Yang</li>
  <li>ソースコード： <a href="https://github.com/tric/trick2015/blob/master/omoikane/entry.rb">https://github.com/tric/trick2015/blob/master/omoikane/entry.rb</a></li>
</ul>

<p>「シェルゲーム」のアニメーションを表示するプログラムです。シェルゲームとは、3 つのコップの中に 1 つだけボールを入れて、コップを何度も入れ替え、「さあボールはどこでしょう？」とする遊びです。</p>

<p>言葉の説明ではわからないかもしれませんが、実行してみればすぐ分かります。以下のように実行するといいですよ。</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text">$ ruby entry.rb | tee result.rb
$ ruby result.rb</code></pre></figure>

<h4 id="解説-11">解説</h4>

<p>技術的に特筆するところは、正直あまりありません。Ruby でアニメーション表示をするプログラムを普通に書いて、zlib 圧縮し、さらに BASE64 エンコードしてあるだけです。そのため、これを入選させるかどうかは審査員の間で少し意見が割れました。しかし、TRICK は必ずしも技術力を競うコンテストではないということで、アイデアを大きく評価して入選となりました。</p>

<p>ちなみに作者の Don Yang は IOCCC の常連入賞者で、その道では大変有名な <a href="http://www.ioccc.org/2011/akari/akari.c">akari.c</a> や <a href="http://www.ioccc.org/2013/misaka/misaka.c">misaka.c</a> の作者さんです。</p>

<h3 id="景品">景品</h3>

<p>作品は以上です。景品は、</p>

<ul>
  <li>受賞者全員: 「変態」の称号</li>
  <li>上位 5 作品: Ruby 公式リポジトリにサンプルコードとしてコミットされる (Ruby 2.3 としてリリース済み）</li>
</ul>

<p>ということになりました。</p>

<h3 id="全体評">全体評</h3>

<p>前回以上におもしろい作品が一杯で、選定には審査員一同、苦労しました。前回と比べると、以下の点がよかったと思います。</p>

<ul>
  <li>前回は審査員自らが投稿した作品ばかり入賞してしまったのですが、今回は 1 作品しか入賞しませんでした。投稿しなかったわけではないので、投稿作のレベルが上がってきたためと思います。</li>
  <li>前回は日本以外からの投稿がなかったのですが、今回は海外からの投稿もあってよかったです。</li>
  <li>Rubykaigi での発表会場が巨大化しました。前回はサブセッションの位置づけで会場が立ち見であふれたためかと思います。ただ、正直興味のないだろう方まで見させられることになったのは良し悪しだったかもしれないですね。もっと少人数でカルト的に開催するのもありかもしれない。</li>
</ul>

<p>なお、この文章は一審査員である筆者 (遠藤) の独断と偏見で書かれているので、他の審査員の記録にもリンクをはっときます。</p>

<ul>
  <li><a href="http://shinh.hatenablog.com/entry/2015/12/12/141432">http://shinh.hatenablog.com/entry/2015/12/12/141432</a></li>
  <li><a href="http://jarp.does.notwork.org/diary/201512b.html#201512111">http://jarp.does.notwork.org/diary/201512b.html#201512111</a></li>
</ul>

<h3 id="まとめ">まとめ</h3>

<p>TRICK 2015 の作品紹介と審査員講評でした。応募いただいたみなさんと、最高の発表の場を提供してくださった RubyKaigi スタッフのみなさん、あと他の審査員のみなさんに感謝します。次回開催は未定ですが、もしあればまた会いましょう。</p>

<h2 id="筆者について">筆者について</h2>

<p>遠藤侑介。CRuby コミッタ。超絶技巧プログラミング提唱者、IOCCC 2012,2013,2014,2015 入賞。Twitter: <a href="https://twitter.com/mametter">@mametter</a></p>

<hr />

<div class="footnotes">
  <ol>
    <li id="fn:1">
      <p>n が偶数だったら 2 で割り、基数だったら 3 をかけて 1 を足す操作を繰り返して得られる数列。&nbsp;<a href="#fnref:1" class="reversefootnote">&#8617;</a></p>
    </li>
    <li id="fn:2">
      <p>もちろん理論上は NP 完全の問題は相互に還元可能なわけですが、わざわざ数独問題に還元させる人はいないと思いますので。&nbsp;<a href="#fnref:2" class="reversefootnote">&#8617;</a></p>
    </li>
    <li id="fn:3">
      <p>もちろん、! を再定義するみたいなチートはなしで。&nbsp;<a href="#fnref:3" class="reversefootnote">&#8617;</a></p>
    </li>
    <li id="fn:4">
      <p>ちなみに、式は「<a href="https://ja.wikipedia.org/wiki/%E9%80%A3%E8%A8%80%E6%A8%99%E6%BA%96%E5%BD%A2">連言標準形</a>」という形式に従う必要があります。&nbsp;<a href="#fnref:4" class="reversefootnote">&#8617;</a></p>
    </li>
    <li id="fn:5">
      <p>興味のある方は拙著「あなたの知らない超絶技巧プログラミングの世界」の 174 ページから 175 ページをお読みください :-) 読者プレゼントのページも参照のこと。&nbsp;<a href="#fnref:5" class="reversefootnote">&#8617;</a></p>
    </li>
    <li id="fn:6">
      <p>完全な 2 文字分割は今のところ未解決問題です。&nbsp;<a href="#fnref:6" class="reversefootnote">&#8617;</a></p>
    </li>
    <li id="fn:7">
      <p>なお、将来的に \A というエスケープシーケンスが Ruby に導入された場合、このプログラムは予期せぬ挙動になる可能性があるので、普通のユーザは使うべきではありません。&nbsp;<a href="#fnref:7" class="reversefootnote">&#8617;</a></p>
    </li>
  </ol>
</div>

                    </div>
                </div>
            </div>
        </div>
    </div>
  </body>
</html>
